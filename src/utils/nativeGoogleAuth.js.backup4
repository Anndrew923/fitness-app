import { GoogleAuth } from '@belongnet/capacitor-google-auth';
import { auth, db } from '../firebase';
import { doc, setDoc, getDoc } from 'firebase/firestore';

class NativeGoogleAuth {
  // åˆå§‹åŒ– - å®Œç¾ç‰ˆæœ¬
  static async initialize() {
    try {
      console.log('ğŸ” åˆå§‹åŒ– Capacitor Google Auth...');
      
      // æª¢æ¸¬ç’°å¢ƒ
      const isWebView = window.navigator.userAgent.includes('wv') || 
                       window.navigator.userAgent.includes('WebView');
      const isCapacitor = window.Capacitor !== undefined;
      
      console.log('ğŸ” ç’°å¢ƒæª¢æ¸¬:', { isWebView, isCapacitor });
      
      // é—œéµä¿®æ­£ï¼šä¸å‚³ clientIdï¼Œè®“å¤–æ›è‡ªå‹•è®€å– strings.xml
      await GoogleAuth.initialize({
        scopes: ['profile', 'email'],
        grantOfflineAccess: true,
        // ç§»é™¤ clientId åƒæ•¸ï¼Œè®“å¤–æ›å¾ strings.xml è®€å– server_client_id
      });
      
      console.log('âœ… Google Auth åˆå§‹åŒ–æˆåŠŸ');
      return true;
    } catch (error) {
      console.error('âŒ Google Auth åˆå§‹åŒ–å¤±æ•—:', error);
      // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œå…è¨±æ‡‰ç”¨ç¹¼çºŒé‹è¡Œ
      return false;
    }
  }

  // åŸ·è¡Œ Google ç™»å…¥ - å®Œç¾ç‰ˆæœ¬
  static async signIn() {
    try {
      console.log('ğŸ”„ é–‹å§‹ Google ç™»å…¥...');
      
      // æ·»åŠ è¶…æ™‚è™•ç†
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('ç™»å…¥è¶…æ™‚')), 30000);
      });
      
      const signInPromise = GoogleAuth.signIn();
      const result = await Promise.race([signInPromise, timeoutPromise]);
      
      console.log('âœ… Google ç™»å…¥æˆåŠŸ:', result);
      
      // é©—è­‰çµæœå®Œæ•´æ€§
      if (!result || !result.id || !result.email) {
        throw new Error('ç™»å…¥çµæœä¸å®Œæ•´');
      }
      
      const firebaseUser = await this.convertToFirebaseUser(result);
      return firebaseUser;
      
    } catch (error) {
      console.error('âŒ Google ç™»å…¥å¤±æ•—:', error);
      
      // è©³ç´°éŒ¯èª¤åˆ†æ
      if (error.message.includes('Something went wrong')) {
        console.error('ğŸ” å¯èƒ½åŸå› : Client ID é…ç½®ä¸æ­£ç¢º');
        console.error('ğŸ” æª¢æŸ¥ strings.xml ä¸­çš„ server_client_id');
        console.error('ğŸ” æª¢æŸ¥ capacitor.config.json ä¸­çš„ serverClientId');
      }
      
      // é‡è©¦æ©Ÿåˆ¶
      if (error.message.includes('Something went wrong') || 
          error.message.includes('androidBridge') ||
          error.message.includes('iu:')) {
        console.log('ğŸ”„ æª¢æ¸¬åˆ°é€šä¿¡éŒ¯èª¤ï¼Œå˜—è©¦é‡è©¦...');
        return await this.retrySignIn();
      }
      
      throw error;
    }
  }

  // é‡è©¦æ©Ÿåˆ¶ - å¢å¼·ç‰ˆæœ¬
  static async retrySignIn(retryCount = 0) {
    const maxRetries = 3;
    
    if (retryCount >= maxRetries) {
      throw new Error('é‡è©¦æ¬¡æ•¸å·²é”ä¸Šé™');
    }
    
    try {
      // ç­‰å¾…å¾Œé‡è©¦
      await new Promise(resolve => 
        setTimeout(resolve, 1000 * (retryCount + 1))
      );
      
      console.log(`ğŸ”„ ç¬¬ ${retryCount + 1} æ¬¡é‡è©¦...`);
      const result = await GoogleAuth.signIn();
      
      if (!result || !result.id || !result.email) {
        throw new Error('ç™»å…¥çµæœä¸å®Œæ•´');
      }
      
      const firebaseUser = await this.convertToFirebaseUser(result);
      return firebaseUser;
      
    } catch (error) {
      console.error(`âŒ ç¬¬ ${retryCount + 1} æ¬¡é‡è©¦å¤±æ•—:`, error);
      
      if (retryCount < maxRetries - 1) {
        return await this.retrySignIn(retryCount + 1);
      }
      
      throw error;
    }
  }

  // è½‰æ› Google çµæœç‚º Firebase ç”¨æˆ¶æ ¼å¼
  static async convertToFirebaseUser(googleResult) {
    try {
      console.log('ğŸ”„ è½‰æ› Google çµæœç‚º Firebase ç”¨æˆ¶...');
      
      const userData = {
        uid: googleResult.id,
        email: googleResult.email,
        displayName: googleResult.name,
        photoURL: googleResult.imageUrl,
        emailVerified: true,
        providerData: [{
          providerId: 'google.com',
          uid: googleResult.id,
          email: googleResult.email,
          displayName: googleResult.name,
          photoURL: googleResult.imageUrl,
        }],
      };
      
      console.log('âœ… Firebase ç”¨æˆ¶è³‡æ–™:', userData);
      
      // ä¿å­˜åˆ° Firestore
      await this.saveUserToFirestore(userData);
      
      return userData;
    } catch (error) {
      console.error('âŒ è½‰æ› Firebase ç”¨æˆ¶å¤±æ•—:', error);
      throw error;
    }
  }

  // ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ° Firestore
  static async saveUserToFirestore(userData) {
    try {
      console.log('ğŸ”„ ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ° Firestore...');
      
      const userRef = doc(db, 'users', userData.uid);
      const userSnap = await getDoc(userRef);
      
      if (!userSnap.exists()) {
        // æ–°ç”¨æˆ¶
        const initialUserData = {
          email: userData.email,
          userId: userData.uid,
          nickname: userData.displayName || userData.email.split('@')[0],
          avatarUrl: userData.photoURL || '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          gender: '',
          height: 0,
          weight: 0,
          age: 0,
          scores: {
            strength: 0,
            explosivePower: 0,
            cardio: 0,
            muscleMass: 0,
            bodyFat: 0,
          },
          history: [],
          testInputs: {},
          friends: [],
          friendRequests: [],
          blockedUsers: [],
          ladderScore: 0,
          ladderRank: 0,
          ladderHistory: [],
          isGuest: false,
          lastActive: new Date().toISOString(),
        };
        
        await setDoc(userRef, initialUserData);
        console.log('âœ… æ–°ç”¨æˆ¶è³‡æ–™å·²å‰µå»º');
      } else {
        // ç¾æœ‰ç”¨æˆ¶
        await setDoc(userRef, {
          lastActive: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        }, { merge: true });
        console.log('âœ… ç¾æœ‰ç”¨æˆ¶è³‡æ–™å·²æ›´æ–°');
      }
    } catch (error) {
      console.error('âŒ ä¿å­˜ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
      throw error;
    }
  }

  // ç™»å‡º
  static async signOut() {
    try {
      console.log('ğŸ”„ é–‹å§‹ Google ç™»å‡º...');
      await GoogleAuth.signOut();
      console.log('âœ… Google ç™»å‡ºæˆåŠŸ');
    } catch (error) {
      console.error('âŒ Google ç™»å‡ºå¤±æ•—:', error);
      throw error;
    }
  }

  // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
  static async checkAuthState() {
    try {
      const result = await GoogleAuth.refresh();
      return result;
    } catch (error) {
      console.log('ç”¨æˆ¶æœªç™»å…¥æˆ– token å·²éæœŸ');
      return null;
    }
  }
}

export default NativeGoogleAuth;