import { auth, db } from '../firebase';
import {
  signInWithRedirect,
  getRedirectResult,
  GoogleAuthProvider,
} from 'firebase/auth';
import { doc, setDoc, getDoc } from 'firebase/firestore';

class NativeGoogleAuth {
  // åˆå§‹åŒ– - ä½¿ç”¨ Firebase Redirect
  static async initialize() {
    try {
      console.log('ğŸ” åˆå§‹åŒ– Firebase Google Auth (Redirect æ¨¡å¼)...');

      // æª¢æŸ¥æ˜¯å¦æœ‰é‡å®šå‘çµæœ
      const redirectResult = await getRedirectResult(auth);

      if (redirectResult && redirectResult.user) {
        console.log('âœ… æª¢æ¸¬åˆ°é‡å®šå‘ç™»å…¥çµæœ');
        await this.convertToFirebaseUser(redirectResult.user);
      }

      console.log('âœ… Google Auth (Redirect) åˆå§‹åŒ–æˆåŠŸ');
      return true;
    } catch (error) {
      console.error('âŒ Google Auth åˆå§‹åŒ–å¤±æ•—:', error);
      // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œå…è¨±æ‡‰ç”¨ç¹¼çºŒé‹è¡Œ
      return false;
    }
  }

  // åŸ·è¡Œ Google ç™»å…¥ - ä½¿ç”¨ Redirect
  static async signIn() {
    try {
      console.log('ğŸ”„ é–‹å§‹ Google ç™»å…¥ (Redirect æ¨¡å¼)...');

      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({
        prompt: 'select_account',
      });

      // è§¸ç™¼é‡å®šå‘
      await signInWithRedirect(auth, provider);

      // é€™è¡Œç¨‹å¼ç¢¼ä¸æœƒåŸ·è¡Œï¼Œå› ç‚ºé é¢æœƒé‡å®šå‘
      console.log('âœ… Redirect å·²å•Ÿå‹•');
    } catch (error) {
      console.error('âŒ Google ç™»å…¥å¤±æ•—:', error);
      throw error;
    }
  }

  // è™•ç†é‡å®šå‘å›ä¾†çš„çµæœ
  static async handleRedirectResult() {
    try {
      console.log('ğŸ”„ è™•ç†é‡å®šå‘çµæœ...');

      const result = await getRedirectResult(auth);

      if (result && result.user) {
        console.log('âœ… é‡å®šå‘ç™»å…¥æˆåŠŸ:', result.user.email);

        const firebaseUser = await this.convertToFirebaseUser(result.user);
        return firebaseUser;
      }

      return null;
    } catch (error) {
      console.error('âŒ è™•ç†é‡å®šå‘çµæœå¤±æ•—:', error);
      throw error;
    }
  }

  // å°‡ Firebase User è½‰æ›ç‚ºæˆ‘å€‘çš„æ ¼å¼
  static async convertToFirebaseUser(firebaseUser) {
    try {
      console.log('ğŸ”„ è½‰æ› Firebase ç”¨æˆ¶...');

      const userData = {
        uid: firebaseUser.uid,
        email: firebaseUser.email,
        displayName: firebaseUser.displayName,
        photoURL: firebaseUser.photoURL,
        emailVerified: firebaseUser.emailVerified,
        providerData: firebaseUser.providerData,
      };

      console.log('âœ… Firebase ç”¨æˆ¶è³‡æ–™:', userData);

      // ä¿å­˜åˆ° Firestore
      await this.saveUserToFirestore(userData);

      return userData;
    } catch (error) {
      console.error('âŒ è½‰æ› Firebase ç”¨æˆ¶å¤±æ•—:', error);
      throw error;
    }
  }

  // ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ° Firestore
  static async saveUserToFirestore(userData) {
    try {
      console.log('ğŸ”„ ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ° Firestore...');

      const userRef = doc(db, 'users', userData.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        // æ–°ç”¨æˆ¶
        const initialUserData = {
          email: userData.email,
          userId: userData.uid,
          nickname: userData.displayName || userData.email.split('@')[0],
          avatarUrl: userData.photoURL || '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          gender: '',
          height: 0,
          weight: 0,
          age: 0,
          scores: {
            strength: 0,
            explosivePower: 0,
            cardio: 0,
            muscleMass: 0,
            bodyFat: 0,
          },
          history: [],
          testInputs: {},
          friends: [],
          friendRequests: [],
          blockedUsers: [],
          ladderScore: 0,
          ladderRank: 0,
          ladderHistory: [],
          isGuest: false,
          lastActive: new Date().toISOString(),
        };

        await setDoc(userRef, initialUserData);
        console.log('âœ… æ–°ç”¨æˆ¶è³‡æ–™å·²å‰µå»º');
      } else {
        // ç¾æœ‰ç”¨æˆ¶
        await setDoc(
          userRef,
          {
            lastActive: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          },
          { merge: true }
        );
        console.log('âœ… ç¾æœ‰ç”¨æˆ¶è³‡æ–™å·²æ›´æ–°');
      }
    } catch (error) {
      console.error('âŒ ä¿å­˜ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
      throw error;
    }
  }

  // ç™»å‡º
  static async signOut() {
    try {
      console.log('ğŸ”„ é–‹å§‹ Google ç™»å‡º...');
      const { signOut } = await import('firebase/auth');
      await signOut(auth);
      console.log('âœ… Google ç™»å‡ºæˆåŠŸ');
    } catch (error) {
      console.error('âŒ Google ç™»å‡ºå¤±æ•—:', error);
      throw error;
    }
  }

  // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
  static async checkAuthState() {
    try {
      const { onAuthStateChanged } = await import('firebase/auth');
      return new Promise(resolve => {
        const unsubscribe = onAuthStateChanged(auth, user => {
          unsubscribe();
          resolve(user ? { accessToken: user.accessToken } : null);
        });
      });
    } catch (error) {
      console.log('ç”¨æˆ¶æœªç™»å…¥æˆ– token å·²éæœŸ');
      return null;
    }
  }
}

export default NativeGoogleAuth;
