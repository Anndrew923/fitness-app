// Vitest emulator unit tests will import this file for rules source
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }
    function onlyMutate(keys) {
      // 僅允許改動指定欄位（適用 update）
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(keys);
    }

    // users：登入者可讀（顯示暱稱/頭像/排行榜等），僅本人可寫
    // ✅ 新增：允許登入用戶更新其他用戶的點讚相關字段
    match /users/{userId} {
      allow read: if signedIn();

      // 僅本人可創建/刪除自己的文檔
      allow create, delete: if isOwner(userId)
        && request.resource.data.userId == userId
        && !('isAdmin' in request.resource.data);

      // 本人可更新自己的文檔（原有規則）
      allow update: if isOwner(userId)
        && request.resource.data.userId == userId
        && !('isAdmin' in request.resource.data);

      // ✅ 新增：允許登入用戶更新其他用戶的點讚相關字段
      allow update: if signedIn()
        && onlyMutate(['ladderLikes', 'ladderLikeCount'])
        && request.resource.data.userId == resource.data.userId; // 確保不能修改 userId
    }

    // friendInvitations：僅參與雙方可讀；from 可建；參與雙方可改狀態
    match /friendInvitations/{inviteId} {
      allow read: if signedIn() && (
        resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid
      );
      allow create: if signedIn()
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.toUserId is string
        && request.resource.data.toUserId != request.auth.uid;
      // 僅修改狀態/時間等安全欄位
      allow update: if signedIn()
        && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid)
        && onlyMutate(['status','updatedAt']);
      allow delete: if false;
    }

    // communityPosts：登入者可讀；作者可改文章；他人僅能改 likes/comments
    match /communityPosts/{postId} {
      allow read: if signedIn();
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid;
      // 作者可改內容/隱私；其他登入者僅能改 likes/comments
      allow update: if signedIn() && (
        (resource.data.userId == request.auth.uid) ||
        (onlyMutate(['likes','comments']))
      );
      allow delete: if signedIn() && resource.data.userId == request.auth.uid;
    }

    // assessments：僅本人可 CRUD
    match /assessments/{assessmentId} {
      allow read, update, delete: if signedIn() && resource.data.userId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
    }

    // ladderRankings：登入者可讀；本人可 CRUD 自己的排名紀錄
    match /ladderRankings/{rankingId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }

    // history：僅本人可 CRUD
    match /history/{historyId} {
      allow read, update, delete: if signedIn() && resource.data.userId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
    }

    // userSettings：docId 必須是 uid，僅本人可 CRUD
    match /userSettings/{settingId} {
      allow read, create, update, delete: if isOwner(settingId);
    }

    // systemConfig：僅讀（無人可寫）
    match /systemConfig/{configId} {
      allow read: if signedIn();
      allow write: if false;
    }
  }
}
