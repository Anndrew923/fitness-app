import{b as U,u as L,a as g,_ as R,r as E,s as I,l as W,d as A,j as e,B as _}from"./index-yjPVR0rS.js";import{d as O,r as i}from"./react-vendor-BToktFYo.js";import{D as z,l as F,E as N}from"./firebase-D0136ThQ.js";import{P as T}from"./PrivacyPolicyModal-DMvIzjqj.js";import{L as V}from"./LanguageSwitcher-D26e-rSy.js";import"./charts-BNGpwEcn.js";function H(){const r=O(),{clearUserData:u}=U(),[v,d]=i.useState(!1),[h,x]=i.useState(!1),[y,a]=i.useState(""),{t,i18n:f}=L(),j=f.language&&f.language.toLowerCase().startsWith("zh"),m=(o,c,l)=>{const s=t(o);return s===o?j?c:l:s},p=i.useMemo(()=>!!g.currentUser,[]),w=i.useCallback(()=>{d(!0)},[]),b=i.useCallback(()=>{localStorage.removeItem("privacyAcceptedV1"),d(!0),a(t("settings.msgResetConsent"))},[]),C=i.useCallback(async()=>{try{if("serviceWorker"in navigator){const o=await navigator.serviceWorker.getRegistration();if(o){await o.update(),a(t("settings.msgCheckedUpdate"));return}}a(t("settings.msgNoSW"))}catch(o){console.error("檢查更新失敗:",o),a(t("settings.msgCheckUpdateFail"))}},[]),S=i.useCallback(()=>{try{const o=localStorage.getItem("userData"),c=new Blob([o||"{}"],{type:"application/json"}),l=URL.createObjectURL(c),s=document.createElement("a");s.href=l,s.download="userData.json",s.click(),URL.revokeObjectURL(l)}catch(o){console.error("導出數據失敗:",o),a(t("settings.msgExportFail"))}},[]),k=i.useCallback(()=>{try{localStorage.removeItem("userData"),localStorage.removeItem("lastSavedUserData"),localStorage.removeItem("ladderSubmissionState"),a(t("settings.msgClearedLocal"))}catch(o){console.error("清除數據失敗:",o),a(t("settings.msgClearFail"))}},[]),P=i.useCallback(async()=>{var l;if(!p){a(t("settings.msgPleaseLogin")),r("/login");return}if(!window.confirm(t("settings.deleteConfirm")))return;const c=window.prompt(t("settings.passwordPrompt"));if(!c||c.trim()===""){a("");return}try{const s=(l=g.currentUser)==null?void 0:l.email;if(!s)throw new Error(t("settings.msgNeedRelogin"));const{signInWithEmailAndPassword:n}=await R(async()=>{const{signInWithEmailAndPassword:B}=await import("./firebase-D0136ThQ.js").then(D=>D.K);return{signInWithEmailAndPassword:B}},[]);await n(g,s,c)}catch(s){console.error("密碼驗證失敗:",s),a(t("settings.msgPasswordVerifyFail")),r("/login");return}x(!0),a(t("settings.msgDeleting"));try{const s=g.currentUser.uid;try{const n=E(I,`avatars/${s}/avatar.jpg`);await W(n)}catch(n){console.warn("刪除頭像失敗:",n)}try{await z(F(A,"users",s))}catch(n){console.warn("刪除用戶文檔失敗:",n)}try{await N(g.currentUser)}catch(n){if((n==null?void 0:n.code)==="auth/requires-recent-login"){a(t("settings.msgNeedReloginToDelete")),r("/login");return}throw n}u(),a(t("settings.msgDeleted")),r("/")}catch(s){console.error("刪除帳號失敗:",s),a(t("settings.msgDeleteFail"))}finally{x(!1)}},[p,r,u]);return e.jsxs("div",{style:{padding:"16px",paddingBottom:"96px"},children:[e.jsx("h1",{style:{fontSize:"20px",fontWeight:700,marginBottom:"12px"},children:t("settings.title")}),y&&e.jsx("div",{style:{marginBottom:"12px",color:"#2d6a4f"},children:y}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.privacySection")}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:w,children:t("settings.viewPrivacy")}),e.jsx("button",{onClick:b,children:t("settings.resetConsent")}),e.jsx("button",{onClick:S,children:t("settings.exportLocal")}),e.jsx("button",{onClick:k,children:t("settings.clearLocal")})]})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.languageSection")}),e.jsx(V,{})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.pwaSection")}),e.jsx("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:e.jsx("button",{onClick:C,children:t("settings.checkUpdate")})})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.dataSection")}),e.jsxs("div",{style:{color:"#555",marginBottom:"8px"},children:[t("settings.loginStatus"),"：",t(p?"common.loggedIn":"common.loggedOut")]}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>r("/privacy-policy"),children:t("settings.toPrivacyPage")}),e.jsx("button",{onClick:()=>r("/terms"),children:m("navigation.terms","使用條款","Terms")}),e.jsx("button",{onClick:()=>r("/about"),children:m("navigation.about","關於","About")}),e.jsx("button",{onClick:()=>r("/disclaimer"),children:m("navigation.disclaimer","免責聲明","Disclaimer")}),e.jsx("button",{onClick:()=>r("/contact"),children:m("navigation.contact","聯絡我們","Contact")}),p&&e.jsx("button",{onClick:P,disabled:h,children:t(h?"common.deleting":"settings.deleteAccountDanger")})]})]}),e.jsx(T,{isOpen:v,onClose:()=>d(!1),onAccept:()=>{localStorage.setItem("privacyAcceptedV1","true"),d(!1),a("")}}),e.jsx(_,{})]})}export{H as default};
