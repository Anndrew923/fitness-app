import{u as Xe,a as Ee,b as v,d as b,m as E,j as e}from"./index-CzQucI3b.js";import{d as Ye,r as g,R as Ze}from"./react-vendor-BToktFYo.js";import{t as z,q as M,v as es,x as ss,y as D,m as ne,l as $,s as Ne,D as Te,w as q,H as Me,z as ie,I as ts,J as ns}from"./firebase-D0136ThQ.js";import{P as C}from"./charts-BNGpwEcn.js";const os=()=>{var we,be,Ue,ke,Ce,Se,Re,Pe,Fe,Ie,$e,qe,Ae;const N=Ye(),{userData:t,setUserData:J}=Xe(),{t:n,i18n:re}=Ee(),[P,Q]=g.useState("feed"),[F,S]=g.useState([]),[G,j]=g.useState(!0),[O,h]=g.useState(""),[_,I]=g.useState(""),[H,V]=g.useState(""),[X,ae]=g.useState(!1),[i,Y]=g.useState([]),[L,ce]=g.useState([]),[A,k]=g.useState(""),[Z,ee]=g.useState([]),[se,oe]=g.useState(new Set),[fe,je]=g.useState(new Set),te=g.useRef(new Map),W=g.useRef(!1),le=g.useRef(!1),me=g.useRef(!1),de=g.useRef(new Map),ue=g.useRef(0),ye=300*1e3,ge=g.useRef(new Map),ve=g.useRef(new Map),T=g.useMemo(()=>{var s;return(s=v.currentUser)==null?void 0:s.uid},[(we=v.currentUser)==null?void 0:we.uid]);g.useMemo(()=>{const s=(t==null?void 0:t.friends)||[];return[T,...s].filter(Boolean)},[T,t==null?void 0:t.friends]),g.useMemo(()=>A.trim()?F.filter(s=>s.content.toLowerCase().includes(A.toLowerCase())||s.userNickname.toLowerCase().includes(A.toLowerCase())):F,[F,A]);const he=g.useCallback(async()=>{if(!v.currentUser||!t){console.log("ğŸš« ç”¨æˆ¶æœªç™»å…¥æˆ–è³‡æ–™æœªè¼‰å…¥ï¼Œè·³éè¼‰å…¥å‹•æ…‹");return}const s=Date.now(),r=de.current.get("posts");if(r&&s-r.timestamp<ye){console.log("ğŸ“¦ ä½¿ç”¨å¿«å–å‹•æ…‹æ•¸æ“š"),S(r.data);return}if(le.current&&s-ue.current<ye){console.log("â° å‹•æ…‹æ•¸æ“šä»åœ¨æœ‰æ•ˆæœŸé™å…§ï¼Œè·³éé‡æ–°è¼‰å…¥");return}console.log("ğŸ”„ é–‹å§‹è¼‰å…¥å‹•æ…‹..."),j(!0),h("");try{const c=(t==null?void 0:t.friends)||[],u=[T,...c].filter(Boolean);console.log(`ğŸ” ç•¶å‰ç”¨æˆ¶ID: ${T}`),console.log(`ğŸ” å¥½å‹åˆ—è¡¨: ${c.join(", ")}`),console.log(`ğŸ” å…è¨±æŸ¥çœ‹çš„ç”¨æˆ¶: ${u.join(", ")}`),console.log(`ğŸ” ç¸½å…± ${u.length} å€‹ç”¨æˆ¶çš„å‹•æ…‹éœ€è¦è¼‰å…¥`);const o=z(M(b,"communityPosts"),es("timestamp","desc"),ss(50)),a=await D(o),m=[],x=[];a.forEach(f=>{const p=f.data(),U={id:f.id,userId:p.userId,userNickname:p.userNickname,userAvatarUrl:p.userAvatarUrl,content:p.content,timestamp:p.timestamp,likes:p.likes||[],commentCount:(p.comments||[]).length,comments:[],type:p.type||"status",targetUserId:p.targetUserId};p.targetUserId?x.push(U):u.includes(p.userId)&&m.push(U)});const l=Array.from(new Set(x.map(f=>f.targetUserId).filter(Boolean))).filter(f=>!ge.current.has(f));l.length>0&&await Promise.all(l.map(async f=>{var p;try{const U=await ne($(b,"users",f)),R=U.exists()?U.data():null,xe=Array.isArray(R==null?void 0:R.friends)?R.friends:[];ge.current.set(f,xe),ve.current.set(f,{nickname:(R==null?void 0:R.nickname)||((p=R==null?void 0:R.email)==null?void 0:p.split("@")[0])||n("community.fallback.user"),avatarUrl:(R==null?void 0:R.avatarUrl)||""})}catch(U){console.warn("è®€å–ç›®æ¨™ç”¨æˆ¶å¥½å‹å¤±æ•—:",f,U),ge.current.set(f,[]),ve.current.set(f,{nickname:n("community.fallback.user"),avatarUrl:""})}}));const d=x.filter(f=>T===f.userId||T===f.targetUserId?!0:(ge.current.get(f.targetUserId)||[]).includes(T)).map(f=>{var p;return{...f,targetUserNickname:((p=ve.current.get(f.targetUserId))==null?void 0:p.nickname)||""}}),w=[...m,...d];w.sort((f,p)=>{const U=f.timestamp?new Date(f.timestamp):new Date(f.date);return(p.timestamp?new Date(p.timestamp):new Date(p.date))-U});const y=w.slice(0,30);console.log(`ğŸ“Š è¼‰å…¥å®Œæˆï¼šå…± ${y.length} æ¢å‹•æ…‹`),S(y),le.current=!0,ue.current=s,de.current.set("posts",{data:y,timestamp:s})}catch(c){console.error("è¼‰å…¥å‹•æ…‹å¤±æ•—:",c),h(n("community.messages.loadFeedError"))}finally{j(!1)}},[t==null?void 0:t.friends,ye]),We=async()=>{var s;if(!H.trim()){h(n("community.messages.emptyPost"));return}if(!v.currentUser){h(n("community.messages.needLogin"));return}try{ae(!0),console.log("ğŸ“ æº–å‚™ç™¼å¸ƒå‹•æ…‹...");const r={userId:v.currentUser.uid,userNickname:(t==null?void 0:t.nickname)||((s=t==null?void 0:t.email)==null?void 0:s.split("@")[0])||n("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(t==null?void 0:t.avatarUrl)||"",content:H.trim(),type:"status",likes:[],comments:[],timestamp:new Date().toISOString(),privacy:"friends"},c=await Me(M(b,"communityPosts"),r);E.logWrite("addDoc","communityPosts",c.id),console.log("âœ… å‹•æ…‹ç™¼å¸ƒæˆåŠŸï¼ŒID:",c.id);const u={id:c.id,...r};console.log("ğŸ”„ æ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œæ·»åŠ æ–°å‹•æ…‹:",u.id),S(o=>{const a=[u,...o];return console.log(`ğŸ“Š æ›´æ–°å¾Œå‹•æ…‹ç¸½æ•¸: ${a.length}`),a}),V(""),I(n("community.messages.publishSuccess")),setTimeout(()=>I(""),3e3)}catch(r){console.error("âŒ ç™¼å¸ƒå‹•æ…‹å¤±æ•—:",r),h(`${n("community.messages.publishFail")}: ${r.message}`)}finally{ae(!1)}},Be=g.useCallback(async(s,r)=>{if(!v.currentUser){h(n("community.messages.needLogin"));return}if(se.has(s)){console.log("ğŸ”„ é»è®šæ“ä½œé€²è¡Œä¸­ï¼Œè«‹ç¨å€™...");return}const c=r.includes(T),u=c?r.filter(o=>o!==T):[...r,T];S(o=>o.map(a=>a.id===s?{...a,likes:u}:a)),oe(o=>new Set(o).add(s));try{const o=$(b,"communityPosts",s);await Ne(o,{likes:u},{merge:!0}),E.logWrite("setDoc","communityPosts",s,{likes:`æ›´æ–°ç‚º ${u.length} å€‹é»è®š`}),console.log(`ğŸ‘ ${c?"å–æ¶ˆé»è®š":"é»è®š"}æˆåŠŸ`)}catch(o){console.error("âŒ é»è®šæ“ä½œå¤±æ•—:",o),h(n("community.messages.likeFail")),S(a=>a.map(m=>m.id===s?{...m,likes:r}:m))}finally{oe(o=>{const a=new Set(o);return a.delete(s),a})}},[se,v.currentUser,S]),ze=g.useCallback(async s=>{if(v.currentUser)try{const r=$(b,"communityPosts",s),c=await ne(r);if(c.exists()){const o=c.data().comments||[];S(a=>a.map(m=>m.id===s?{...m,comments:o}:m)),console.log(`ğŸ’¬ è¼‰å…¥è©•è«–å®Œæˆï¼š${o.length} æ¢è©•è«–`)}}catch(r){console.error("âŒ è¼‰å…¥è©•è«–å¤±æ•—:",r)}},[]),De=g.useCallback(async(s,r)=>{var o;if(!r.trim())return;if(!v.currentUser){h(n("community.messages.needLogin"));return}if(fe.has(s)){console.log("ğŸ”„ ç•™è¨€æäº¤ä¸­ï¼Œè«‹ç¨å€™...");return}const c={id:Date.now().toString(),userId:v.currentUser.uid,userNickname:(t==null?void 0:t.nickname)||((o=t==null?void 0:t.email)==null?void 0:o.split("@")[0])||n("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(t==null?void 0:t.avatarUrl)||"",content:r.trim(),timestamp:new Date().toISOString()};S(a=>a.map(x=>{if(x.id===s){const l=[...x.comments,c];return{...x,comments:l}}return x})),je(a=>new Set(a).add(s)),te.current.has(s)&&clearTimeout(te.current.get(s));const u=setTimeout(async()=>{try{const a=F.find(l=>l.id===s);if(!a){h(n("community.messages.postNotFound"));return}const m=[...a.comments,c],x=$(b,"communityPosts",s);await Ne(x,{comments:m},{merge:!0}),E.logWrite("setDoc","communityPosts",s,{comments:`æ–°å¢ç•™è¨€ï¼Œç¸½è¨ˆ ${m.length} æ¢`}),console.log("ğŸ’¬ ç•™è¨€æ·»åŠ æˆåŠŸ")}catch(a){console.error("âŒ æ·»åŠ ç•™è¨€å¤±æ•—:",a),h(n("community.messages.commentFail")),S(m=>m.map(l=>{if(l.id===s){const d=l.comments.filter(w=>w.id!==c.id);return{...l,comments:d}}return l}))}finally{je(a=>{const m=new Set(a);return m.delete(s),m}),te.current.delete(s)}},500);te.current.set(s,u)},[v.currentUser,t==null?void 0:t.nickname,t==null?void 0:t.email,t==null?void 0:t.avatarUrl,fe,F,S]),Qe=g.useCallback(async(s,r)=>{if(!v.currentUser){h(n("community.messages.needLogin"));return}try{const c=F.find(w=>w.id===s);if(!c){h(n("community.messages.postNotFound"));return}const u=c.comments.find(w=>w.id===r);if(!u){h(n("community.messages.commentNotFound"));return}const o=v.currentUser.uid,a=c.userId===o,m=u.userId===o;if(!a&&!m){h(n("community.messages.noPermission"));return}const x=n(a?"community.confirm.deleteComment":"community.confirm.deleteMyComment");if(!window.confirm(x))return;const l=c.comments.filter(w=>w.id!==r),d=$(b,"communityPosts",s);await Ne(d,{comments:l},{merge:!0}),E.logWrite("setDoc","communityPosts",s,{comments:`åˆªé™¤ç•™è¨€ï¼Œç¸½è¨ˆ ${l.length} æ¢`}),console.log("ğŸ”„ æ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œåˆªé™¤ç•™è¨€:",r),S(w=>{const y=w.map(f=>f.id===s?{...f,comments:l}:f);return console.log(`ğŸ“Š å‹•æ…‹ ${s} ç•™è¨€æ•¸: ${l.length}`),y}),I(n("community.messages.deleteCommentSuccess")),setTimeout(()=>I(""),3e3)}catch(c){console.error("âŒ åˆªé™¤ç•™è¨€å¤±æ•—:",c),h(n("community.messages.deleteCommentFail"))}},[F]),Ge=g.useCallback(async s=>{if(!v.currentUser){h(n("community.messages.needLogin"));return}try{const r=F.find(o=>o.id===s);if(!r){h(n("community.messages.postNotFound"));return}const c=v.currentUser.uid;if(r.userId!==c){h(n("community.messages.noPermission"));return}if(!window.confirm(n("community.confirm.deletePost")))return;const u=$(b,"communityPosts",s);await Te(u),E.logWrite("deleteDoc","communityPosts",s,{action:"åˆªé™¤å‹•æ…‹"}),console.log("ğŸ”„ æ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œåˆªé™¤å‹•æ…‹:",s),S(o=>{const a=o.filter(m=>m.id!==s);return console.log(`ğŸ“Š å‰©é¤˜å‹•æ…‹æ•¸: ${a.length}`),a}),I(n("community.messages.deletePostSuccess")),setTimeout(()=>I(""),3e3)}catch(r){console.error("âŒ åˆªé™¤å‹•æ…‹å¤±æ•—:",r),h(n("community.messages.deletePostFail"))}},[F]),_e=g.useCallback(s=>{const r=new Date,c=new Date(s),u=r-c,o=Math.floor(u/(1e3*60)),a=Math.floor(u/(1e3*60*60)),m=Math.floor(u/(1e3*60*60*24));if(o<1)return n("community.time.justNow");if(o<60)return n("community.time.minutesAgo",{count:o});if(a<24)return n("community.time.hoursAgo",{count:a});if(m<7)return n("community.time.daysAgo",{count:m});try{return new Intl.DateTimeFormat(re.language).format(c)}catch{return c.toLocaleDateString()}},[re.language,n]),K=g.useCallback(async()=>{var s;try{if(W.current)return;if(j(!0),!v.currentUser)throw new Error("æœªç™»å…¥");const r=z(M(b,"friendInvitations"),q("fromUserId","==",v.currentUser.uid),q("status","==","accepted")),c=z(M(b,"friendInvitations"),q("toUserId","==",v.currentUser.uid),q("status","==","accepted")),[u,o]=await Promise.all([D(r),D(c)]),a=new Set;u.forEach(d=>{const w=d.data();a.add(w.toUserId)}),o.forEach(d=>{const w=d.data();a.add(w.fromUserId)});const m=[];for(const d of a)try{const w=await ne($(b,"users",d));if(w.exists()){const y=w.data();if(!y){console.warn(`å¥½å‹ ${d} çš„ç”¨æˆ¶æ•¸æ“šç‚ºç©º`);continue}console.log(`âœ… è¼‰å…¥å¥½å‹è³‡æ–™: ${d} - ${y.nickname||y.email}`);let f=0,p=0;if(y.scores){const U=[];y.scores.strength&&y.scores.strength>0&&U.push(y.scores.strength),y.scores.explosivePower&&y.scores.explosivePower>0&&U.push(y.scores.explosivePower),y.scores.cardio&&y.scores.cardio>0&&U.push(y.scores.cardio),y.scores.muscleMass&&y.scores.muscleMass>0&&U.push(y.scores.muscleMass),y.scores.bodyFat&&y.scores.bodyFat>0&&U.push(y.scores.bodyFat),console.log(`å¥½å‹ ${d} çš„è©•åˆ†æ•¸æ“š:`,y.scores),console.log(`å¥½å‹ ${d} çš„æœ‰æ•ˆåˆ†æ•¸:`,U),U.length>0&&(f=U.reduce((R,xe)=>R+xe,0)/U.length,p=U.length,console.log(`å¥½å‹ ${d} å¹³å‡åˆ†æ•¸: ${f}, é …ç›®æ•¸: ${p}`))}else console.log(`å¥½å‹ ${d} æ²’æœ‰è©•åˆ†æ•¸æ“š`);m.push({id:d,nickname:y.nickname||((s=y.email)==null?void 0:s.split("@")[0])||"æœªå‘½åç”¨æˆ¶",email:y.email||"",avatarUrl:y.avatarUrl||"",averageScore:f>0?Number(f).toFixed(2):null,scoreCount:p,lastActive:y.lastActive})}}catch(w){console.error(`è¼‰å…¥å¥½å‹ ${d} æ•¸æ“šå¤±æ•—:`,w)}const x=m.filter(d=>d&&d.id&&typeof d.nickname=="string");Y(x);const l=Array.from(a);J(d=>({...d,friends:l})),W.current=!0}catch(r){console.error("è¼‰å…¥å¥½å‹æ•¸æ“šå¤±æ•—:",r),h(n("community.messages.loadFriendsFail")),W.current=!0}finally{j(!1)}},[]),B=g.useCallback(async()=>{var s;try{console.log("ğŸ” é–‹å§‹è¼‰å…¥å¥½å‹é‚€è«‹..."),console.log("ç•¶å‰ç”¨æˆ¶ID:",v.currentUser.uid);const r=z(M(b,"friendInvitations"),q("toUserId","==",v.currentUser.uid)),c=await D(r);console.log("ğŸ“‹ æ‰¾åˆ°æ‰€æœ‰é‚€è«‹æ•¸é‡:",c.docs.length),c.docs.forEach((m,x)=>{const l=m.data();console.log(`é‚€è«‹ ${x+1}:`,{id:m.id,fromUserId:l.fromUserId,toUserId:l.toUserId,status:l.status,createdAt:l.createdAt})});const u=z(M(b,"friendInvitations"),q("toUserId","==",v.currentUser.uid),q("status","==","pending")),o=await D(u);console.log("ğŸ“‹ æ‰¾åˆ°pendingé‚€è«‹æ•¸é‡:",o.docs.length);const a=[];for(const m of o.docs){const x=m.data();try{const l=await ne($(b,"users",x.fromUserId));if(l.exists()){const d=l.data();a.push({id:m.id,fromUserId:x.fromUserId,nickname:d.nickname||((s=d.email)==null?void 0:s.split("@")[0])||"æœªå‘½åç”¨æˆ¶",email:d.email,avatarUrl:d.avatarUrl||"",createdAt:x.createdAt})}}catch(l){console.error("ç²å–é‚€è«‹ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:",l)}}console.log("âœ… è¼‰å…¥å®Œæˆï¼Œé‚€è«‹åˆ—è¡¨:",a),ce(a),me.current=!0}catch(r){console.error("è¼‰å…¥å¥½å‹é‚€è«‹å¤±æ•—:",r),me.current=!0}},[ce]),pe=async()=>{if(!A.trim()){ee([]);return}try{j(!0);const s=z(M(b,"users")),r=await D(s),c=[];r.forEach(u=>{var l;const o=u.data(),a=A.toLowerCase(),m=(o.nickname||"").toLowerCase(),x=(o.email||"").toLowerCase();(m.includes(a)||x.includes(a))&&u.id!==v.currentUser.uid&&c.push({id:u.id,nickname:o.nickname||((l=o.email)==null?void 0:l.split("@")[0])||"æœªå‘½åç”¨æˆ¶",email:o.email,avatarUrl:o.avatarUrl||"",isFriend:i.some(d=>d.id===u.id),hasPendingRequest:!1})}),ee(c)}catch(s){console.error("æœå°‹ç”¨æˆ¶å¤±æ•—:",s),h(n("community.messages.searchFail"))}finally{j(!1)}},He=async s=>{var r;try{if(console.log("ğŸ“¤ é–‹å§‹ç™¼é€å¥½å‹é‚€è«‹..."),console.log("ç™¼é€è€…ID:",v.currentUser.uid),console.log("æ¥æ”¶è€…ID:",s),j(!0),(((r=t==null?void 0:t.friends)==null?void 0:r.length)||(i==null?void 0:i.length)||0)>=100){h(n("community.messages.friendLimitMessage"));return}const o=z(M(b,"friendInvitations"),q("fromUserId","==",v.currentUser.uid),q("toUserId","==",s),q("status","==","pending")),a=await D(o);if(!a.empty){console.log("âš ï¸ ç™¼ç¾å·²å­˜åœ¨çš„é‚€è«‹:",a.docs.length,"å€‹");const l=a.docs[0],d=l.data();console.log("ç¾æœ‰é‚€è«‹è³‡æ–™:",d);const w=new Date(d.createdAt);if((new Date-w)/(1e3*60*60)>24)console.log("ğŸ“… é‚€è«‹å·²è¶…é24å°æ™‚ï¼Œå…è¨±é‡æ–°ç™¼é€"),await Te($(b,"friendInvitations",l.id)),console.log("ğŸ—‘ï¸ å·²åˆªé™¤èˆŠé‚€è«‹");else{h(n("community.messages.inviteSent")),setTimeout(()=>{h("")},3e3);return}}const m={fromUserId:v.currentUser.uid,toUserId:s,status:"pending",createdAt:new Date().toISOString()};console.log("ğŸ“ é‚€è«‹è³‡æ–™:",m);const x=await Me(M(b,"friendInvitations"),m);E.logWrite("addDoc","friendInvitations",x.id),console.log("âœ… é‚€è«‹å·²ç™¼é€ï¼Œæ–‡æª”ID:",x.id),I(n("community.messages.inviteSent"));try{const l=await ne(x);l.exists()?console.log("âœ… é‚€è«‹é©—è­‰æˆåŠŸ:",l.data()):console.error("âŒ é‚€è«‹é©—è­‰å¤±æ•—ï¼šæ–‡æª”ä¸å­˜åœ¨")}catch(l){console.error("âŒ é‚€è«‹é©—è­‰å¤±æ•—:",l)}ee(l=>l.map(d=>d.id===s?{...d,hasPendingRequest:!0}:d)),setTimeout(()=>{B()},1e3)}catch(c){console.error("ç™¼é€å¥½å‹é‚€è«‹å¤±æ•—:",c),h(n("community.messages.inviteSendFail"))}finally{j(!1)}},Le=async(s,r)=>{var c;try{if(j(!0),(((c=t==null?void 0:t.friends)==null?void 0:c.length)||(i==null?void 0:i.length)||0)>=100){h(n("community.messages.friendLimitMessage"));return}await ie($(b,"friendInvitations",s),{status:"accepted",updatedAt:new Date().toISOString()}),E.logWrite("updateDoc","friends",s);const a=$(b,"users",v.currentUser.uid);await ie(a,{friends:ns(r)}),E.logWrite("updateDoc","users",v.currentUser.uid,{friends:"arrayUnion"}),J(m=>({...m,friends:[...m.friends||[],r]})),await K(),await B(),I(n("community.messages.inviteAccepted"))}catch(u){console.error("æ¥å—å¥½å‹é‚€è«‹å¤±æ•—:",u),h(`${n("community.messages.inviteAcceptFail")}: ${u.message}`)}finally{j(!1)}},Ke=async s=>{try{j(!0),await ie($(b,"friendInvitations",s),{status:"declined",updatedAt:new Date().toISOString()}),E.logWrite("updateDoc","friendInvitations",s),await B(),I(n("community.messages.inviteRejected"))}catch(r){console.error("æ‹’çµ•å¥½å‹é‚€è«‹å¤±æ•—:",r),h(`${n("community.messages.inviteRejectFail")}: ${r.message}`)}finally{j(!1)}},Je=s=>{if(!s){console.error("å¥½å‹IDç‚ºç©º");return}const r=i.find(c=>c.id===s);r?(console.log("ğŸ”„ è·³è½‰åˆ°å¥½å‹å€‹äººç‰ˆ:",s,r.nickname),N(`/friend-feed/${s}`)):(console.error("æ‰¾ä¸åˆ°å¥½å‹:",s),console.log("ç•¶å‰å¥½å‹åˆ—è¡¨:",i))},Ve=async s=>{const r=i.find(a=>a.id===s),c=(r==null?void 0:r.nickname)||"å¥½å‹";if(!(!window.confirm(`ç¢ºå®šè¦ç§»é™¤å¥½å‹ã€Œ${c}ã€å—ï¼Ÿ

ç§»é™¤å¾Œï¼š
â€¢ é›™æ–¹å°‡ä¸å†æ˜¯å¥½å‹é—œä¿‚
â€¢ ç„¡æ³•æŸ¥çœ‹å°æ–¹çš„å‹•æ…‹
â€¢ æ­¤æ“ä½œå¯ä»¥é‡æ–°åŠ å¥½å‹ä¾†æ¢å¾©`)||!window.confirm(`æœ€å¾Œç¢ºèªï¼šç¢ºå®šè¦ç§»é™¤å¥½å‹ã€Œ${c}ã€å—ï¼Ÿæ­¤æ“ä½œå°‡ç«‹å³ç”Ÿæ•ˆã€‚`)))try{j(!0);const a=$(b,"users",v.currentUser.uid);await ie(a,{friends:ts(s)});const x=(await D(z(M(b,"friendInvitations"),q("fromUserId","in",[v.currentUser.uid,s]),q("toUserId","in",[v.currentUser.uid,s])))).docs.map(l=>ie(l.ref,{status:"cancelled",cancelledAt:new Date().toISOString()}));await Promise.all(x),J(l=>{var d;return{...l,friends:((d=l.friends)==null?void 0:d.filter(w=>w!==s))||[]}}),Y(l=>l.filter(d=>d.id!==s)),I(`å·²ç§»é™¤å¥½å‹ã€Œ${c}ã€`)}catch(a){console.error("ç§»é™¤å¥½å‹å¤±æ•—:",a),h(`ç§»é™¤å¥½å‹å¤±æ•—: ${a.message}`)}finally{j(!1)}};return g.useEffect(()=>{try{he(),K(),B()}catch(s){console.error("åˆå§‹è¼‰å…¥å¤±æ•—:",s),h("è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}return()=>{const s=te.current;s&&(s.forEach(r=>clearTimeout(r)),s.clear())}},[he,K,B]),g.useEffect(()=>{try{P==="friends"&&!W.current?(console.log("ğŸ”„ æ¨™ç±¤åˆ‡æ›æ™‚é‡æ–°è¼‰å…¥å¥½å‹æ•¸æ“š"),K()):P==="requests"&&!me.current&&(console.log("ğŸ”„ æ¨™ç±¤åˆ‡æ›æ™‚é‡æ–°è¼‰å…¥é‚€è«‹æ•¸æ“š"),B())}catch(s){console.error("æ¨™ç±¤åˆ‡æ›è¼‰å…¥å¤±æ•—:",s),h("è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}},[P,K,B]),e.jsxs("div",{className:"community-page",children:[e.jsxs("div",{className:"community-header",children:[e.jsxs("h1",{children:["ğŸ  ",n("community.brandTitle")]}),O&&e.jsx("div",{className:"alert alert-error",children:O}),_&&e.jsx("div",{className:"alert alert-success",children:_})]}),!i&&e.jsx("div",{className:"alert alert-error",children:"è¼‰å…¥å¥½å‹åˆ—è¡¨æ™‚å‡ºç¾éŒ¯èª¤ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦"}),e.jsxs("div",{className:"tab-navigation",children:[!W.current&&e.jsx("div",{className:"loading-indicator",children:"æ­£åœ¨è¼‰å…¥å¥½å‹æ•¸æ“š..."}),e.jsx("div",{className:`tab-btn ${P==="feed"?"active":""}`,onClick:()=>Q("feed"),children:e.jsx("span",{className:"tab-label",children:n("community.tabs.feed")})}),e.jsx("div",{className:`tab-btn ${P==="friends"?"active":""}`,onClick:()=>Q("friends"),children:e.jsxs("span",{className:"tab-label",children:[n("community.tabs.friends")," (",W.current?i.length:"...",")"]})}),e.jsxs("div",{className:`tab-btn ${P==="requests"?"active":""}`,onClick:()=>Q("requests"),children:[e.jsx("span",{className:"tab-label",children:n("community.tabs.invites")}),L.length>0&&e.jsx("span",{className:"notification-badge",children:L.length})]}),e.jsx("div",{className:`tab-btn ${P==="search"?"active":""}`,onClick:()=>Q("search"),children:e.jsx("span",{className:"tab-label",children:n("community.tabs.search")})})]}),e.jsxs("div",{className:"tab-content",children:[G&&e.jsx("div",{className:"loading",children:"è¼‰å…¥ä¸­..."}),O&&!G&&e.jsxs("div",{className:"alert alert-error",children:[O,e.jsx("button",{onClick:()=>{le.current=!1,W.current=!1,me.current=!1,de.current.clear(),ue.current=0,h(""),he(),K(),B()},style:{marginLeft:"10px",padding:"5px 10px",background:"#ff6b6b",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"é‡è©¦"})]}),!O&&!G&&P==="feed"&&e.jsx("div",{className:"refresh-section",children:e.jsxs("button",{onClick:()=>{le.current=!1,W.current=!1,de.current.clear(),ue.current=0,K(),he()},style:{padding:"8px 16px",background:"var(--tiffany-secondary)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",marginBottom:"10px"},children:["ğŸ”„ ",n("community.refresh")]})}),P==="feed"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"post-composer",children:e.jsxs("div",{className:"composer-header",children:[e.jsx("div",{className:"user-avatar",children:e.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(t==null?void 0:t.avatarUrl)||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),loading:"lazy",onError:s=>{s.target.src="/default-avatar.svg"}})}),e.jsxs("div",{className:"composer-input",children:[e.jsx("textarea",{placeholder:n("community.sharePlaceholder"),value:H,onChange:s=>V(s.target.value),maxLength:500,disabled:X}),e.jsxs("div",{className:"composer-footer",children:[e.jsxs("span",{className:"char-count",children:[H.length,"/500"]}),e.jsx("button",{onClick:We,disabled:!H.trim()||X,className:"publish-btn",children:n(X?"community.publishing":"community.publish")})]})]})]})}),e.jsx("div",{className:"posts-container",children:F.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:n("community.emptyFeed.title")}),e.jsx("p",{children:n("community.emptyFeed.subtitle")})]}):F.map(s=>{var r;return e.jsx(Oe,{post:s,currentUserId:(r=v.currentUser)==null?void 0:r.uid,onToggleLike:Be,onAddComment:De,onDeleteComment:Qe,onDeletePost:Ge,onLoadComments:ze,formatTime:_e,likeProcessing:se,commentProcessing:fe},s.id)})})]}),P==="friends"&&e.jsxs("div",{className:"friends-tab",children:[e.jsxs("div",{className:"friends-limit-info",children:[e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"ğŸ‘¥"}),e.jsx("span",{className:"limit-text",children:n("community.messages.friendLimitInfo")})]}),e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"ğŸ“Š"}),e.jsxs("span",{className:"limit-text",children:[n("community.messages.currentFriends"),"ï¼š",((be=t==null?void 0:t.friends)==null?void 0:be.length)||(i==null?void 0:i.length)||0," / 100",100-(((Ue=t==null?void 0:t.friends)==null?void 0:Ue.length)||(i==null?void 0:i.length)||0)<=10&&e.jsxs("span",{className:"limit-warning",children:[" ","(åƒ…å‰©"," ",100-(((ke=t==null?void 0:t.friends)==null?void 0:ke.length)||(i==null?void 0:i.length)||0)," ","å€‹åé¡)"]})]})]}),(((Ce=t==null?void 0:t.friends)==null?void 0:Ce.length)||(i==null?void 0:i.length)||0)>=100&&e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"âš ï¸"}),e.jsx("span",{className:"limit-text limit-warning",children:"å·²é”å¥½å‹æ•¸é‡ä¸Šé™ï¼Œç„¡æ³•æ·»åŠ æ›´å¤šå¥½å‹"})]})]}),!i||i.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:n("community.noFriends")}),e.jsx("p",{children:n("community.goSearchFriends")})]}):e.jsx("div",{className:"friends-list",children:i.filter(s=>s&&s.id).map(s=>e.jsxs("div",{className:"friend-item",children:[e.jsxs("div",{className:"friend-info",children:[e.jsx("img",{src:s.avatarUrl||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:r=>{r.target.src="/default-avatar.svg"}}),e.jsxs("div",{className:"friend-details",children:[e.jsx("div",{className:"friend-name",children:s.nickname||n("community.fallback.unnamedUser")}),e.jsx("div",{className:"friend-score",children:s.averageScore?e.jsx(e.Fragment,{children:e.jsxs("span",{className:"score-value",children:["ğŸ† ",s.averageScore,n("community.ui.pointsUnit")]})}):e.jsx("span",{className:"no-score",children:n("community.ui.noScore")})}),e.jsx("div",{className:"friend-email",children:s.email||""})]})]}),e.jsxs("div",{className:"friend-actions",children:[e.jsx("button",{className:"btn-board",onClick:()=>s.id&&Je(s.id),title:n("community.ui.boardTitle"),children:"ğŸ’¬"}),e.jsx("button",{className:"btn-remove",onClick:()=>s.id&&Ve(s.id),title:n("community.friend.remove"),children:"âŒ"})]})]},s.id||"unknown"))})]}),P==="requests"&&e.jsxs("div",{className:"requests-tab",children:[e.jsxs("div",{className:"friends-limit-info",children:[e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"ğŸ‘¥"}),e.jsx("span",{className:"limit-text",children:n("community.messages.friendLimitInfo")})]}),e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"ğŸ“Š"}),e.jsxs("span",{className:"limit-text",children:[n("community.messages.currentFriends"),"ï¼š",((Se=t==null?void 0:t.friends)==null?void 0:Se.length)||(i==null?void 0:i.length)||0," / 100",100-(((Re=t==null?void 0:t.friends)==null?void 0:Re.length)||(i==null?void 0:i.length)||0)<=10&&e.jsxs("span",{className:"limit-warning",children:[" ","(åƒ…å‰©"," ",100-(((Pe=t==null?void 0:t.friends)==null?void 0:Pe.length)||(i==null?void 0:i.length)||0)," ","å€‹åé¡)"]})]})]}),(((Fe=t==null?void 0:t.friends)==null?void 0:Fe.length)||(i==null?void 0:i.length)||0)>=100&&e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"âš ï¸"}),e.jsx("span",{className:"limit-text limit-warning",children:"å·²é”å¥½å‹æ•¸é‡ä¸Šé™ï¼Œç„¡æ³•æ¥å—æ›´å¤šé‚€è«‹"})]})]}),L.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:n("community.invites.empty")})}):e.jsx("div",{className:"requests-list",children:L.map(s=>{var r,c,u;return e.jsxs("div",{className:"request-item",children:[e.jsxs("div",{className:"request-info",children:[e.jsx("img",{src:s.avatarUrl||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),className:"request-avatar",loading:"lazy",onError:o=>{o.target.src="/default-avatar.svg"}}),e.jsxs("div",{className:"request-details",children:[e.jsx("div",{className:"request-name",children:s.nickname}),e.jsx("div",{className:"request-email",children:s.email})]})]}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"btn-accept",onClick:()=>Le(s.id,s.fromUserId),disabled:(((r=t==null?void 0:t.friends)==null?void 0:r.length)||(i==null?void 0:i.length)||0)>=100,title:(((c=t==null?void 0:t.friends)==null?void 0:c.length)||(i==null?void 0:i.length)||0)>=100?n("community.messages.friendLimitReached"):n("community.invites.accept"),children:(((u=t==null?void 0:t.friends)==null?void 0:u.length)||(i==null?void 0:i.length)||0)>=100?"âŒ":"âœ…"}),e.jsx("button",{className:"btn-decline",onClick:()=>Ke(s.id),title:n("community.invites.reject"),children:"âŒ"})]})]},s.id)})})]}),P==="search"&&e.jsxs("div",{className:"search-tab",children:[e.jsxs("div",{className:"friends-limit-info",children:[e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"ğŸ‘¥"}),e.jsx("span",{className:"limit-text",children:n("community.messages.friendLimitInfo")})]}),e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"ğŸ“Š"}),e.jsxs("span",{className:"limit-text",children:[n("community.messages.currentFriends"),"ï¼š",((Ie=t==null?void 0:t.friends)==null?void 0:Ie.length)||(i==null?void 0:i.length)||0," / 100",100-((($e=t==null?void 0:t.friends)==null?void 0:$e.length)||(i==null?void 0:i.length)||0)<=10&&e.jsxs("span",{className:"limit-warning",children:[" ","(åƒ…å‰©"," ",100-(((qe=t==null?void 0:t.friends)==null?void 0:qe.length)||(i==null?void 0:i.length)||0)," ","å€‹åé¡)"]})]})]}),(((Ae=t==null?void 0:t.friends)==null?void 0:Ae.length)||(i==null?void 0:i.length)||0)>=100&&e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"âš ï¸"}),e.jsx("span",{className:"limit-text limit-warning",children:"å·²é”å¥½å‹æ•¸é‡ä¸Šé™ï¼Œç„¡æ³•æ·»åŠ æ›´å¤šå¥½å‹"})]})]}),e.jsxs("div",{className:"search-container",children:[e.jsx("input",{type:"text",placeholder:n("community.search.placeholder"),value:A,onChange:s=>k(s.target.value),onKeyPress:s=>{s.key==="Enter"&&pe()},className:"search-input"}),e.jsx("button",{onClick:pe,className:"search-btn",children:n("common.search")})]}),e.jsx("div",{className:"search-results",children:Z.length===0&&A.trim()?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:n("community.search.empty")})}):Z.map(s=>{var r,c,u;return e.jsxs("div",{className:"user-item",children:[e.jsxs("div",{className:"user-info",children:[e.jsx("img",{src:s.avatarUrl||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onError:o=>{o.target.src="/default-avatar.svg"}}),e.jsxs("div",{className:"user-details",children:[e.jsx("div",{className:"user-name",children:s.nickname}),e.jsx("div",{className:"user-email",children:s.email})]})]}),e.jsx("div",{className:"user-actions",children:s.isFriend?e.jsx("span",{className:"status-badge",children:n("community.friend.badgeFriend")}):s.hasPendingRequest?e.jsx("span",{className:"status-badge",children:n("community.friend.badgeInvited")}):e.jsx("button",{className:"btn-add",onClick:()=>He(s.id),disabled:G||(((r=t==null?void 0:t.friends)==null?void 0:r.length)||(i==null?void 0:i.length)||0)>=100,title:(((c=t==null?void 0:t.friends)==null?void 0:c.length)||(i==null?void 0:i.length)||0)>=100?n("community.messages.friendLimitReached"):n("community.friend.add"),children:(((u=t==null?void 0:t.friends)==null?void 0:u.length)||(i==null?void 0:i.length)||0)>=100?"å·²é”ä¸Šé™":n("community.friend.add")})})]},s.id)})})]})]})]})},Oe=Ze.memo(({post:N,currentUserId:t,onToggleLike:J,onAddComment:n,onDeleteComment:re,onDeletePost:P,onLoadComments:Q,formatTime:F,likeProcessing:S,commentProcessing:G})=>{const{t:j}=Ee(),[O,h]=g.useState(!1),[_,I]=g.useState(""),[H,V]=g.useState(!1),[X,ae]=g.useState(!1),i=N.likes.includes(t),Y=N.likes.length,L=N.commentCount||N.comments.length,ce=()=>{const k=!O;h(k),k&&!X&&Q&&(Q(N.id),ae(!0))},A=()=>{_.trim()&&(n(N.id,_),I(""))};return e.jsxs("div",{className:"post-card",children:[e.jsxs("div",{className:"post-header",children:[e.jsxs("div",{className:"post-user",children:[e.jsx("img",{src:N.userAvatarUrl||"/default-avatar.svg",alt:j("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onLoad:()=>V(!0),onError:k=>{k.target.src="/default-avatar.svg",V(!0)},style:{opacity:H?1:.5,transition:"opacity 0.3s ease"}}),e.jsxs("div",{className:"user-info",children:[e.jsxs("div",{className:"user-name",children:[N.userNickname,N.targetUserId&&e.jsxs("span",{className:"to-label",children:[" ","â†’"," ",N.targetUserNickname||j("community.friend.badgeFriend")]})]}),e.jsx("div",{className:"post-time",children:F(N.timestamp)})]})]}),N.userId===t&&e.jsx("button",{onClick:()=>P(N.id),className:"delete-post-btn",title:j("community.titles.deletePost"),children:"ğŸ—‘ï¸"})]}),e.jsx("div",{className:"post-content",children:N.content}),e.jsxs("div",{className:"post-actions",children:[e.jsxs("button",{onClick:()=>J(N.id,N.likes),className:`action-btn ${i?"liked":""}`,disabled:S.has(N.id),children:[e.jsx("span",{className:"action-icon",children:S.has(N.id)?"â³":"ğŸ‘"}),e.jsx("span",{className:"action-text",children:S.has(N.id)?j("community.processing"):`${Y>0?Y:""} ${j("community.like")}`})]}),e.jsxs("button",{onClick:ce,className:"action-btn",children:[e.jsx("span",{className:"action-icon",children:"ğŸ’¬"}),e.jsxs("span",{className:"action-text",children:[L>0?L:""," ",j("community.comment")]})]})]}),O&&e.jsxs("div",{className:"comments-section",children:[N.comments.length>0&&e.jsx("div",{className:"comments-list",children:N.comments.map(k=>{const Z=N.userId===t,ee=k.userId===t,se=Z||ee;return e.jsxs("div",{className:"comment-item",children:[e.jsxs("div",{className:"comment-header",children:[e.jsxs("div",{className:"comment-user-info",children:[e.jsx("img",{src:k.userAvatarUrl||"/guest-avatar.svg",alt:j("community.ui.avatarAlt"),className:"comment-avatar",onError:oe=>{oe.target.src="/guest-avatar.svg"}}),e.jsxs("div",{className:"comment-text-info",children:[e.jsx("div",{className:"comment-name",children:k.userNickname}),e.jsx("div",{className:"comment-time",children:F(k.timestamp)})]})]}),se&&e.jsx("button",{onClick:()=>re(N.id,k.id),className:"comment-delete-btn",title:j(Z?"community.titles.deleteComment":"community.titles.deleteMyComment"),children:"ğŸ—‘ï¸"})]}),e.jsx("div",{className:"comment-content",children:k.content})]},k.id)})}),e.jsxs("div",{className:"comment-input",children:[e.jsx("input",{type:"text",placeholder:j("community.writeComment"),value:_,onChange:k=>I(k.target.value),onKeyPress:k=>{k.key==="Enter"&&A()}}),e.jsx("button",{onClick:A,disabled:!_.trim()||G.has(N.id),className:"comment-btn",children:G.has(N.id)?j("community.sending"):j("community.send")})]})]})]})});Oe.propTypes={post:C.shape({id:C.string.isRequired,userId:C.string.isRequired,userNickname:C.string.isRequired,userAvatarUrl:C.string,content:C.string.isRequired,timestamp:C.any.isRequired,likes:C.array.isRequired,comments:C.array.isRequired}).isRequired,currentUserId:C.string.isRequired,onToggleLike:C.func.isRequired,onAddComment:C.func.isRequired,onDeleteComment:C.func.isRequired,onDeletePost:C.func.isRequired,onLoadComments:C.func.isRequired,formatTime:C.func.isRequired,likeProcessing:C.instanceOf(Set).isRequired,commentProcessing:C.instanceOf(Set).isRequired};export{os as default};
