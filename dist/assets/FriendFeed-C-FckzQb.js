import{u as xe,a as ye,b as x,d as F,j as s,m as D}from"./index-BMtaLHIY.js";import{h as pe,d as je,r as h,R as Ne}from"./react-vendor-BToktFYo.js";import{l as S,m as ne,t as ae,q as z,w as ie,x as oe,y as ce,H as Fe,D as Pe,z as G}from"./firebase-D0136ThQ.js";import{p as le}from"./commentLimiter-CQkE7LZd.js";import{P as f}from"./charts-BNGpwEcn.js";const Se=()=>{const{userData:m}=xe(),{userId:v}=pe(),$=je(),[w,C]=h.useState([]),{t,i18n:de}=ye(),[me,O]=h.useState(!0),[A,u]=h.useState(""),[W,P]=h.useState(""),[b,q]=h.useState(""),[U,H]=h.useState(!1),[j,ue]=h.useState(null),[E,Q]=h.useState(new Set),[L,K]=h.useState(new Set),R=h.useRef(new Map),M=h.useRef(!1),B=h.useCallback(async()=>{var e;try{if(!v){u(t("friendFeed.messages.emptyUserId"));return}console.log("🔄 開始載入用戶資料:",v),console.log("🔄 當前登入用戶:",(e=x.currentUser)==null?void 0:e.uid);const r=S(F,"users",v);console.log("🔄 查詢文檔路徑:",r.path);const i=await ne(r);if(i.exists()){const c=i.data();console.log("✅ 用戶資料:",c),ue({id:i.id,...c}),console.log("✅ 好友資料載入成功:",c.nickname||c.email)}else console.error("❌ 找不到用戶:",v),console.error("❌ 文檔路徑:",r.path),u(t("friendFeed.messages.userNotFound"))}catch(r){console.error("載入好友資料失敗:",r),console.error("錯誤詳情:",{code:r.code,message:r.message,userId:v}),u(t("friendFeed.messages.loadUserFail"))}},[v]),I=h.useCallback(async()=>{try{if(M.current)return;O(!0),console.log("🔄 開始載入好友動態...");const e=ae(z(F,"communityPosts"),ie("userId","==",v),oe(50)),r=ae(z(F,"communityPosts"),ie("targetUserId","==",v),oe(50));let i,c;try{i=await ce(e),console.log("✅ 用戶動態查詢成功")}catch(o){console.warn("查詢用戶動態失敗，使用空結果:",o),i={docs:[]}}try{c=await ce(r),console.log("✅ 目標用戶動態查詢成功")}catch(o){console.warn("查詢目標用戶動態失敗，使用空結果:",o),c={docs:[]}}const d=[];i&&i.docs&&i.docs.forEach(o=>{const n=o.data();n.comments&&n.comments.length>0&&(console.log(`🔍 處理好友動態 ${o.id} 的 ${n.comments.length} 條留言`),n.comments=n.comments.map(g=>g.userAvatarUrl?(console.log(`✅ 好友留言 ${g.id} 已有頭像: ${g.userAvatarUrl}`),g):(console.log(`📝 好友留言 ${g.id} 缺少頭像，使用預設頭像`),{...g,userAvatarUrl:"/guest-avatar.svg"}))),(n.privacy||"friends")==="friends"&&d.push({id:o.id,...n})}),c&&c.docs&&c.docs.forEach(o=>{const n=o.data();d.find(a=>a.id===o.id)||(n.comments&&n.comments.length>0&&(console.log(`🔍 處理發給好友的動態 ${o.id} 的 ${n.comments.length} 條留言`),n.comments=n.comments.map(a=>a.userAvatarUrl?(console.log(`✅ 發給好友的留言 ${a.id} 已有頭像: ${a.userAvatarUrl}`),a):(console.log(`📝 發給好友的留言 ${a.id} 缺少頭像，使用預設頭像`),{...a,userAvatarUrl:"/guest-avatar.svg"}))),d.push({id:o.id,...n}))}),d.sort((o,n)=>new Date(n.timestamp)-new Date(o.timestamp)),console.log(`📊 載入到 ${d.length} 條動態`);const l=new Set;if(d.forEach(o=>{(o.comments||[]).forEach(n=>{!n.userAvatarUrl&&n.userId&&l.add(n.userId)})}),l.size>0){const o={};await Promise.all(Array.from(l).map(async n=>{try{const a=await ne(S(F,"users",n));if(a.exists()){const g=a.data();o[n]=g.avatarUrl||"/guest-avatar.svg"}else o[n]="/guest-avatar.svg"}catch(a){console.warn(`取得用戶 ${n} 頭像失敗`,a),o[n]="/guest-avatar.svg"}})),d.forEach(n=>{(n.comments||[]).forEach(a=>{!a.userAvatarUrl&&a.userId===n.userId&&(a.userAvatarUrl=n.userAvatarUrl),!a.userAvatarUrl&&o[a.userId]&&(a.userAvatarUrl=o[a.userId])})})}C([...d]),M.current=!0}catch(e){console.error("❌ 載入動態失敗:",e),C([])}finally{O(!1)}},[v]),J=async()=>{var e;if(!b.trim()){u(t("community.messages.emptyPost"));return}if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}try{H(!0),console.log("📝 準備發布動態...");const r={userId:x.currentUser.uid,userNickname:(m==null?void 0:m.nickname)||((e=m==null?void 0:m.email)==null?void 0:e.split("@")[0])||"匿名用戶",userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"",content:b.trim(),type:"status",likes:[],comments:[],timestamp:new Date().toISOString(),privacy:"friends",targetUserId:v},i=await Fe(z(F,"communityPosts"),r);D.logWrite("addDoc","communityPosts",i.id),console.log("✅ 動態發布成功，ID:",i.id),q(""),P(t("friendFeed.messages.publishSuccess")),await I(),setTimeout(()=>P(""),3e3)}catch(r){console.error("❌ 發布動態失敗:",r),u(`${t("friendFeed.messages.publishFail")}: ${r.message}`)}finally{H(!1)}},V=async(e,r)=>{if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}if(E.has(e)){console.log("🔄 點讚操作進行中，請稍候...");return}try{Q(o=>new Set(o).add(e));const i=x.currentUser.uid,c=r.includes(i),d=c?r.filter(o=>o!==i):[...r,i],l=S(F,"communityPosts",e);await G(l,{likes:d}),D.logWrite("updateDoc","communityPosts",e,{likes:`更新為 ${d.length} 個點讚`}),C(o=>o.map(n=>n.id===e?{...n,likes:d}:n)),console.log(`👍 ${c?"取消點讚":"點讚"}成功`)}catch(i){console.error("❌ 點讚操作失敗:",i),u(t("friendFeed.messages.actionFail"))}finally{Q(i=>{const c=new Set(i);return c.delete(e),c})}},X=async(e,r)=>{var n;if(!r.trim())return;if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}if(L.has(e)){console.log("🔄 留言提交中，請稍候...");return}const i=w.find(a=>a.id===e);if(!i){u(t("friendFeed.messages.postNotFound"));return}const c=le(i.comments||[],null,"post");if(!c.success){u(c.message);return}const d={id:Date.now().toString(),userId:x.currentUser.uid,userNickname:(m==null?void 0:m.nickname)||((n=m==null?void 0:m.email)==null?void 0:n.split("@")[0])||"匿名用戶",userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"",content:r.trim(),timestamp:new Date().toISOString()},l=le(i.comments||[],d,"post");if(!l.success){u(l.message);return}C(a=>a.map(y=>y.id===e?{...y,comments:l.comments}:y)),K(a=>new Set(a).add(e)),R.current.has(e)&&clearTimeout(R.current.get(e));const o=setTimeout(async()=>{try{const a=S(F,"communityPosts",e);await G(a,{comments:l.comments}),D.logWrite("updateDoc","communityPosts",e,{comments:`新增留言，總計 ${l.comments.length} 條`,wasAutoCleaned:l.wasAutoCleaned,removedCount:l.removedCount}),l.notification&&(P(l.notification),setTimeout(()=>P(""),5e3)),console.log("💬 留言添加成功",{totalComments:l.comments.length,wasAutoCleaned:l.wasAutoCleaned,removedCount:l.removedCount})}catch(a){console.error("❌ 添加留言失敗:",a),u(t("friendFeed.messages.commentFail")),C(g=>g.map(N=>N.id===e?{...N,comments:i.comments||[]}:N))}finally{K(a=>{const g=new Set(a);return g.delete(e),g}),R.current.delete(e)}},500);R.current.set(e,o)},Y=async(e,r)=>{if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}try{const i=w.find(y=>y.id===e);if(!i){u(t("friendFeed.messages.postNotFound"));return}const c=i.comments.find(y=>y.id===r);if(!c){u(t("community.messages.commentNotFound"));return}const d=x.currentUser.uid,l=i.userId===d,o=c.userId===d;if(!l&&!o){u(t("friendFeed.messages.noPermission"));return}const n=t(l?"friendFeed.confirm.deleteComment":"friendFeed.confirm.deleteMyComment");if(!window.confirm(n))return;const a=i.comments.filter(y=>y.id!==r),g=S(F,"communityPosts",e);await G(g,{comments:a}),D.logWrite("updateDoc","communityPosts",e,{comments:`刪除留言，總計 ${a.length} 條`}),C(y=>y.map(k=>k.id===e?{...k,comments:a}:k)),P(t("friendFeed.messages.deleteCommentSuccess")),setTimeout(()=>P(""),3e3)}catch(i){console.error("❌ 刪除留言失敗:",i),u(t("friendFeed.messages.deleteCommentFail"))}},Z=async e=>{if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}try{const r=w.find(d=>d.id===e);if(!r){u(t("friendFeed.messages.postNotFound"));return}const i=x.currentUser.uid;if(r.userId!==i){u(t("friendFeed.messages.noPermission"));return}if(!window.confirm(t("friendFeed.confirm.deletePost")))return;const c=S(F,"communityPosts",e);await Pe(c),D.logWrite("deleteDoc","communityPosts",e,{action:"刪除動態"}),console.log("🔄 更新本地狀態，刪除動態:",e),C(d=>{const l=d.filter(o=>o.id!==e);return console.log(`📊 剩餘動態數: ${l.length}`),l}),P(t("friendFeed.messages.deletePostSuccess")),setTimeout(()=>P(""),3e3)}catch(r){console.error("❌ 刪除動態失敗:",r),u(t("friendFeed.messages.deletePostFail"))}},_=h.useCallback(e=>{const r=new Date,i=new Date(e),c=r-i,d=Math.floor(c/(1e3*60)),l=Math.floor(c/(1e3*60*60)),o=Math.floor(c/(1e3*60*60*24));if(d<1)return t("friendFeed.time.justNow");if(d<60)return t("friendFeed.time.minutesAgo",{count:d});if(l<24)return t("friendFeed.time.hoursAgo",{count:l});if(o<7)return t("friendFeed.time.daysAgo",{count:o});try{return new Intl.DateTimeFormat(de.language).format(i)}catch{return i.toLocaleDateString()}},[]),T=Ne.memo(({post:e,currentUserId:r,onToggleLike:i,onAddComment:c,onDeleteComment:d,onDeletePost:l,formatTime:o,likeProcessing:n,commentProcessing:a})=>{const[g,y]=h.useState(!1),[N,k]=h.useState(""),ge=e.likes.includes(r),ee=e.likes.length,se=e.comments.length,te=()=>{N.trim()&&(c(e.id,N),k(""))};return s.jsxs("div",{className:"post-card",children:[s.jsxs("div",{className:"post-header",children:[s.jsxs("div",{className:"post-user",children:[s.jsx("img",{src:e.userAvatarUrl||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onError:p=>{p.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"user-info",children:[s.jsxs("div",{className:"user-name",children:[e.userNickname,e.targetUserId&&s.jsxs("span",{className:"to-label",children:[" ","→ ",(j==null?void 0:j.nickname)||t("community.friendLabel")]})]}),s.jsx("div",{className:"post-time",children:o(e.timestamp)})]})]}),e.userId===r&&s.jsx("button",{onClick:()=>l(e.id),className:"delete-post-btn",title:t("community.titles.deletePost"),children:"🗑️"})]}),s.jsx("div",{className:"post-content",children:e.content}),s.jsxs("div",{className:"post-actions",children:[s.jsxs("button",{onClick:()=>i(e.id,e.likes),className:`action-btn ${ge?"liked":""}`,disabled:n.has(e.id),children:[s.jsx("span",{className:"action-icon",children:n.has(e.id)?"⏳":"👍"}),s.jsx("span",{className:"action-text",children:n.has(e.id)?t("community.processing"):`${ee>0?ee:""} ${t("community.like")}`})]}),s.jsxs("button",{onClick:()=>y(!g),className:"action-btn",children:[s.jsx("span",{className:"action-icon",children:"💬"}),s.jsxs("span",{className:"action-text",children:[se>0?se:""," ",t("community.comment")]})]})]}),g&&s.jsxs("div",{className:"comments-section",children:[e.comments.length>0&&s.jsx("div",{className:"comments-list",children:e.comments.map(p=>{const re=e.userId===r,fe=p.userId===r,he=re||fe;return s.jsxs("div",{className:"comment-item",children:[s.jsxs("div",{className:"comment-header",children:[s.jsxs("div",{className:"comment-user-info",children:[s.jsx("img",{src:p.userAvatarUrl||"/guest-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"comment-avatar",loading:"lazy",onError:ve=>{ve.target.src="/guest-avatar.svg"}}),s.jsxs("div",{className:"comment-text-info",children:[s.jsx("div",{className:"comment-name",children:p.userNickname}),s.jsx("div",{className:"comment-time",children:o(p.timestamp)})]})]}),he&&s.jsx("button",{onClick:()=>d(e.id,p.id),className:"comment-delete-btn",title:t(re?"community.titles.deleteComment":"community.titles.deleteMyComment"),children:"🗑️"})]}),s.jsx("div",{className:"comment-content",children:p.content})]},p.id)})}),s.jsxs("div",{className:"comment-input",children:[s.jsx("input",{type:"text",placeholder:t("friendFeed.ui.inputPlaceholder"),value:N,onChange:p=>k(p.target.value),onKeyPress:p=>{p.key==="Enter"&&te()}}),s.jsx("button",{onClick:te,disabled:!N.trim()||a.has(e.id),className:"comment-btn",children:a.has(e.id)?"發送中...":"發送"})]})]})]})});return T.displayName="PostCard",T.propTypes={post:f.shape({id:f.string.isRequired,userId:f.string.isRequired,userNickname:f.string.isRequired,userAvatarUrl:f.string,content:f.string.isRequired,timestamp:f.any.isRequired,likes:f.array.isRequired,comments:f.array.isRequired,targetUserId:f.string}).isRequired,currentUserId:f.string.isRequired,onToggleLike:f.func.isRequired,onAddComment:f.func.isRequired,onDeleteComment:f.func.isRequired,onDeletePost:f.func.isRequired,formatTime:f.func.isRequired,likeProcessing:f.instanceOf(Set).isRequired,commentProcessing:f.instanceOf(Set).isRequired},h.useEffect(()=>{if(!x.currentUser){console.error("❌ 用戶未登入"),u("請先登入");return}return console.log("🔄 開始載入好友頁面數據..."),console.log("🔄 目標用戶ID:",v),M.current=!1,B(),I(),()=>{const e=R.current;e&&(e.forEach(r=>clearTimeout(r)),e.clear())}},[B,I,v]),me?s.jsx("div",{className:"friend-feed-page",children:s.jsx("div",{className:"loading",children:t("friendFeed.ui.loading")})}):A&&!x.currentUser?s.jsxs("div",{className:"friend-feed-page",children:[s.jsxs("div",{className:"error-message",children:[s.jsx("p",{children:t("friendFeed.messages.needLogin")}),s.jsx("button",{onClick:()=>$("/login"),className:"login-btn",children:t("community.goLogin")})]}),s.jsx("button",{onClick:()=>$("/community"),className:"back-btn",children:t("community.back")})]}):A&&!j?s.jsxs("div",{className:"friend-feed-page",children:[s.jsxs("div",{className:"friend-feed-header",children:[s.jsxs("button",{onClick:()=>$("/community"),className:"back-btn",children:["← ",t("community.back")]}),s.jsxs("div",{className:"friend-info",children:[s.jsx("img",{src:"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"friend-details",children:[s.jsx("h1",{children:t("friendFeed.ui.pageTitle",{id:v==null?void 0:v.substring(0,8)})}),s.jsx("p",{children:t("friendFeed.messages.loadUserFail")})]})]})]}),s.jsxs("div",{className:"alert alert-error",children:[s.jsx("p",{children:A}),s.jsx("p",{children:t("friendFeed.messages.loadUserFail")})]}),s.jsx("div",{className:"post-composer",children:s.jsxs("div",{className:"composer-header",children:[s.jsx("div",{className:"user-avatar",children:s.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}})}),s.jsxs("div",{className:"composer-input",children:[s.jsx("textarea",{placeholder:t("friendFeed.ui.inputPlaceholder"),value:b,onChange:e=>q(e.target.value),maxLength:500,disabled:U}),s.jsxs("div",{className:"composer-footer",children:[s.jsxs("span",{className:"char-count",children:[b.length,"/500"]}),s.jsx("button",{onClick:J,disabled:!b.trim()||U,className:"publish-btn",children:t(U?"community.publishing":"community.publish")})]})]})]})}),s.jsx("div",{className:"posts-container",children:w.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.emptyFeed.title")}),s.jsx("p",{children:t("community.emptyFeed.subtitle")})]}):w.map(e=>{var r;return s.jsx(T,{post:e,currentUserId:(r=x.currentUser)==null?void 0:r.uid,onToggleLike:V,onAddComment:X,onDeleteComment:Y,onDeletePost:Z,formatTime:_,likeProcessing:E,commentProcessing:L},e.id)})})]}):s.jsxs("div",{className:"friend-feed-page",children:[s.jsxs("div",{className:"friend-feed-header",children:[s.jsxs("button",{onClick:()=>$("/community"),className:"back-btn",children:["← ",t("community.back")]}),s.jsxs("div",{className:"friend-info",children:[s.jsx("img",{src:(j==null?void 0:j.avatarUrl)||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:e=>{e.target.src="/default-avatar.png"}}),s.jsxs("div",{className:"friend-details",children:[s.jsx("h1",{children:t("friendFeed.ui.pageTitle",{id:(j==null?void 0:j.nickname)||t("community.fallback.user")})}),s.jsx("p",{children:t("friendFeed.ui.inputPlaceholder")})]})]})]}),A&&s.jsx("div",{className:"alert alert-error",children:A}),W&&s.jsx("div",{className:"alert alert-success",children:W}),s.jsx("div",{className:"post-composer",children:s.jsxs("div",{className:"composer-header",children:[s.jsx("div",{className:"user-avatar",children:s.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}})}),s.jsxs("div",{className:"composer-input",children:[s.jsx("textarea",{placeholder:t("friendFeed.ui.inputPlaceholder"),value:b,onChange:e=>q(e.target.value),maxLength:500,disabled:U}),s.jsxs("div",{className:"composer-footer",children:[s.jsxs("span",{className:"char-count",children:[b.length,"/500"]}),s.jsx("button",{onClick:J,disabled:!b.trim()||U,className:"publish-btn",children:t(U?"community.publishing":"community.publish")})]})]})]})}),s.jsx("div",{className:"posts-container",children:w.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.emptyFeed.title")}),s.jsx("p",{children:t("community.emptyFeed.subtitle")})]}):w.map(e=>{var r;return s.jsx(T,{post:e,currentUserId:(r=x.currentUser)==null?void 0:r.uid,onToggleLike:V,onAddComment:X,onDeleteComment:Y,onDeletePost:Z,formatTime:_,likeProcessing:E,commentProcessing:L},e.id)})})]})};export{Se as default};
