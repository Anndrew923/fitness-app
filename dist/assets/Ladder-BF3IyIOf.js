import{b as Q,u as V,d as Z,h as z,a as W,j as e,k as Y}from"./index-B6ByJKnu.js";import{R as ee,u as ae,r as d}from"./react-vendor-Jhh8OXpo.js";import{t as le,q as se,v as te,x as re,y as oe}from"./firebase-lL8zW3tR.js";import"./charts-D1I5GTBR.js";const ne=()=>{var D;const{userData:s}=Q(),b=ae(),{t}=V(),[y,B]=d.useState([]),[g,S]=d.useState(0),[x,E]=d.useState("all"),[h,P]=d.useState("total"),[w,C]=d.useState(!0),[A,F]=d.useState(!1),[u,L]=d.useState(null),[_,H]=d.useState({x:0,y:0});d.useRef(null);const N=d.useRef(null),$=d.useRef(!1),G=d.useRef(!1),R=d.useRef(!1),U=d.useMemo(()=>[{value:"all",label:t("ladder.ageGroups.all")},{value:"under20",label:t("ladder.ageGroups.under20")},{value:"21to30",label:t("ladder.ageGroups.21to30")},{value:"31to40",label:t("ladder.ageGroups.31to40")},{value:"41to50",label:t("ladder.ageGroups.41to50")},{value:"51to60",label:t("ladder.ageGroups.51to60")},{value:"61to70",label:t("ladder.ageGroups.61to70")},{value:"over70",label:t("ladder.ageGroups.over70")},{value:"unknown",label:t("ladder.ageGroups.unknown")}],[t]),k=d.useCallback(async()=>{var c;if(G.current){console.log("🔄 正在載入中，跳過重複請求");return}const a={selectedAgeGroup:x,selectedTab:h,userLadderScore:(s==null?void 0:s.ladderScore)||0};if(!$.current&&N.current&&JSON.stringify(N.current)===JSON.stringify(a)){console.log("🔄 載入參數未變化，跳過重複載入");return}$.current=!1,N.current=a,G.current=!0,C(!0);try{console.log("🚀 開始載入天梯數據...",a);const n=le(se(Z,"users"),te("ladderScore","desc"),re(200)),m=await oe(n);let r=[];if(console.log(`📥 從 Firebase 獲取到 ${m.size} 個文檔`),m.forEach(i=>{var o;const l=i.data();if(l.ladderScore>0){const v=l.isAnonymousInLadder===!0,j={...l,ageGroup:l.age?z(Number(l.age)):l.ageGroup||""};r.push({id:i.id,...j,displayName:v?t("community.fallback.anonymousUser"):l.nickname||((o=l.email)==null?void 0:o.split("@")[0])||t("community.fallback.unnamedUser"),avatarUrl:v?"":l.avatarUrl,isAnonymous:v})}}),console.log(`📊 過濾後有分數的用戶：${r.length} 名`),x!=="all"){const i=r.length;console.log(`🔍 年齡段篩選調試 - 選擇的年齡段: ${x}`),console.log("🔍 年齡段篩選調試 - 篩選前的用戶年齡段分布:",r.reduce((l,o)=>(l[o.ageGroup]=(l[o.ageGroup]||0)+1,l),{})),r=r.filter(l=>{const o=l.ageGroup===x;return o||console.log(`🔍 用戶 ${l.displayName} (年齡: ${l.age}, 年齡段: ${l.ageGroup}) 不符合篩選條件 ${x}`),o}),console.log(`👥 年齡段過濾：${i} → ${r.length} 名用戶`)}if(h==="weekly"){const i=r.length,l=new Date;l.setDate(l.getDate()-7),r=r.filter(o=>o.lastActive?new Date(o.lastActive)>=l:!1),console.log(`📅 本周新進榜過濾：${i} → ${r.length} 名用戶`)}if(r.sort((i,l)=>l.ladderScore-i.ladderScore),r=r.slice(0,50),console.log(`📊 天梯數據載入完成：共 ${r.length} 名用戶，最高分：${((c=r[0])==null?void 0:c.ladderScore)||0}`),B(r),s&&s.ladderScore>0){const i=r.findIndex(l=>{var o;return l.id===s.userId||l.id===((o=W.currentUser)==null?void 0:o.uid)});if(i>=0){const l=i+1;console.log(`🎯 用戶排名：第 ${l} 名`),S(l)}else{console.log("📋 用戶不在前50名內，計算實際排名...");const l=m.docs.map(p=>{const f=p.data();return f.ladderScore>0?{id:p.id,...f,ageGroup:f.age?z(Number(f.age)):f.ageGroup||""}:null}).filter(Boolean);let o=l;if(x!=="all"&&(o=l.filter(p=>p.ageGroup===x)),h==="weekly"){const p=new Date;p.setDate(p.getDate()-7),o=o.filter(f=>f.lastActive?new Date(f.lastActive)>=p:!1)}o.sort((p,f)=>f.ladderScore-p.ladderScore);const v=o.findIndex(p=>{var f;return p.id===s.userId||p.id===((f=W.currentUser)==null?void 0:f.uid)}),j=v>=0?v+1:0;console.log(`🎯 用戶實際排名：第 ${j} 名`),S(j)}}else S(0)}catch(n){console.error("載入天梯數據失敗:",n),console.error("錯誤詳情:",{selectedAgeGroup:x,selectedTab:h,errorCode:n.code,errorMessage:n.message})}finally{C(!1),G.current=!1,R.current=!1}},[x,h,s]);d.useEffect(()=>{var a;s&&!((a=b.state)!=null&&a.forceReload)&&k()},[s,x,h,k,(D=b.state)==null?void 0:D.forceReload]),d.useEffect(()=>{var a;(a=b.state)!=null&&a.forceReload&&s&&!R.current&&(console.log("🔄 檢測到強制重新載入標記，立即重新載入天梯數據"),R.current=!0,window.history.replaceState({},document.title),setTimeout(()=>{$.current=!0,N.current=null,k()},0))},[b.state,s,k]);const q=d.useMemo(()=>()=>({}),[]),X=()=>null,T=a=>a===1?"🥇":a===2?"🥈":a===3?"🥉":a<=10?"🏆":a<=50?"⭐":"",I=d.useCallback(a=>{const c=U.find(n=>n.value===a);return c?c.label:a},[U]),J=d.useMemo(()=>{var n;if(`${s==null?void 0:s.ladderScore}${g}${y.length}${w}`,!s||!s.ladderScore||s.ladderScore===0||g>0&&g<=7||g===0)return null;const a=g,c=T(a);return e.jsx("div",{className:"floating-rank-display","data-rank":a,children:e.jsxs("div",{className:"floating-rank-card",children:[e.jsxs("div",{className:"ladder__rank",children:[e.jsx("span",{className:"ladder__rank-number",children:a}),e.jsx("span",{className:"ladder__rank-badge",children:c})]}),e.jsxs("div",{className:"ladder__user",children:[e.jsxs("div",{className:"ladder__avatar",children:[(()=>{const r=sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":s.avatarUrl;return r&&r.trim()!==""?e.jsx("img",{src:r,alt:t("community.ui.avatarAlt"),loading:"lazy",onError:i=>{console.log("頭像載入失敗，使用預設頭像"),i.target.style.display="none";const l=i.target.nextSibling;l&&(l.style.display="flex")},onLoad:()=>{console.log("頭像載入成功")}}):null})(),e.jsx("div",{className:"ladder__avatar-placeholder",style:{display:(()=>{const r=sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":s.avatarUrl;return r&&r.trim()!==""?"none":"flex"})()},children:s.nickname?s.nickname.charAt(0).toUpperCase():"U"})]}),e.jsxs("div",{className:"ladder__user-info",children:[e.jsx("div",{className:"ladder__user-name current-user-flame",children:s.nickname||((n=s.email)==null?void 0:n.split("@")[0])||"未命名用戶"}),e.jsxs("div",{className:"ladder__user-details",children:[I(s.ageGroup)," •"," ",s.gender==="male"?t("userInfo.male"):t("userInfo.female"),e.jsx("br",{}),e.jsx("span",{className:"last-update",children:"我的排名"})]})]})]}),e.jsxs("div",{className:"ladder__score",children:[e.jsx("span",{className:"ladder__score-value",children:Y(s.ladderScore)}),e.jsx("span",{className:"ladder__score-label",children:t("community.ui.pointsUnit")})]})]})})},[s,g,y.length,w,I]),O=(a,c)=>{if(a.isAnonymous)return;const n=c.currentTarget.getBoundingClientRect(),m=200,r=20,i=y.findIndex(j=>j.id===a.id)===0;let l=n.top-10,o=-100,v={};i?(l=n.bottom,o=0,v={width:"100%",maxWidth:"none",left:"0",transform:"translateX(0) translateY(0)",borderRadius:"0 0 16px 16px",boxShadow:"0 8px 25px rgba(0, 0, 0, 0.3)",zIndex:1001}):n.top-m-r<0&&(l=n.bottom+10,o=0),H({x:n.left+n.width/2,y:l,transformY:o,tooltipStyle:v}),L(a)},M=()=>{L(null)},K=a=>{if(!a)return"未知";const c=a.toDate?a.toDate():new Date(a),m=new Date-c,r=Math.floor(m/(1e3*60)),i=Math.floor(m/(1e3*60*60)),l=Math.floor(m/(1e3*60*60*24));return r<1?"剛剛":r<60?`${r}分鐘前`:i<24?`${i}小時前`:l<7?`${l}天前`:c.toLocaleDateString("zh-TW")};return w?e.jsx("div",{className:"ladder",children:e.jsxs("div",{className:"ladder__loading",children:[e.jsx("div",{className:"ladder__loading-spinner"}),e.jsx("p",{children:t("ladder.loading")})]})}):e.jsxs("div",{className:"ladder",children:[X(),J,e.jsxs("div",{className:"ladder__header",children:[e.jsx("h2",{children:t("ladder.title")}),e.jsxs("div",{className:"ladder__filters",children:[e.jsx("div",{className:"ladder__filter-container",children:e.jsxs("select",{value:h,onChange:a=>P(a.target.value),className:"ladder__filter-select",children:[e.jsx("option",{value:"total",children:t("ladder.filters.total")}),e.jsx("option",{value:"weekly",children:t("ladder.filters.weekly")})]})}),e.jsx("div",{className:"ladder__filter-container",children:e.jsx("select",{value:x,onChange:a=>E(a.target.value),className:"ladder__filter-select",children:U.map(a=>e.jsx("option",{value:a.value,children:t(`ladder.ageGroups.${a.value}`)},a.value))})}),g>50&&e.jsx("button",{className:"ladder__context-btn",onClick:()=>F(!A),children:t(A?"ladder.buttons.showTop50":"ladder.buttons.showMyRange")})]})]}),e.jsxs("div",{className:"ladder__list",children:[A&&g>50&&e.jsx("div",{style:{padding:"8px 16px",background:"linear-gradient(135deg, #ff6b35 0%, #f7931e 100%)",color:"white",borderRadius:"8px 8px 0 0",fontSize:"12px",fontWeight:"600",textAlign:"center"},children:t("ladder.rangeInfo",{start:Math.max(1,g-15),end:g+15})}),y.length===0?e.jsxs("div",{className:"ladder__empty",children:[e.jsx("p",{children:t(h==="weekly"?"ladder.emptyWeekly.title":"ladder.empty.title")}),e.jsx("p",{children:t(h==="weekly"?"ladder.emptyWeekly.subtitle":"ladder.empty.subtitle")})]}):y.slice(0,200).map((a,c)=>e.jsxs("div",{className:`ladder__item ${a.id===(s==null?void 0:s.userId)?"ladder__item--current-user":""} ${a.isAnonymous?"":"clickable"}`,style:{...a.id===(s==null?void 0:s.userId)?{background:"linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(247, 147, 30, 0.1) 100%)",borderLeft:"4px solid #ff6b35",fontWeight:"600"}:{},...q(a,c)},onClick:a.isAnonymous?void 0:n=>O(a,n),title:a.isAnonymous?"":t("ladder.tooltips.viewTraining"),children:[e.jsxs("div",{className:"ladder__rank",children:[e.jsx("span",{className:`ladder__rank-number ${a.id===(s==null?void 0:s.userId)?"rank-changing":""}`,children:c+1}),e.jsx("span",{className:"ladder__rank-badge",children:T(c+1)})]}),e.jsxs("div",{className:"ladder__user",children:[e.jsxs("div",{className:"ladder__avatar",children:[a.avatarUrl&&a.avatarUrl.trim()!==""&&!a.isAnonymous?e.jsx("img",{src:a.avatarUrl,alt:"avatar",loading:"lazy",onError:n=>{console.log("頭像載入失敗，使用預設頭像"),n.target.style.display="none";const m=n.target.nextSibling;m&&(m.style.display="flex")},onLoad:()=>{console.log("頭像載入成功")}}):null,e.jsx("div",{className:`ladder__avatar-placeholder ${a.isAnonymous?"anonymous":""}`,style:{display:a.avatarUrl&&a.avatarUrl.trim()!==""&&!a.isAnonymous?"none":"flex"},children:a.isAnonymous?"👤":a.displayName.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"ladder__user-info",children:[e.jsxs("div",{className:`ladder__user-name ${a.isAnonymous?"anonymous":""} ${a.id===(s==null?void 0:s.userId)?"current-user-flame":""}`,children:[a.displayName,a.isAnonymous&&" 🔒"]}),e.jsx("div",{className:"ladder__user-details",children:a.isAnonymous?"匿名用戶":e.jsxs(e.Fragment,{children:[I(a.ageGroup)," •"," ",a.gender==="male"?t("userInfo.male"):t("userInfo.female"),(a.lastLadderSubmission||a.lastActive)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsxs("span",{className:"last-update",children:[t("ladder.labels.updatedAt")," ",K(a.lastLadderSubmission||a.lastActive)]})]})]})})]})]}),e.jsxs("div",{className:"ladder__score",children:[e.jsx("span",{className:"ladder__score-value",children:Y(a.ladderScore)}),e.jsx("span",{className:"ladder__score-label",children:t("community.ui.pointsUnit")})]})]},a.id))]}),e.jsxs("div",{className:"ladder__footer",children:[h==="weekly"&&e.jsx("p",{style:{fontSize:"12px",color:"#666",marginTop:"8px"},children:"📅 本周新進榜：顯示過去7天內有活動的用戶"}),g>50&&e.jsxs("p",{style:{fontSize:"12px",color:"#666",marginTop:"8px",fontStyle:"italic"},children:["💡 提示：您的排名為第 ",g," ","名，可以點擊上方按鈕查看您附近的競爭對手"]})]}),u&&e.jsxs("div",{className:"training-tooltip",style:{position:"fixed",left:_.x,top:_.y,transform:`translateX(-50%) translateY(${_.transformY||-100}%)`,zIndex:1e3,..._.tooltipStyle},children:[e.jsxs("div",{className:`tooltip-content ${y.findIndex(a=>a.id===u.id)===0?"first-place-glow expanded":""}`,children:[e.jsxs("div",{className:"tooltip-header",children:[e.jsxs("h4",{children:[u.displayName," 的訓練背景"]}),e.jsx("button",{className:"tooltip-close",onClick:M,children:"×"})]}),e.jsxs("div",{className:"tooltip-body",children:[u.profession&&e.jsxs("div",{className:"tooltip-item",children:[e.jsx("span",{className:"tooltip-label",children:"💼 職業："}),e.jsx("span",{className:"tooltip-value",children:u.profession})]}),u.weeklyTrainingHours&&e.jsxs("div",{className:"tooltip-item",children:[e.jsx("span",{className:"tooltip-label",children:"⏰ 每周訓練時數："}),e.jsxs("span",{className:"tooltip-value",children:[u.weeklyTrainingHours," 小時"]})]}),u.trainingYears&&e.jsxs("div",{className:"tooltip-item",children:[e.jsx("span",{className:"tooltip-label",children:"📅 訓練年資："}),e.jsxs("span",{className:"tooltip-value",children:[u.trainingYears," 年"]})]}),!u.profession&&!u.weeklyTrainingHours&&!u.trainingYears&&e.jsxs("div",{className:"tooltip-empty",children:[e.jsx("p",{children:"該用戶尚未填寫訓練背景信息"}),e.jsx("p",{children:"💡 在個人資料頁面填寫訓練背景，激勵其他健身愛好者！"})]})]})]}),e.jsx("div",{className:`tooltip-arrow ${y.findIndex(a=>a.id===u.id)===0?"first-place-arrow expanded":""}`,style:{..._.transformY===0?{bottom:"auto",top:"-8px",borderTop:"none",borderBottom:"8px solid white",...y.findIndex(a=>a.id===u.id)===0&&{left:"50px",transform:"translateX(-50%)"}}:{bottom:"-8px",top:"auto",borderBottom:"none",borderTop:"8px solid white"}}})]}),u&&e.jsx("div",{className:"tooltip-overlay",onClick:M,style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:999}})]})},pe=ee.memo(ne);export{pe as default};
