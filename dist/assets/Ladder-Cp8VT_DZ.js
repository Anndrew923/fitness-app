import{b as Z,u as ee,d as ae,h as z,a as Y,j as e,k as B}from"./index-5Nedhc6b.js";import{R as se,u as le,r as i}from"./react-vendor-Jhh8OXpo.js";import{t as te,q as re,v as oe,x as ne,y as de}from"./firebase-lL8zW3tR.js";import"./charts-D1I5GTBR.js";const ie=()=>{var D;const{userData:l}=Z(),b=le(),{t:r}=ee(),[j,E]=i.useState([]),[g,S]=i.useState(0),[x,H]=i.useState("all"),[h,P]=i.useState("total"),[w,L]=i.useState(!0),[A,F]=i.useState(!1),[f,T]=i.useState(null),[_,q]=i.useState({x:0,y:0});i.useRef(null);const N=i.useRef(null),$=i.useRef(!1),G=i.useRef(!1),R=i.useRef(!1),U=i.useMemo(()=>[{value:"all",label:r("ladder.ageGroups.all")},{value:"under20",label:r("ladder.ageGroups.under20")},{value:"21to30",label:r("ladder.ageGroups.21to30")},{value:"31to40",label:r("ladder.ageGroups.31to40")},{value:"41to50",label:r("ladder.ageGroups.41to50")},{value:"51to60",label:r("ladder.ageGroups.51to60")},{value:"61to70",label:r("ladder.ageGroups.61to70")},{value:"over70",label:r("ladder.ageGroups.over70")},{value:"unknown",label:r("ladder.ageGroups.unknown")}],[r]),k=i.useCallback(async()=>{var m;if(G.current){console.log("🔄 正在載入中，跳過重複請求");return}const a={selectedAgeGroup:x,selectedTab:h,userLadderScore:(l==null?void 0:l.ladderScore)||0};if(!$.current&&N.current&&JSON.stringify(N.current)===JSON.stringify(a)){console.log("🔄 載入參數未變化，跳過重複載入");return}$.current=!1,N.current=a,G.current=!0,L(!0);try{console.log("🚀 開始載入天梯數據...",a);const n=te(re(ae,"users"),oe("ladderScore","desc"),ne(200)),p=await de(n);let t=[];if(console.log(`📥 從 Firebase 獲取到 ${p.size} 個文檔`),p.forEach(d=>{var o;const s=d.data();if(s.ladderScore>0){const y=s.isAnonymousInLadder===!0,v={...s,ageGroup:s.age?z(Number(s.age)):s.ageGroup||""};t.push({id:d.id,...v,displayName:y?r("community.fallback.anonymousUser"):s.nickname||((o=s.email)==null?void 0:o.split("@")[0])||r("community.fallback.unnamedUser"),avatarUrl:y?"":s.avatarUrl,isAnonymous:y})}}),console.log(`📊 過濾後有分數的用戶：${t.length} 名`),x!=="all"){const d=t.length;console.log(`🔍 年齡段篩選調試 - 選擇的年齡段: ${x}`),console.log("🔍 年齡段篩選調試 - 篩選前的用戶年齡段分布:",t.reduce((s,o)=>(s[o.ageGroup]=(s[o.ageGroup]||0)+1,s),{})),t=t.filter(s=>{const o=s.ageGroup===x;return o||console.log(`🔍 用戶 ${s.displayName} (年齡: ${s.age}, 年齡段: ${s.ageGroup}) 不符合篩選條件 ${x}`),o}),console.log(`👥 年齡段過濾：${d} → ${t.length} 名用戶`)}if(h==="weekly"){const d=t.length,s=new Date;s.setDate(s.getDate()-7),t=t.filter(o=>o.lastActive?new Date(o.lastActive)>=s:!1),console.log(`📅 本周新進榜過濾：${d} → ${t.length} 名用戶`)}if(t.sort((d,s)=>s.ladderScore-d.ladderScore),t=t.slice(0,50),console.log(`📊 天梯數據載入完成：共 ${t.length} 名用戶，最高分：${((m=t[0])==null?void 0:m.ladderScore)||0}`),E(t),l&&l.ladderScore>0){const d=t.findIndex(s=>{var o;return s.id===l.userId||s.id===((o=Y.currentUser)==null?void 0:o.uid)});if(d>=0){const s=d+1;console.log(`🎯 用戶排名：第 ${s} 名`),S(s)}else{console.log("📋 用戶不在前50名內，計算實際排名...");const s=p.docs.map(c=>{const u=c.data();return u.ladderScore>0?{id:c.id,...u,ageGroup:u.age?z(Number(u.age)):u.ageGroup||""}:null}).filter(Boolean);let o=s;if(x!=="all"&&(o=s.filter(c=>c.ageGroup===x)),h==="weekly"){const c=new Date;c.setDate(c.getDate()-7),o=o.filter(u=>u.lastActive?new Date(u.lastActive)>=c:!1)}o.sort((c,u)=>u.ladderScore-c.ladderScore);const y=o.findIndex(c=>{var u;return c.id===l.userId||c.id===((u=Y.currentUser)==null?void 0:u.uid)}),v=y>=0?y+1:0;console.log(`🎯 用戶實際排名：第 ${v} 名`),S(v)}}else S(0)}catch(n){console.error("載入天梯數據失敗:",n),console.error("錯誤詳情:",{selectedAgeGroup:x,selectedTab:h,errorCode:n.code,errorMessage:n.message})}finally{L(!1),G.current=!1,R.current=!1}},[x,h,l]);i.useEffect(()=>{var a;l&&!((a=b.state)!=null&&a.forceReload)&&k()},[l,x,h,k,(D=b.state)==null?void 0:D.forceReload]),i.useEffect(()=>{var a;(a=b.state)!=null&&a.forceReload&&l&&!R.current&&(console.log("🔄 檢測到強制重新載入標記，立即重新載入天梯數據"),R.current=!0,window.history.replaceState({},document.title),setTimeout(()=>{$.current=!0,N.current=null,k()},0))},[b.state,l,k]);const X=i.useMemo(()=>()=>({}),[]),J=()=>null,M=a=>a===1?"🥇":a===2?"🥈":a===3?"🥉":a<=10?"🏆":a<=50?"⭐":"",I=i.useCallback(a=>{const m=U.find(n=>n.value===a);return m?m.label:a},[U]),O=i.useMemo(()=>{var n;if(`${l==null?void 0:l.ladderScore}${g}${j.length}${w}`,!l||!l.ladderScore||l.ladderScore===0||g>0&&g<=7||g===0)return null;const a=g,m=M(a);return e.jsx("div",{className:"floating-rank-display","data-rank":a,children:e.jsxs("div",{className:"floating-rank-card",children:[e.jsxs("div",{className:"ladder__rank",children:[e.jsx("span",{className:"ladder__rank-number",children:a}),e.jsx("span",{className:"ladder__rank-badge",children:m})]}),e.jsxs("div",{className:"ladder__user",children:[e.jsxs("div",{className:"ladder__avatar",children:[(()=>{const t=sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":l.avatarUrl;return t&&t.trim()!==""?e.jsx("img",{src:t,alt:r("community.ui.avatarAlt"),loading:"lazy",onError:d=>{console.log("頭像載入失敗，使用預設頭像"),d.target.style.display="none";const s=d.target.nextSibling;s&&(s.style.display="flex")},onLoad:()=>{console.log("頭像載入成功")}}):null})(),e.jsx("div",{className:"ladder__avatar-placeholder",style:{display:(()=>{const t=sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":l.avatarUrl;return t&&t.trim()!==""?"none":"flex"})()},children:l.nickname?l.nickname.charAt(0).toUpperCase():"U"})]}),e.jsxs("div",{className:"ladder__user-info",children:[e.jsx("div",{className:"ladder__user-name current-user-flame",children:l.nickname||((n=l.email)==null?void 0:n.split("@")[0])||"未命名用戶"}),e.jsxs("div",{className:"ladder__user-details",children:[I(l.ageGroup)," •"," ",l.gender==="male"?r("userInfo.male"):r("userInfo.female"),e.jsx("br",{}),e.jsx("span",{className:"last-update",children:"我的排名"})]})]})]}),e.jsxs("div",{className:"ladder__score",children:[e.jsx("span",{className:"ladder__score-value",children:B(l.ladderScore)}),e.jsx("span",{className:"ladder__score-label",children:r("community.ui.pointsUnit")})]})]})})},[l,g,j.length,w,I]),K=(a,m)=>{if(a.isAnonymous)return;const n=m.currentTarget.getBoundingClientRect(),p=200,t=350,d=window.innerWidth,s=window.innerHeight,o=20,y=j.findIndex(V=>V.id===a.id)===0;let v=n.left+n.width/2,c=n.top-10,u=-100,C={};v-t/2<o?v=t/2+o:v+t/2>d-o&&(v=d-t/2-o),y?(c=n.bottom,u=0,C={width:"100%",maxWidth:"none",left:"0",transform:"translateX(0) translateY(0)",borderRadius:"0 0 16px 16px",boxShadow:"0 8px 25px rgba(0, 0, 0, 0.3)",zIndex:1001}):(n.top-p-o<0&&(c=n.bottom+10,u=0),c+p>s-o&&(c=n.top-p-10,u=-100)),q({x:v,y:c,transformY:u,tooltipStyle:C}),T(a)},W=()=>{T(null)},Q=a=>{if(!a)return"未知";const m=a.toDate?a.toDate():new Date(a),p=new Date-m,t=Math.floor(p/(1e3*60)),d=Math.floor(p/(1e3*60*60)),s=Math.floor(p/(1e3*60*60*24));return t<1?"剛剛":t<60?`${t}分鐘前`:d<24?`${d}小時前`:s<7?`${s}天前`:m.toLocaleDateString("zh-TW")};return w?e.jsx("div",{className:"ladder",children:e.jsxs("div",{className:"ladder__loading",children:[e.jsx("div",{className:"ladder__loading-spinner"}),e.jsx("p",{children:r("ladder.loading")})]})}):e.jsxs("div",{className:"ladder",children:[J(),O,e.jsxs("div",{className:"ladder__header",children:[e.jsx("h2",{children:r("ladder.title")}),e.jsxs("div",{className:"ladder__filters",children:[e.jsx("div",{className:"ladder__filter-container",children:e.jsxs("select",{value:h,onChange:a=>P(a.target.value),className:"ladder__filter-select",children:[e.jsx("option",{value:"total",children:r("ladder.filters.total")}),e.jsx("option",{value:"weekly",children:r("ladder.filters.weekly")})]})}),e.jsx("div",{className:"ladder__filter-container",children:e.jsx("select",{value:x,onChange:a=>H(a.target.value),className:"ladder__filter-select",children:U.map(a=>e.jsx("option",{value:a.value,children:r(`ladder.ageGroups.${a.value}`)},a.value))})}),g>50&&e.jsx("button",{className:"ladder__context-btn",onClick:()=>F(!A),children:r(A?"ladder.buttons.showTop50":"ladder.buttons.showMyRange")})]})]}),e.jsxs("div",{className:"ladder__list",children:[A&&g>50&&e.jsx("div",{style:{padding:"8px 16px",background:"linear-gradient(135deg, #ff6b35 0%, #f7931e 100%)",color:"white",borderRadius:"8px 8px 0 0",fontSize:"12px",fontWeight:"600",textAlign:"center"},children:r("ladder.rangeInfo",{start:Math.max(1,g-15),end:g+15})}),j.length===0?e.jsxs("div",{className:"ladder__empty",children:[e.jsx("p",{children:r(h==="weekly"?"ladder.emptyWeekly.title":"ladder.empty.title")}),e.jsx("p",{children:r(h==="weekly"?"ladder.emptyWeekly.subtitle":"ladder.empty.subtitle")})]}):j.slice(0,200).map((a,m)=>e.jsxs("div",{className:`ladder__item ${a.id===(l==null?void 0:l.userId)?"ladder__item--current-user":""} ${a.isAnonymous?"":"clickable"}`,style:{...a.id===(l==null?void 0:l.userId)?{background:"linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(247, 147, 30, 0.1) 100%)",borderLeft:"4px solid #ff6b35",fontWeight:"600"}:{},...X(a,m)},onClick:a.isAnonymous?void 0:n=>K(a,n),title:a.isAnonymous?"":r("ladder.tooltips.viewTraining"),children:[e.jsxs("div",{className:"ladder__rank",children:[e.jsx("span",{className:`ladder__rank-number ${a.id===(l==null?void 0:l.userId)?"rank-changing":""}`,children:m+1}),e.jsx("span",{className:"ladder__rank-badge",children:M(m+1)})]}),e.jsxs("div",{className:"ladder__user",children:[e.jsxs("div",{className:"ladder__avatar",children:[a.avatarUrl&&a.avatarUrl.trim()!==""&&!a.isAnonymous?e.jsx("img",{src:a.avatarUrl,alt:"avatar",loading:"lazy",onError:n=>{console.log("頭像載入失敗，使用預設頭像"),n.target.style.display="none";const p=n.target.nextSibling;p&&(p.style.display="flex")},onLoad:()=>{console.log("頭像載入成功")}}):null,e.jsx("div",{className:`ladder__avatar-placeholder ${a.isAnonymous?"anonymous":""}`,style:{display:a.avatarUrl&&a.avatarUrl.trim()!==""&&!a.isAnonymous?"none":"flex"},children:a.isAnonymous?"👤":a.displayName.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"ladder__user-info",children:[e.jsxs("div",{className:`ladder__user-name ${a.isAnonymous?"anonymous":""} ${a.id===(l==null?void 0:l.userId)?"current-user-flame":""}`,children:[a.displayName,a.isAnonymous&&" 🔒"]}),e.jsx("div",{className:"ladder__user-details",children:a.isAnonymous?"匿名用戶":e.jsxs(e.Fragment,{children:[I(a.ageGroup)," •"," ",a.gender==="male"?r("userInfo.male"):r("userInfo.female"),(a.lastLadderSubmission||a.lastActive)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsxs("span",{className:"last-update",children:[r("ladder.labels.updatedAt")," ",Q(a.lastLadderSubmission||a.lastActive)]})]})]})})]})]}),e.jsxs("div",{className:"ladder__score",children:[e.jsx("span",{className:"ladder__score-value",children:B(a.ladderScore)}),e.jsx("span",{className:"ladder__score-label",children:r("community.ui.pointsUnit")})]})]},a.id))]}),e.jsxs("div",{className:"ladder__footer",children:[h==="weekly"&&e.jsx("p",{style:{fontSize:"12px",color:"#666",marginTop:"8px"},children:"📅 本周新進榜：顯示過去7天內有活動的用戶"}),g>50&&e.jsxs("p",{style:{fontSize:"12px",color:"#666",marginTop:"8px",fontStyle:"italic"},children:["💡 提示：您的排名為第 ",g," ","名，可以點擊上方按鈕查看您附近的競爭對手"]})]}),f&&e.jsxs("div",{className:"training-tooltip",style:{position:"fixed",left:_.x,top:_.y,transform:`translateX(-50%) translateY(${_.transformY||-100}%)`,zIndex:1e3,..._.tooltipStyle},children:[e.jsxs("div",{className:`tooltip-content ${j.findIndex(a=>a.id===f.id)===0?"first-place-glow expanded":""}`,children:[e.jsxs("div",{className:"tooltip-header",children:[e.jsxs("h4",{children:[f.displayName," 的訓練背景"]}),e.jsx("button",{className:"tooltip-close",onClick:W,children:"×"})]}),e.jsxs("div",{className:"tooltip-body",children:[f.profession&&e.jsxs("div",{className:"tooltip-item",children:[e.jsx("span",{className:"tooltip-label",children:"💼 職業："}),e.jsx("span",{className:"tooltip-value",children:f.profession})]}),f.weeklyTrainingHours&&e.jsxs("div",{className:"tooltip-item",children:[e.jsx("span",{className:"tooltip-label",children:"⏰ 每周訓練時數："}),e.jsxs("span",{className:"tooltip-value",children:[f.weeklyTrainingHours," 小時"]})]}),f.trainingYears&&e.jsxs("div",{className:"tooltip-item",children:[e.jsx("span",{className:"tooltip-label",children:"📅 訓練年資："}),e.jsxs("span",{className:"tooltip-value",children:[f.trainingYears," 年"]})]}),!f.profession&&!f.weeklyTrainingHours&&!f.trainingYears&&e.jsxs("div",{className:"tooltip-empty",children:[e.jsx("p",{children:"該用戶尚未填寫訓練背景信息"}),e.jsx("p",{children:"💡 在個人資料頁面填寫訓練背景，激勵其他健身愛好者！"})]})]})]}),e.jsx("div",{className:`tooltip-arrow ${j.findIndex(a=>a.id===f.id)===0?"first-place-arrow expanded":""}`,style:{..._.transformY===0?{bottom:"auto",top:"-8px",borderTop:"none",borderBottom:"8px solid white",...j.findIndex(a=>a.id===f.id)===0&&{left:"50px",transform:"translateX(-50%)"}}:{bottom:"-8px",top:"auto",borderBottom:"none",borderTop:"8px solid white"}}})]}),f&&e.jsx("div",{className:"tooltip-overlay",onClick:W,style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:999}})]})},fe=se.memo(ie);export{fe as default};
