import{u as P,a as B,b as g,_ as D,r as U,s as L,l as R,d as _,j as e,P as E,B as I}from"./index-u_ODcrAP.js";import{d as W,r as o}from"./react-vendor-BToktFYo.js";import{D as A,l as O,E as z}from"./firebase-D0136ThQ.js";import{L as F}from"./LanguageSwitcher-tb8l1i19.js";import"./charts-BNGpwEcn.js";function $(){const r=W(),{userData:N,clearUserData:p}=P(),[y,d]=o.useState(!1),[u,x]=o.useState(!1),[h,s]=o.useState(""),{t}=B(),m=o.useMemo(()=>!!g.currentUser,[]),f=o.useCallback(()=>{d(!0)},[]),v=o.useCallback(()=>{localStorage.removeItem("privacyAcceptedV1"),d(!0),s(t("settings.msgResetConsent"))},[]),j=o.useCallback(async()=>{try{if("serviceWorker"in navigator){const i=await navigator.serviceWorker.getRegistration();if(i){await i.update(),s(t("settings.msgCheckedUpdate"));return}}s(t("settings.msgNoSW"))}catch{s(t("settings.msgCheckUpdateFail"))}},[]),w=o.useCallback(()=>{try{const i=localStorage.getItem("userData"),c=new Blob([i||"{}"],{type:"application/json"}),l=URL.createObjectURL(c),a=document.createElement("a");a.href=l,a.download="userData.json",a.click(),URL.revokeObjectURL(l)}catch{s(t("settings.msgExportFail"))}},[]),S=o.useCallback(()=>{try{localStorage.removeItem("userData"),localStorage.removeItem("lastSavedUserData"),localStorage.removeItem("ladderSubmissionState"),s(t("settings.msgClearedLocal"))}catch{s(t("settings.msgClearFail"))}},[]),b=o.useCallback(async()=>{var l;if(!m){s(t("settings.msgPleaseLogin")),r("/login");return}if(!window.confirm(t("settings.deleteConfirm")))return;const c=window.prompt(t("settings.passwordPrompt"));if(!c||c.trim()===""){s("");return}try{const a=(l=g.currentUser)==null?void 0:l.email;if(!a)throw new Error(t("settings.msgNeedRelogin"));const{signInWithEmailAndPassword:n}=await D(async()=>{const{signInWithEmailAndPassword:C}=await import("./firebase-D0136ThQ.js").then(k=>k.K);return{signInWithEmailAndPassword:C}},[]);await n(g,a,c)}catch{s(t("settings.msgPasswordVerifyFail")),r("/login");return}x(!0),s(t("settings.msgDeleting"));try{const a=g.currentUser.uid;try{const n=U(L,`avatars/${a}/avatar.jpg`);await R(n)}catch{}try{await A(O(_,"users",a))}catch{}try{await z(g.currentUser)}catch(n){if((n==null?void 0:n.code)==="auth/requires-recent-login"){s(t("settings.msgNeedReloginToDelete")),r("/login");return}throw n}p(),s(t("settings.msgDeleted")),r("/")}catch{s(t("settings.msgDeleteFail"))}finally{x(!1)}},[m,r,p]);return e.jsxs("div",{style:{padding:"16px",paddingBottom:"96px"},children:[e.jsx("h1",{style:{fontSize:"20px",fontWeight:700,marginBottom:"12px"},children:t("settings.title")}),h&&e.jsx("div",{style:{marginBottom:"12px",color:"#2d6a4f"},children:h}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.privacySection")}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:f,children:t("settings.viewPrivacy")}),e.jsx("button",{onClick:v,children:t("settings.resetConsent")}),e.jsx("button",{onClick:w,children:t("settings.exportLocal")}),e.jsx("button",{onClick:S,children:t("settings.clearLocal")})]})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.languageSection")}),e.jsx(F,{})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.pwaSection")}),e.jsx("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:e.jsx("button",{onClick:j,children:t("settings.checkUpdate")})})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.dataSection")}),e.jsxs("div",{style:{color:"#555",marginBottom:"8px"},children:[t("settings.loginStatus"),"ï¼š",t(m?"common.loggedIn":"common.loggedOut")]}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>r("/privacy-policy"),children:t("settings.toPrivacyPage")}),m&&e.jsx("button",{onClick:b,disabled:u,children:t(u?"common.deleting":"settings.deleteAccountDanger")})]})]}),e.jsx(E,{isOpen:y,onClose:()=>d(!1),onAccept:()=>{localStorage.setItem("privacyAcceptedV1","true"),d(!1),s("")}}),e.jsx(I,{})]})}export{$ as default};
