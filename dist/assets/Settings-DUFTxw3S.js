import{b as U,u as L,a as d,_ as R,r as E,s as I,l as W,d as A,j as e,B as _}from"./index-CN-OsEeC.js";import{d as O,r as i}from"./react-vendor-BToktFYo.js";import{D as z,l as F,E as N}from"./firebase-D0136ThQ.js";import{P as T}from"./PrivacyPolicyModal-Dc5HQ3Fl.js";import{L as V}from"./LanguageSwitcher-h5a5pQY7.js";import"./charts-BNGpwEcn.js";function H(){const r=O(),{clearUserData:p}=U(),[v,m]=i.useState(!1),[h,x]=i.useState(!1),[y,a]=i.useState(""),{t,i18n:f}=L(),j=f.language&&f.language.toLowerCase().startsWith("zh"),g=(n,c,l)=>{const s=t(n);return s===n?j?c:l:s},u=i.useMemo(()=>!!d.currentUser,[]),w=i.useCallback(()=>{m(!0)},[]),b=i.useCallback(()=>{localStorage.removeItem("privacyAcceptedV1"),m(!0),a(t("settings.msgResetConsent"))},[]),C=i.useCallback(async()=>{try{if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistration();if(n){await n.update(),a(t("settings.msgCheckedUpdate"));return}}a(t("settings.msgNoSW"))}catch(n){console.error("檢查更新失敗:",n),a(t("settings.msgCheckUpdateFail"))}},[]),S=i.useCallback(()=>{try{const n=localStorage.getItem("userData"),c=new Blob([n||"{}"],{type:"application/json"}),l=URL.createObjectURL(c),s=document.createElement("a");s.href=l,s.download="userData.json",s.click(),URL.revokeObjectURL(l)}catch(n){console.error("導出數據失敗:",n),a(t("settings.msgExportFail"))}},[]),k=i.useCallback(()=>{try{localStorage.removeItem("userData"),localStorage.removeItem("lastSavedUserData"),localStorage.removeItem("ladderSubmissionState"),a(t("settings.msgClearedLocal"))}catch(n){console.error("清除數據失敗:",n),a(t("settings.msgClearFail"))}},[]),P=i.useCallback(async()=>{var l;if(!u){a(t("settings.msgPleaseLogin")),r("/login");return}if(!window.confirm(t("settings.deleteConfirm")))return;const c=window.prompt(t("settings.passwordPrompt"));if(!c||c.trim()===""){a("");return}try{const s=(l=d.currentUser)==null?void 0:l.email;if(!s)throw new Error(t("settings.msgNeedRelogin"));const{signInWithEmailAndPassword:o}=await R(async()=>{const{signInWithEmailAndPassword:B}=await import("./firebase-D0136ThQ.js").then(D=>D.K);return{signInWithEmailAndPassword:B}},[]);await o(d,s,c)}catch(s){console.error("密碼驗證失敗:",s),a(t("settings.msgPasswordVerifyFail")),r("/login");return}x(!0),a(t("settings.msgDeleting"));try{const s=d.currentUser.uid;try{const o=E(I,`avatars/${s}/avatar.jpg`);await W(o)}catch(o){console.warn("刪除頭像失敗:",o)}try{await z(F(A,"users",s))}catch(o){console.warn("刪除用戶文檔失敗:",o)}try{await N(d.currentUser)}catch(o){if((o==null?void 0:o.code)==="auth/requires-recent-login"){a(t("settings.msgNeedReloginToDelete")),r("/login");return}throw o}p(),a(t("settings.msgDeleted")),r("/")}catch(s){console.error("刪除帳號失敗:",s),a(t("settings.msgDeleteFail"))}finally{x(!1)}},[u,r,p]);return e.jsxs("div",{style:{padding:"16px",paddingBottom:"96px"},children:[e.jsx("h1",{style:{fontSize:"20px",fontWeight:700,marginBottom:"12px"},children:t("settings.title")}),y&&e.jsx("div",{style:{marginBottom:"12px",color:"#2d6a4f"},children:y}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.privacySection")}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:w,children:t("settings.viewPrivacy")}),e.jsx("button",{onClick:b,children:t("settings.resetConsent")}),e.jsx("button",{onClick:S,children:t("settings.exportLocal")}),e.jsx("button",{onClick:k,children:t("settings.clearLocal")})]})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.languageSection")}),e.jsx(V,{})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.pwaSection")}),e.jsx("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:e.jsx("button",{onClick:C,children:t("settings.checkUpdate")})})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.dataSection")}),e.jsxs("div",{style:{color:"#555",marginBottom:"8px"},children:[t("settings.loginStatus"),"：",t(u?"common.loggedIn":"common.loggedOut")]}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>r("/privacy-policy"),children:t("settings.toPrivacyPage")}),e.jsx("button",{onClick:()=>r("/terms"),children:g("navigation.terms","使用條款","Terms")}),e.jsx("button",{onClick:()=>r("/features"),children:g("navigation.features","功能介紹","Features")}),e.jsx("button",{onClick:()=>r("/about"),children:g("navigation.about","關於","About")}),e.jsx("button",{onClick:()=>r("/disclaimer"),children:g("navigation.disclaimer","免責聲明","Disclaimer")}),e.jsx("button",{onClick:()=>r("/contact"),children:g("navigation.contact","聯絡我們","Contact")}),u&&e.jsx("button",{onClick:P,disabled:h,children:t(h?"common.deleting":"settings.deleteAccountDanger")})]})]}),e.jsx(T,{isOpen:v,onClose:()=>m(!1),onAccept:()=>{localStorage.setItem("privacyAcceptedV1","true"),m(!1),a("")}}),e.jsx(_,{})]})}export{H as default};
