import{a as R,j as e,b as u,d as j}from"./index-BRHfcysQ.js";import{r as c,d as H,u as B}from"./react-vendor-BToktFYo.js";import{G as W,A as $,l as L,m as _,s as M,B as J,n as K}from"./firebase-D0136ThQ.js";import{P as w}from"./charts-BNGpwEcn.js";import{P as Q}from"./PrivacyPolicyModal-JpWVKZBj.js";function E({onLogin:S,onError:r}){const[h,d]=c.useState(!1),{t:m}=R(),p=async()=>{d(!0);try{const i=new W;i.setCustomParameters({prompt:"select_account"});const l=(await $(u,i)).user;console.log("Google 登入成功:",l.email);const g=L(j,"users",l.uid);if(!(await _(g)).exists()){const y={email:l.email,userId:l.uid,nickname:l.displayName||l.email.split("@")[0],avatarUrl:l.photoURL||"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:0,weight:0,age:0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};await M(g,y),console.log("新用戶資料已創建")}S(l.email,null)}catch(i){console.error("Google 登入失敗:",i);let a="登入失敗";i.code==="auth/popup-closed-by-user"?a="登入視窗被關閉，請重試":i.code==="auth/popup-blocked"?a="彈出視窗被阻擋，請允許彈出視窗後重試":i.code==="auth/account-exists-with-different-credential"?a="此電子郵件已被其他方式註冊，請使用原註冊方式登入":a=`登入失敗：${i.message}`,r(a)}finally{d(!1)}};return e.jsxs("div",{className:"social-login-container",children:[e.jsx("div",{className:"divider",children:e.jsx("span",{children:m("common.or")})}),e.jsx("div",{className:"social-buttons",children:e.jsxs("button",{type:"button",className:"social-btn google-btn",onClick:p,disabled:h,children:[e.jsxs("svg",{className:"google-icon",viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),m(h?"login.processing":"login.google")]})})]})}E.propTypes={onLogin:w.func.isRequired,onError:w.func.isRequired};function X({onLogin:S}){const[r,h]=c.useState(""),[d,m]=c.useState(""),[p,i]=c.useState(null),[a,l]=c.useState(!1),[g,f]=c.useState(!1),[y,b]=c.useState(!1),[D,A]=c.useState(!1),v=H(),T=B(),{t,i18n:I}=R(),U=s=>{const o=s.target.validity;o.valueMissing?s.target.setCustomValidity(t("errors.emailRequired")):o.typeMismatch?s.target.setCustomValidity(t("errors.emailInvalid")):s.target.setCustomValidity(t("errors.invalidFormat"))},q=s=>{const o=s.target.validity;o.valueMissing?s.target.setCustomValidity(t("errors.passwordRequired")):o.tooShort?s.target.setCustomValidity(t("errors.passwordTooShort")):s.target.setCustomValidity(t("errors.invalidFormat"))},{height:P,weight:N,age:C}=T.state||{};c.useEffect(()=>{if(console.log("檢查 auth 初始化狀態:",u),!u){i("Firebase 未正確初始化，請檢查配置");return}const s=u.onAuthStateChanged(x=>{x&&(console.log("用戶已登入:",x.email),v("/user-info"))}),o=localStorage.getItem("savedEmail"),n=localStorage.getItem("savedPassword");return o&&n&&(console.log("從 localStorage 恢復帳號:",o),h(o),m(n),b(!0)),()=>s()},[v]);const V=async s=>{s.preventDefault(),i(null),await F()},F=async()=>{if(f(!0),console.log("開始處理表單提交，isRegistering:",a,"email:",r),!u||!j){i("Firebase 未正確初始化，請檢查配置"),console.error("auth 或 db 未初始化:",{auth:u,db:j}),f(!1);return}try{let s;if(a){console.log("嘗試註冊用戶:",r),s=await J(u,r,d);const n=s.user;console.log("註冊成功，用戶:",n.email,"UID:",n.uid);const x=L(j,"users",n.uid),k={email:n.email,userId:n.uid,nickname:n.email.split("@")[0],avatarUrl:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:P?parseFloat(P):0,weight:N?parseFloat(N):0,age:C?parseInt(C,10):0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};console.log("儲存初始用戶數據:",k),await M(x,k),console.log("用戶數據已儲存，文檔 ID:",n.uid)}else console.log("嘗試登入用戶:",r),s=await K(u,r,d),console.log("登入成功，用戶:",s.user.email,"UID:",s.user.uid);const o=s.user;S(o.email,d),y?(console.log("儲存帳號到 localStorage:",r),localStorage.setItem("savedEmail",r),localStorage.setItem("savedPassword",d)):(console.log("清除 localStorage 中的帳號"),localStorage.removeItem("savedEmail"),localStorage.removeItem("savedPassword")),setTimeout(()=>{console.log("導航到 /user-info"),v("/user-info")},500)}catch(s){console.error("登入/註冊失敗:",s.code,s.message),i(`發生錯誤：${s.message} (代碼: ${s.code})`)}finally{f(!1)}},G=()=>{console.log("社交登入成功，導航到 /user-info"),v("/user-info")},O=s=>{i(s)},z=()=>{localStorage.setItem("privacyPolicyViewed","true")};return e.jsxs("div",{className:"login-container",children:[e.jsx("h1",{className:"text-2xl font-bold text-center mb-6",children:t(a?"login.register":"login.login")}),p&&e.jsx("p",{className:"error-message",children:p}),e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.email")}),e.jsx("input",{type:"email",value:r,onChange:s=>h(s.target.value),placeholder:t("login.emailPlaceholder"),className:"input-field",required:!0,onInvalid:U,onInput:s=>s.currentTarget.setCustomValidity(""),disabled:g})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.password")}),e.jsx("input",{type:"password",value:d,onChange:s=>m(s.target.value),placeholder:t("login.passwordPlaceholder"),className:"input-field",required:!0,minLength:6,onInvalid:q,onInput:s=>s.currentTarget.setCustomValidity(""),disabled:g})]}),e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"flex-end",marginBottom:"8px"},children:e.jsxs("label",{htmlFor:"rememberMe",style:{display:"flex",alignItems:"center",cursor:"pointer",whiteSpace:"nowrap",fontSize:"14px",color:"#555"},children:[e.jsx("input",{id:"rememberMe",type:"checkbox",checked:y,onChange:s=>b(s.target.checked),disabled:g,style:{margin:0}}),e.jsx("span",{style:{marginLeft:"6px"},children:t("login.rememberMe")})]})}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:g,children:t(g?"common.loading":a?"login.register":"login.login")})]}),e.jsx("button",{onClick:()=>l(!a),className:"toggle-btn",children:t(a?"login.switchToLogin":"login.switchToRegister")}),e.jsx("div",{className:"privacy-notice",children:I.language&&I.language.toLowerCase().startsWith("zh")?e.jsxs("p",{children:["若繼續操作，即表示你同意最強肉體",e.jsx("a",{className:"privacy-link",href:"/terms",children:"使用條款"}),"。請參閱我們的",e.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"隱私權政策"}),"。"]}):e.jsxs("p",{children:["By continuing, you agree to the Ultimate Physique",e.jsx("a",{className:"privacy-link",href:"/terms",children:"Terms of Service"}),". Please review our",e.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"Privacy Policy"}),"."]})}),e.jsx(E,{onLogin:G,onError:O}),e.jsxs("div",{className:"instructions-container",children:[e.jsx("h2",{className:"instructions-title",children:t("login.instructions.title")}),e.jsxs("ul",{className:"instructions-list",children:[e.jsxs("li",{children:[e.jsx("strong",{children:t("login.instructions.items.fair.title")}),"：",t("login.instructions.items.fair.desc")]}),e.jsxs("li",{children:[e.jsx("strong",{children:t("login.instructions.items.analysis.title")}),"：",t("login.instructions.items.analysis.desc")]}),e.jsxs("li",{children:[e.jsx("strong",{children:t("login.instructions.items.tracking.title")}),"：",t("login.instructions.items.tracking.desc")]})]})]}),e.jsx(Q,{isOpen:D,onClose:()=>A(!1),onAccept:z})]})}X.propTypes={onLogin:w.func.isRequired};export{X as default};
