import{u as Ye,a as Oe,b as v,d as b,m as E,j as e}from"./index-Cpfbo24J.js";import{d as Ze,r as u,R as es}from"./react-vendor-BToktFYo.js";import{t as z,q as M,v as ss,x as ts,y as D,m as ne,l as A,s as pe,D as Te,w as $,H as Me,z as ie,I as ns,J as is}from"./firebase-D0136ThQ.js";import{p as Ee}from"./commentLimiter-CQkE7LZd.js";import{P as k}from"./charts-BNGpwEcn.js";const ms=()=>{var we,be,Ce,Ue,ke,Re,Se,Pe,Fe,Ie,Ae,$e,qe;const p=Ze(),{userData:t,setUserData:J}=Ye(),{t:n,i18n:re}=Oe(),[F,Q]=u.useState("feed"),[I,R]=u.useState([]),[G,N]=u.useState(!0),[O,h]=u.useState(""),[_,P]=u.useState(""),[H,V]=u.useState(""),[X,ae]=u.useState(!1),[i,Y]=u.useState([]),[L,ce]=u.useState([]),[q,U]=u.useState(""),[Z,ee]=u.useState([]),[se,oe]=u.useState(new Set),[fe,Ne]=u.useState(new Set),te=u.useRef(new Map),W=u.useRef(!1),le=u.useRef(!1),me=u.useRef(!1),de=u.useRef(new Map),ue=u.useRef(0),ye=300*1e3,ge=u.useRef(new Map),ve=u.useRef(new Map),T=u.useMemo(()=>{var s;return(s=v.currentUser)==null?void 0:s.uid},[(we=v.currentUser)==null?void 0:we.uid]);u.useMemo(()=>{const s=(t==null?void 0:t.friends)||[];return[T,...s].filter(Boolean)},[T,t==null?void 0:t.friends]),u.useMemo(()=>q.trim()?I.filter(s=>s.content.toLowerCase().includes(q.toLowerCase())||s.userNickname.toLowerCase().includes(q.toLowerCase())):I,[I,q]);const he=u.useCallback(async()=>{if(!v.currentUser||!t){console.log("🚫 用戶未登入或資料未載入，跳過載入動態");return}const s=Date.now(),r=de.current.get("posts");if(r&&s-r.timestamp<ye){console.log("📦 使用快取動態數據"),R(r.data);return}if(le.current&&s-ue.current<ye){console.log("⏰ 動態數據仍在有效期限內，跳過重新載入");return}console.log("🔄 開始載入動態..."),N(!0),h("");try{const c=(t==null?void 0:t.friends)||[],d=[T,...c].filter(Boolean);console.log(`🔍 當前用戶ID: ${T}`),console.log(`🔍 好友列表: ${c.join(", ")}`),console.log(`🔍 允許查看的用戶: ${d.join(", ")}`),console.log(`🔍 總共 ${d.length} 個用戶的動態需要載入`);const o=z(M(b,"communityPosts"),ss("timestamp","desc"),ts(50)),a=await D(o),g=[],w=[];a.forEach(y=>{const j=y.data(),C={id:y.id,userId:j.userId,userNickname:j.userNickname,userAvatarUrl:j.userAvatarUrl,content:j.content,timestamp:j.timestamp,likes:j.likes||[],commentCount:(j.comments||[]).length,comments:[],type:j.type||"status",targetUserId:j.targetUserId};j.targetUserId?w.push(C):d.includes(j.userId)&&g.push(C)});const l=Array.from(new Set(w.map(y=>y.targetUserId).filter(Boolean))).filter(y=>!ge.current.has(y));l.length>0&&await Promise.all(l.map(async y=>{var j;try{const C=await ne(A(b,"users",y)),S=C.exists()?C.data():null,xe=Array.isArray(S==null?void 0:S.friends)?S.friends:[];ge.current.set(y,xe),ve.current.set(y,{nickname:(S==null?void 0:S.nickname)||((j=S==null?void 0:S.email)==null?void 0:j.split("@")[0])||n("community.fallback.user"),avatarUrl:(S==null?void 0:S.avatarUrl)||""})}catch(C){console.warn("讀取目標用戶好友失敗:",y,C),ge.current.set(y,[]),ve.current.set(y,{nickname:n("community.fallback.user"),avatarUrl:""})}}));const m=w.filter(y=>T===y.userId||T===y.targetUserId?!0:(ge.current.get(y.targetUserId)||[]).includes(T)).map(y=>{var j;return{...y,targetUserNickname:((j=ve.current.get(y.targetUserId))==null?void 0:j.nickname)||""}}),x=[...g,...m];x.sort((y,j)=>{const C=y.timestamp?new Date(y.timestamp):new Date(y.date);return(j.timestamp?new Date(j.timestamp):new Date(j.date))-C});const f=x.slice(0,30);console.log(`📊 載入完成：共 ${f.length} 條動態`),R(f),le.current=!0,ue.current=s,de.current.set("posts",{data:f,timestamp:s})}catch(c){console.error("載入動態失敗:",c),h(n("community.messages.loadFeedError"))}finally{N(!1)}},[t==null?void 0:t.friends,ye]),Be=async()=>{var s;if(!H.trim()){h(n("community.messages.emptyPost"));return}if(!v.currentUser){h(n("community.messages.needLogin"));return}try{ae(!0),console.log("📝 準備發布動態...");const r={userId:v.currentUser.uid,userNickname:(t==null?void 0:t.nickname)||((s=t==null?void 0:t.email)==null?void 0:s.split("@")[0])||n("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(t==null?void 0:t.avatarUrl)||"",content:H.trim(),type:"status",likes:[],comments:[],timestamp:new Date().toISOString(),privacy:"friends"},c=await Me(M(b,"communityPosts"),r);E.logWrite("addDoc","communityPosts",c.id),console.log("✅ 動態發布成功，ID:",c.id);const d={id:c.id,...r};console.log("🔄 更新本地狀態，添加新動態:",d.id),R(o=>{const a=[d,...o];return console.log(`📊 更新後動態總數: ${a.length}`),a}),V(""),P(n("community.messages.publishSuccess")),setTimeout(()=>P(""),3e3)}catch(r){console.error("❌ 發布動態失敗:",r),h(`${n("community.messages.publishFail")}: ${r.message}`)}finally{ae(!1)}},ze=u.useCallback(async(s,r)=>{if(!v.currentUser){h(n("community.messages.needLogin"));return}if(se.has(s)){console.log("🔄 點讚操作進行中，請稍候...");return}const c=r.includes(T),d=c?r.filter(o=>o!==T):[...r,T];R(o=>o.map(a=>a.id===s?{...a,likes:d}:a)),oe(o=>new Set(o).add(s));try{const o=A(b,"communityPosts",s);await pe(o,{likes:d},{merge:!0}),E.logWrite("setDoc","communityPosts",s,{likes:`更新為 ${d.length} 個點讚`}),console.log(`👍 ${c?"取消點讚":"點讚"}成功`)}catch(o){console.error("❌ 點讚操作失敗:",o),h(n("community.messages.likeFail")),R(a=>a.map(g=>g.id===s?{...g,likes:r}:g))}finally{oe(o=>{const a=new Set(o);return a.delete(s),a})}},[se,v.currentUser,R]),De=u.useCallback(async s=>{if(v.currentUser)try{const r=A(b,"communityPosts",s),c=await ne(r);if(c.exists()){const o=c.data().comments||[];R(a=>a.map(g=>g.id===s?{...g,comments:o}:g)),console.log(`💬 載入評論完成：${o.length} 條評論`)}}catch(r){console.error("❌ 載入評論失敗:",r)}},[]),Qe=u.useCallback(async(s,r)=>{var w;if(!r.trim())return;if(!v.currentUser){h(n("community.messages.needLogin"));return}if(fe.has(s)){console.log("🔄 留言提交中，請稍候...");return}const c=I.find(l=>l.id===s);if(!c){h(n("community.messages.postNotFound"));return}const d=Ee(c.comments||[],null,"post");if(!d.success){h(d.message);return}const o={id:Date.now().toString(),userId:v.currentUser.uid,userNickname:(t==null?void 0:t.nickname)||((w=t==null?void 0:t.email)==null?void 0:w.split("@")[0])||n("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(t==null?void 0:t.avatarUrl)||"",content:r.trim(),timestamp:new Date().toISOString()},a=Ee(c.comments||[],o,"post");if(!a.success){h(a.message);return}R(l=>l.map(x=>x.id===s?{...x,comments:a.comments}:x)),Ne(l=>new Set(l).add(s)),te.current.has(s)&&clearTimeout(te.current.get(s));const g=setTimeout(async()=>{try{const l=A(b,"communityPosts",s);await pe(l,{comments:a.comments},{merge:!0}),E.logWrite("setDoc","communityPosts",s,{comments:`新增留言，總計 ${a.comments.length} 條`,wasAutoCleaned:a.wasAutoCleaned,removedCount:a.removedCount}),a.notification&&(P(a.notification),setTimeout(()=>P(""),5e3)),console.log("💬 留言添加成功",{totalComments:a.comments.length,wasAutoCleaned:a.wasAutoCleaned,removedCount:a.removedCount})}catch(l){console.error("❌ 添加留言失敗:",l),h(n("community.messages.commentFail")),R(m=>m.map(f=>f.id===s?{...f,comments:c.comments||[]}:f))}finally{Ne(l=>{const m=new Set(l);return m.delete(s),m}),te.current.delete(s)}},500);te.current.set(s,g)},[v.currentUser,t==null?void 0:t.nickname,t==null?void 0:t.email,t==null?void 0:t.avatarUrl,fe,I,R]),Ge=u.useCallback(async(s,r)=>{if(!v.currentUser){h(n("community.messages.needLogin"));return}try{const c=I.find(x=>x.id===s);if(!c){h(n("community.messages.postNotFound"));return}const d=c.comments.find(x=>x.id===r);if(!d){h(n("community.messages.commentNotFound"));return}const o=v.currentUser.uid,a=c.userId===o,g=d.userId===o;if(!a&&!g){h(n("community.messages.noPermission"));return}const w=n(a?"community.confirm.deleteComment":"community.confirm.deleteMyComment");if(!window.confirm(w))return;const l=c.comments.filter(x=>x.id!==r),m=A(b,"communityPosts",s);await pe(m,{comments:l},{merge:!0}),E.logWrite("setDoc","communityPosts",s,{comments:`刪除留言，總計 ${l.length} 條`}),console.log("🔄 更新本地狀態，刪除留言:",r),R(x=>{const f=x.map(y=>y.id===s?{...y,comments:l}:y);return console.log(`📊 動態 ${s} 留言數: ${l.length}`),f}),P(n("community.messages.deleteCommentSuccess")),setTimeout(()=>P(""),3e3)}catch(c){console.error("❌ 刪除留言失敗:",c),h(n("community.messages.deleteCommentFail"))}},[I]),_e=u.useCallback(async s=>{if(!v.currentUser){h(n("community.messages.needLogin"));return}try{const r=I.find(o=>o.id===s);if(!r){h(n("community.messages.postNotFound"));return}const c=v.currentUser.uid;if(r.userId!==c){h(n("community.messages.noPermission"));return}if(!window.confirm(n("community.confirm.deletePost")))return;const d=A(b,"communityPosts",s);await Te(d),E.logWrite("deleteDoc","communityPosts",s,{action:"刪除動態"}),console.log("🔄 更新本地狀態，刪除動態:",s),R(o=>{const a=o.filter(g=>g.id!==s);return console.log(`📊 剩餘動態數: ${a.length}`),a}),P(n("community.messages.deletePostSuccess")),setTimeout(()=>P(""),3e3)}catch(r){console.error("❌ 刪除動態失敗:",r),h(n("community.messages.deletePostFail"))}},[I]),He=u.useCallback(s=>{const r=new Date,c=new Date(s),d=r-c,o=Math.floor(d/(1e3*60)),a=Math.floor(d/(1e3*60*60)),g=Math.floor(d/(1e3*60*60*24));if(o<1)return n("community.time.justNow");if(o<60)return n("community.time.minutesAgo",{count:o});if(a<24)return n("community.time.hoursAgo",{count:a});if(g<7)return n("community.time.daysAgo",{count:g});try{return new Intl.DateTimeFormat(re.language).format(c)}catch{return c.toLocaleDateString()}},[re.language,n]),K=u.useCallback(async()=>{var s;try{if(W.current)return;if(N(!0),!v.currentUser)throw new Error("未登入");const r=z(M(b,"friendInvitations"),$("fromUserId","==",v.currentUser.uid),$("status","==","accepted")),c=z(M(b,"friendInvitations"),$("toUserId","==",v.currentUser.uid),$("status","==","accepted")),[d,o]=await Promise.all([D(r),D(c)]),a=new Set;d.forEach(m=>{const x=m.data();a.add(x.toUserId)}),o.forEach(m=>{const x=m.data();a.add(x.fromUserId)});const g=[];for(const m of a)try{const x=await ne(A(b,"users",m));if(x.exists()){const f=x.data();if(!f){console.warn(`好友 ${m} 的用戶數據為空`);continue}console.log(`✅ 載入好友資料: ${m} - ${f.nickname||f.email}`);let y=0,j=0;if(f.scores){const C=[];f.scores.strength&&f.scores.strength>0&&C.push(f.scores.strength),f.scores.explosivePower&&f.scores.explosivePower>0&&C.push(f.scores.explosivePower),f.scores.cardio&&f.scores.cardio>0&&C.push(f.scores.cardio),f.scores.muscleMass&&f.scores.muscleMass>0&&C.push(f.scores.muscleMass),f.scores.bodyFat&&f.scores.bodyFat>0&&C.push(f.scores.bodyFat),console.log(`好友 ${m} 的評分數據:`,f.scores),console.log(`好友 ${m} 的有效分數:`,C),C.length>0&&(y=C.reduce((S,xe)=>S+xe,0)/C.length,j=C.length,console.log(`好友 ${m} 平均分數: ${y}, 項目數: ${j}`))}else console.log(`好友 ${m} 沒有評分數據`);g.push({id:m,nickname:f.nickname||((s=f.email)==null?void 0:s.split("@")[0])||"未命名用戶",email:f.email||"",avatarUrl:f.avatarUrl||"",averageScore:y>0?Number(y).toFixed(2):null,scoreCount:j,lastActive:f.lastActive})}}catch(x){console.error(`載入好友 ${m} 數據失敗:`,x)}const w=g.filter(m=>m&&m.id&&typeof m.nickname=="string");Y(w);const l=Array.from(a);J(m=>({...m,friends:l})),W.current=!0}catch(r){console.error("載入好友數據失敗:",r),h(n("community.messages.loadFriendsFail")),W.current=!0}finally{N(!1)}},[]),B=u.useCallback(async()=>{var s;try{console.log("🔍 開始載入好友邀請..."),console.log("當前用戶ID:",v.currentUser.uid);const r=z(M(b,"friendInvitations"),$("toUserId","==",v.currentUser.uid)),c=await D(r);console.log("📋 找到所有邀請數量:",c.docs.length),c.docs.forEach((g,w)=>{const l=g.data();console.log(`邀請 ${w+1}:`,{id:g.id,fromUserId:l.fromUserId,toUserId:l.toUserId,status:l.status,createdAt:l.createdAt})});const d=z(M(b,"friendInvitations"),$("toUserId","==",v.currentUser.uid),$("status","==","pending")),o=await D(d);console.log("📋 找到pending邀請數量:",o.docs.length);const a=[];for(const g of o.docs){const w=g.data();try{const l=await ne(A(b,"users",w.fromUserId));if(l.exists()){const m=l.data();a.push({id:g.id,fromUserId:w.fromUserId,nickname:m.nickname||((s=m.email)==null?void 0:s.split("@")[0])||"未命名用戶",email:m.email,avatarUrl:m.avatarUrl||"",createdAt:w.createdAt})}}catch(l){console.error("獲取邀請用戶信息失敗:",l)}}console.log("✅ 載入完成，邀請列表:",a),ce(a),me.current=!0}catch(r){console.error("載入好友邀請失敗:",r),me.current=!0}},[ce]),je=async()=>{if(!q.trim()){ee([]);return}try{N(!0);const s=z(M(b,"users")),r=await D(s),c=[];r.forEach(d=>{var l;const o=d.data(),a=q.toLowerCase(),g=(o.nickname||"").toLowerCase(),w=(o.email||"").toLowerCase();(g.includes(a)||w.includes(a))&&d.id!==v.currentUser.uid&&c.push({id:d.id,nickname:o.nickname||((l=o.email)==null?void 0:l.split("@")[0])||"未命名用戶",email:o.email,avatarUrl:o.avatarUrl||"",isFriend:i.some(m=>m.id===d.id),hasPendingRequest:!1})}),ee(c)}catch(s){console.error("搜尋用戶失敗:",s),h(n("community.messages.searchFail"))}finally{N(!1)}},Le=async s=>{var r;try{if(console.log("📤 開始發送好友邀請..."),console.log("發送者ID:",v.currentUser.uid),console.log("接收者ID:",s),N(!0),(((r=t==null?void 0:t.friends)==null?void 0:r.length)||(i==null?void 0:i.length)||0)>=100){h(n("community.messages.friendLimitMessage"));return}const o=z(M(b,"friendInvitations"),$("fromUserId","==",v.currentUser.uid),$("toUserId","==",s),$("status","==","pending")),a=await D(o);if(!a.empty){console.log("⚠️ 發現已存在的邀請:",a.docs.length,"個");const l=a.docs[0],m=l.data();console.log("現有邀請資料:",m);const x=new Date(m.createdAt);if((new Date-x)/(1e3*60*60)>24)console.log("📅 邀請已超過24小時，允許重新發送"),await Te(A(b,"friendInvitations",l.id)),console.log("🗑️ 已刪除舊邀請");else{h(n("community.messages.inviteSent")),setTimeout(()=>{h("")},3e3);return}}const g={fromUserId:v.currentUser.uid,toUserId:s,status:"pending",createdAt:new Date().toISOString()};console.log("📝 邀請資料:",g);const w=await Me(M(b,"friendInvitations"),g);E.logWrite("addDoc","friendInvitations",w.id),console.log("✅ 邀請已發送，文檔ID:",w.id),P(n("community.messages.inviteSent"));try{const l=await ne(w);l.exists()?console.log("✅ 邀請驗證成功:",l.data()):console.error("❌ 邀請驗證失敗：文檔不存在")}catch(l){console.error("❌ 邀請驗證失敗:",l)}ee(l=>l.map(m=>m.id===s?{...m,hasPendingRequest:!0}:m)),setTimeout(()=>{B()},1e3)}catch(c){console.error("發送好友邀請失敗:",c),h(n("community.messages.inviteSendFail"))}finally{N(!1)}},Ke=async(s,r)=>{var c;try{if(N(!0),(((c=t==null?void 0:t.friends)==null?void 0:c.length)||(i==null?void 0:i.length)||0)>=100){h(n("community.messages.friendLimitMessage"));return}await ie(A(b,"friendInvitations",s),{status:"accepted",updatedAt:new Date().toISOString()}),E.logWrite("updateDoc","friends",s);const a=A(b,"users",v.currentUser.uid);await ie(a,{friends:is(r)}),E.logWrite("updateDoc","users",v.currentUser.uid,{friends:"arrayUnion"}),J(g=>({...g,friends:[...g.friends||[],r]})),await K(),await B(),P(n("community.messages.inviteAccepted"))}catch(d){console.error("接受好友邀請失敗:",d),h(`${n("community.messages.inviteAcceptFail")}: ${d.message}`)}finally{N(!1)}},Je=async s=>{try{N(!0),await ie(A(b,"friendInvitations",s),{status:"declined",updatedAt:new Date().toISOString()}),E.logWrite("updateDoc","friendInvitations",s),await B(),P(n("community.messages.inviteRejected"))}catch(r){console.error("拒絕好友邀請失敗:",r),h(`${n("community.messages.inviteRejectFail")}: ${r.message}`)}finally{N(!1)}},Ve=s=>{if(!s){console.error("好友ID為空");return}const r=i.find(c=>c.id===s);r?(console.log("🔄 跳轉到好友個人版:",s,r.nickname),p(`/friend-feed/${s}`)):(console.error("找不到好友:",s),console.log("當前好友列表:",i))},Xe=async s=>{const r=i.find(a=>a.id===s),c=(r==null?void 0:r.nickname)||"好友";if(!(!window.confirm(`確定要移除好友「${c}」嗎？

移除後：
• 雙方將不再是好友關係
• 無法查看對方的動態
• 此操作可以重新加好友來恢復`)||!window.confirm(`最後確認：確定要移除好友「${c}」嗎？此操作將立即生效。`)))try{N(!0);const a=A(b,"users",v.currentUser.uid);await ie(a,{friends:ns(s)});const w=(await D(z(M(b,"friendInvitations"),$("fromUserId","in",[v.currentUser.uid,s]),$("toUserId","in",[v.currentUser.uid,s])))).docs.map(l=>ie(l.ref,{status:"cancelled",cancelledAt:new Date().toISOString()}));await Promise.all(w),J(l=>{var m;return{...l,friends:((m=l.friends)==null?void 0:m.filter(x=>x!==s))||[]}}),Y(l=>l.filter(m=>m.id!==s)),P(`已移除好友「${c}」`)}catch(a){console.error("移除好友失敗:",a),h(`移除好友失敗: ${a.message}`)}finally{N(!1)}};return u.useEffect(()=>{try{he(),K(),B()}catch(s){console.error("初始載入失敗:",s),h("載入數據失敗，請稍後再試")}return()=>{const s=te.current;s&&(s.forEach(r=>clearTimeout(r)),s.clear())}},[he,K,B]),u.useEffect(()=>{try{F==="friends"&&!W.current?(console.log("🔄 標籤切換時重新載入好友數據"),K()):F==="requests"&&!me.current&&(console.log("🔄 標籤切換時重新載入邀請數據"),B())}catch(s){console.error("標籤切換載入失敗:",s),h("載入數據失敗，請稍後再試")}},[F,K,B]),e.jsxs("div",{className:"community-page",children:[e.jsxs("div",{className:"community-header",children:[e.jsxs("h1",{children:["🏠 ",n("community.brandTitle")]}),O&&e.jsx("div",{className:"alert alert-error",children:O}),_&&e.jsx("div",{className:"alert alert-success",children:_})]}),!i&&e.jsx("div",{className:"alert alert-error",children:"載入好友列表時出現錯誤，請刷新頁面重試"}),e.jsxs("div",{className:"tab-navigation",children:[!W.current&&e.jsx("div",{className:"loading-indicator",children:"正在載入好友數據..."}),e.jsx("div",{className:`tab-btn ${F==="feed"?"active":""}`,onClick:()=>Q("feed"),children:e.jsx("span",{className:"tab-label",children:n("community.tabs.feed")})}),e.jsx("div",{className:`tab-btn ${F==="friends"?"active":""}`,onClick:()=>Q("friends"),children:e.jsxs("span",{className:"tab-label",children:[n("community.tabs.friends")," (",W.current?i.length:"...",")"]})}),e.jsxs("div",{className:`tab-btn ${F==="requests"?"active":""}`,onClick:()=>Q("requests"),children:[e.jsx("span",{className:"tab-label",children:n("community.tabs.invites")}),L.length>0&&e.jsx("span",{className:"notification-badge",children:L.length})]}),e.jsx("div",{className:`tab-btn ${F==="search"?"active":""}`,onClick:()=>Q("search"),children:e.jsx("span",{className:"tab-label",children:n("community.tabs.search")})})]}),e.jsxs("div",{className:"tab-content",children:[G&&e.jsx("div",{className:"loading",children:"載入中..."}),O&&!G&&e.jsxs("div",{className:"alert alert-error",children:[O,e.jsx("button",{onClick:()=>{le.current=!1,W.current=!1,me.current=!1,de.current.clear(),ue.current=0,h(""),he(),K(),B()},style:{marginLeft:"10px",padding:"5px 10px",background:"#ff6b6b",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"重試"})]}),!O&&!G&&F==="feed"&&e.jsx("div",{className:"refresh-section",children:e.jsxs("button",{onClick:()=>{le.current=!1,W.current=!1,de.current.clear(),ue.current=0,K(),he()},style:{padding:"8px 16px",background:"var(--tiffany-secondary)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",marginBottom:"10px"},children:["🔄 ",n("community.refresh")]})}),F==="feed"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"post-composer",children:e.jsxs("div",{className:"composer-header",children:[e.jsx("div",{className:"user-avatar",children:e.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(t==null?void 0:t.avatarUrl)||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),loading:"lazy",onError:s=>{s.target.src="/default-avatar.svg"}})}),e.jsxs("div",{className:"composer-input",children:[e.jsx("textarea",{placeholder:n("community.sharePlaceholder"),value:H,onChange:s=>V(s.target.value),maxLength:500,disabled:X}),e.jsxs("div",{className:"composer-footer",children:[e.jsxs("span",{className:"char-count",children:[H.length,"/500"]}),e.jsx("button",{onClick:Be,disabled:!H.trim()||X,className:"publish-btn",children:n(X?"community.publishing":"community.publish")})]})]})]})}),e.jsx("div",{className:"posts-container",children:I.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:n("community.emptyFeed.title")}),e.jsx("p",{children:n("community.emptyFeed.subtitle")})]}):I.map(s=>{var r;return e.jsx(We,{post:s,currentUserId:(r=v.currentUser)==null?void 0:r.uid,onToggleLike:ze,onAddComment:Qe,onDeleteComment:Ge,onDeletePost:_e,onLoadComments:De,formatTime:He,likeProcessing:se,commentProcessing:fe},s.id)})})]}),F==="friends"&&e.jsxs("div",{className:"friends-tab",children:[e.jsxs("div",{className:"friends-limit-info",children:[e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"👥"}),e.jsx("span",{className:"limit-text",children:n("community.messages.friendLimitInfo")})]}),e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"📊"}),e.jsxs("span",{className:"limit-text",children:[n("community.messages.currentFriends"),"：",((be=t==null?void 0:t.friends)==null?void 0:be.length)||(i==null?void 0:i.length)||0," / 100",100-(((Ce=t==null?void 0:t.friends)==null?void 0:Ce.length)||(i==null?void 0:i.length)||0)<=10&&e.jsxs("span",{className:"limit-warning",children:[" ","(僅剩"," ",100-(((Ue=t==null?void 0:t.friends)==null?void 0:Ue.length)||(i==null?void 0:i.length)||0)," ","個名額)"]})]})]}),(((ke=t==null?void 0:t.friends)==null?void 0:ke.length)||(i==null?void 0:i.length)||0)>=100&&e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"⚠️"}),e.jsx("span",{className:"limit-text limit-warning",children:"已達好友數量上限，無法添加更多好友"})]})]}),!i||i.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:n("community.noFriends")}),e.jsx("p",{children:n("community.goSearchFriends")})]}):e.jsx("div",{className:"friends-list",children:i.filter(s=>s&&s.id).map(s=>e.jsxs("div",{className:"friend-item",children:[e.jsxs("div",{className:"friend-info",children:[e.jsx("img",{src:s.avatarUrl||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:r=>{r.target.src="/default-avatar.svg"}}),e.jsxs("div",{className:"friend-details",children:[e.jsx("div",{className:"friend-name",children:s.nickname||n("community.fallback.unnamedUser")}),e.jsx("div",{className:"friend-score",children:s.averageScore?e.jsx(e.Fragment,{children:e.jsxs("span",{className:"score-value",children:["🏆 ",s.averageScore,n("community.ui.pointsUnit")]})}):e.jsx("span",{className:"no-score",children:n("community.ui.noScore")})}),e.jsx("div",{className:"friend-email",children:s.email||""})]})]}),e.jsxs("div",{className:"friend-actions",children:[e.jsx("button",{className:"btn-board",onClick:()=>s.id&&Ve(s.id),title:n("community.ui.boardTitle"),children:"💬"}),e.jsx("button",{className:"btn-remove",onClick:()=>s.id&&Xe(s.id),title:n("community.friend.remove"),children:"❌"})]})]},s.id||"unknown"))})]}),F==="requests"&&e.jsxs("div",{className:"requests-tab",children:[e.jsxs("div",{className:"friends-limit-info",children:[e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"👥"}),e.jsx("span",{className:"limit-text",children:n("community.messages.friendLimitInfo")})]}),e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"📊"}),e.jsxs("span",{className:"limit-text",children:[n("community.messages.currentFriends"),"：",((Re=t==null?void 0:t.friends)==null?void 0:Re.length)||(i==null?void 0:i.length)||0," / 100",100-(((Se=t==null?void 0:t.friends)==null?void 0:Se.length)||(i==null?void 0:i.length)||0)<=10&&e.jsxs("span",{className:"limit-warning",children:[" ","(僅剩"," ",100-(((Pe=t==null?void 0:t.friends)==null?void 0:Pe.length)||(i==null?void 0:i.length)||0)," ","個名額)"]})]})]}),(((Fe=t==null?void 0:t.friends)==null?void 0:Fe.length)||(i==null?void 0:i.length)||0)>=100&&e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"⚠️"}),e.jsx("span",{className:"limit-text limit-warning",children:"已達好友數量上限，無法接受更多邀請"})]})]}),L.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:n("community.invites.empty")})}):e.jsx("div",{className:"requests-list",children:L.map(s=>{var r,c,d;return e.jsxs("div",{className:"request-item",children:[e.jsxs("div",{className:"request-info",children:[e.jsx("img",{src:s.avatarUrl||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),className:"request-avatar",loading:"lazy",onError:o=>{o.target.src="/default-avatar.svg"}}),e.jsxs("div",{className:"request-details",children:[e.jsx("div",{className:"request-name",children:s.nickname}),e.jsx("div",{className:"request-email",children:s.email})]})]}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"btn-accept",onClick:()=>Ke(s.id,s.fromUserId),disabled:(((r=t==null?void 0:t.friends)==null?void 0:r.length)||(i==null?void 0:i.length)||0)>=100,title:(((c=t==null?void 0:t.friends)==null?void 0:c.length)||(i==null?void 0:i.length)||0)>=100?n("community.messages.friendLimitReached"):n("community.invites.accept"),children:(((d=t==null?void 0:t.friends)==null?void 0:d.length)||(i==null?void 0:i.length)||0)>=100?"❌":"✅"}),e.jsx("button",{className:"btn-decline",onClick:()=>Je(s.id),title:n("community.invites.reject"),children:"❌"})]})]},s.id)})})]}),F==="search"&&e.jsxs("div",{className:"search-tab",children:[e.jsxs("div",{className:"friends-limit-info",children:[e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"👥"}),e.jsx("span",{className:"limit-text",children:n("community.messages.friendLimitInfo")})]}),e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"📊"}),e.jsxs("span",{className:"limit-text",children:[n("community.messages.currentFriends"),"：",((Ie=t==null?void 0:t.friends)==null?void 0:Ie.length)||(i==null?void 0:i.length)||0," / 100",100-(((Ae=t==null?void 0:t.friends)==null?void 0:Ae.length)||(i==null?void 0:i.length)||0)<=10&&e.jsxs("span",{className:"limit-warning",children:[" ","(僅剩"," ",100-((($e=t==null?void 0:t.friends)==null?void 0:$e.length)||(i==null?void 0:i.length)||0)," ","個名額)"]})]})]}),(((qe=t==null?void 0:t.friends)==null?void 0:qe.length)||(i==null?void 0:i.length)||0)>=100&&e.jsxs("div",{className:"limit-info-item",children:[e.jsx("span",{className:"limit-icon",children:"⚠️"}),e.jsx("span",{className:"limit-text limit-warning",children:"已達好友數量上限，無法添加更多好友"})]})]}),e.jsxs("div",{className:"search-container",children:[e.jsx("input",{type:"text",placeholder:n("community.search.placeholder"),value:q,onChange:s=>U(s.target.value),onKeyPress:s=>{s.key==="Enter"&&je()},className:"search-input"}),e.jsx("button",{onClick:je,className:"search-btn",children:n("common.search")})]}),e.jsx("div",{className:"search-results",children:Z.length===0&&q.trim()?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:n("community.search.empty")})}):Z.map(s=>{var r,c,d;return e.jsxs("div",{className:"user-item",children:[e.jsxs("div",{className:"user-info",children:[e.jsx("img",{src:s.avatarUrl||"/default-avatar.svg",alt:n("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onError:o=>{o.target.src="/default-avatar.svg"}}),e.jsxs("div",{className:"user-details",children:[e.jsx("div",{className:"user-name",children:s.nickname}),e.jsx("div",{className:"user-email",children:s.email})]})]}),e.jsx("div",{className:"user-actions",children:s.isFriend?e.jsx("span",{className:"status-badge",children:n("community.friend.badgeFriend")}):s.hasPendingRequest?e.jsx("span",{className:"status-badge",children:n("community.friend.badgeInvited")}):e.jsx("button",{className:"btn-add",onClick:()=>Le(s.id),disabled:G||(((r=t==null?void 0:t.friends)==null?void 0:r.length)||(i==null?void 0:i.length)||0)>=100,title:(((c=t==null?void 0:t.friends)==null?void 0:c.length)||(i==null?void 0:i.length)||0)>=100?n("community.messages.friendLimitReached"):n("community.friend.add"),children:(((d=t==null?void 0:t.friends)==null?void 0:d.length)||(i==null?void 0:i.length)||0)>=100?"已達上限":n("community.friend.add")})})]},s.id)})})]})]})]})},We=es.memo(({post:p,currentUserId:t,onToggleLike:J,onAddComment:n,onDeleteComment:re,onDeletePost:F,onLoadComments:Q,formatTime:I,likeProcessing:R,commentProcessing:G})=>{const{t:N}=Oe(),[O,h]=u.useState(!1),[_,P]=u.useState(""),[H,V]=u.useState(!1),[X,ae]=u.useState(!1),i=p.likes.includes(t),Y=p.likes.length,L=p.commentCount||p.comments.length,ce=()=>{const U=!O;h(U),U&&!X&&Q&&(Q(p.id),ae(!0))},q=()=>{_.trim()&&(n(p.id,_),P(""))};return e.jsxs("div",{className:"post-card",children:[e.jsxs("div",{className:"post-header",children:[e.jsxs("div",{className:"post-user",children:[e.jsx("img",{src:p.userAvatarUrl||"/default-avatar.svg",alt:N("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onLoad:()=>V(!0),onError:U=>{U.target.src="/default-avatar.svg",V(!0)},style:{opacity:H?1:.5,transition:"opacity 0.3s ease"}}),e.jsxs("div",{className:"user-info",children:[e.jsxs("div",{className:"user-name",children:[p.userNickname,p.targetUserId&&e.jsxs("span",{className:"to-label",children:[" ","→"," ",p.targetUserNickname||N("community.friend.badgeFriend")]})]}),e.jsx("div",{className:"post-time",children:I(p.timestamp)})]})]}),p.userId===t&&e.jsx("button",{onClick:()=>F(p.id),className:"delete-post-btn",title:N("community.titles.deletePost"),children:"🗑️"})]}),e.jsx("div",{className:"post-content",children:p.content}),e.jsxs("div",{className:"post-actions",children:[e.jsxs("button",{onClick:()=>J(p.id,p.likes),className:`action-btn ${i?"liked":""}`,disabled:R.has(p.id),children:[e.jsx("span",{className:"action-icon",children:R.has(p.id)?"⏳":"👍"}),e.jsx("span",{className:"action-text",children:R.has(p.id)?N("community.processing"):`${Y>0?Y:""} ${N("community.like")}`})]}),e.jsxs("button",{onClick:ce,className:"action-btn",children:[e.jsx("span",{className:"action-icon",children:"💬"}),e.jsxs("span",{className:"action-text",children:[L>0?L:""," ",N("community.comment")]})]})]}),O&&e.jsxs("div",{className:"comments-section",children:[p.comments.length>0&&e.jsx("div",{className:"comments-list",children:p.comments.map(U=>{const Z=p.userId===t,ee=U.userId===t,se=Z||ee;return e.jsxs("div",{className:"comment-item",children:[e.jsxs("div",{className:"comment-header",children:[e.jsxs("div",{className:"comment-user-info",children:[e.jsx("img",{src:U.userAvatarUrl||"/guest-avatar.svg",alt:N("community.ui.avatarAlt"),className:"comment-avatar",onError:oe=>{oe.target.src="/guest-avatar.svg"}}),e.jsxs("div",{className:"comment-text-info",children:[e.jsx("div",{className:"comment-name",children:U.userNickname}),e.jsx("div",{className:"comment-time",children:I(U.timestamp)})]})]}),se&&e.jsx("button",{onClick:()=>re(p.id,U.id),className:"comment-delete-btn",title:N(Z?"community.titles.deleteComment":"community.titles.deleteMyComment"),children:"🗑️"})]}),e.jsx("div",{className:"comment-content",children:U.content})]},U.id)})}),e.jsxs("div",{className:"comment-input",children:[e.jsx("input",{type:"text",placeholder:N("community.writeComment"),value:_,onChange:U=>P(U.target.value),onKeyPress:U=>{U.key==="Enter"&&q()}}),e.jsx("button",{onClick:q,disabled:!_.trim()||G.has(p.id),className:"comment-btn",children:G.has(p.id)?N("community.sending"):N("community.send")})]})]})]})});We.propTypes={post:k.shape({id:k.string.isRequired,userId:k.string.isRequired,userNickname:k.string.isRequired,userAvatarUrl:k.string,content:k.string.isRequired,timestamp:k.any.isRequired,likes:k.array.isRequired,comments:k.array.isRequired}).isRequired,currentUserId:k.string.isRequired,onToggleLike:k.func.isRequired,onAddComment:k.func.isRequired,onDeleteComment:k.func.isRequired,onDeletePost:k.func.isRequired,onLoadComments:k.func.isRequired,formatTime:k.func.isRequired,likeProcessing:k.instanceOf(Set).isRequired,commentProcessing:k.instanceOf(Set).isRequired};export{ms as default};
