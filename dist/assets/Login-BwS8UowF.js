import{u as R,j as e,a as u,d as j}from"./index-rTyFB9CY.js";import{r as g,d as K,u as _}from"./react-vendor-Jhh8OXpo.js";import{G as $,A as J,l as L,m as Q,s as E,B as X,n as Y}from"./firebase-lL8zW3tR.js";import{P as b}from"./charts-D1I5GTBR.js";import{P as Z}from"./PrivacyPolicyModal-CGOOpBFb.js";function D({onLogin:S,onError:n}){const[f,m]=g.useState(!1),{t:p}=R(),x=async()=>{m(!0);try{const i=new $;i.setCustomParameters({prompt:"select_account"});const c=(await J(u,i)).user;console.log("Google 登入成功:",c.email);const d=L(j,"users",c.uid);if(!(await Q(d)).exists()){const w={email:c.email,userId:c.uid,nickname:c.displayName||c.email.split("@")[0],avatarUrl:c.photoURL||"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:0,weight:0,age:0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};await E(d,w),console.log("新用戶資料已創建")}S(c.email,null)}catch(i){console.error("Google 登入失敗:",i);let a="登入失敗";i.code==="auth/popup-closed-by-user"?a="登入視窗被關閉，請重試":i.code==="auth/popup-blocked"?a="彈出視窗被阻擋，請允許彈出視窗後重試":i.code==="auth/account-exists-with-different-credential"?a="此電子郵件已被其他方式註冊，請使用原註冊方式登入":a=`登入失敗：${i.message}`,n(a)}finally{m(!1)}};return e.jsxs("div",{className:"social-login-container",children:[e.jsx("div",{className:"divider",children:e.jsx("span",{children:p("common.or")})}),e.jsx("div",{className:"social-buttons",children:e.jsxs("button",{type:"button",className:"social-btn google-btn",onClick:x,disabled:f,children:[e.jsxs("svg",{className:"google-icon",viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),p(f?"login.processing":"login.google")]})})]})}D.propTypes={onLogin:b.func.isRequired,onError:b.func.isRequired};function ee({onLogin:S}){const[n,f]=g.useState(""),[m,p]=g.useState(""),[x,i]=g.useState(null),[a,c]=g.useState(!1),[d,y]=g.useState(!1),[w,I]=g.useState(!1),[A,F]=g.useState(!1),v=K(),T=_(),{t,i18n:P}=R(),U=s=>{const r=s.target.validity;r.valueMissing?s.target.setCustomValidity(t("errors.emailRequired")):r.typeMismatch?s.target.setCustomValidity(t("errors.emailInvalid")):s.target.setCustomValidity(t("errors.invalidFormat"))},q=s=>{const r=s.target.validity;r.valueMissing?s.target.setCustomValidity(t("errors.passwordRequired")):r.tooShort?s.target.setCustomValidity(t("errors.passwordTooShort")):s.target.setCustomValidity(t("errors.invalidFormat"))},{height:N,weight:k,age:C}=T.state||{};g.useEffect(()=>{if(console.log("檢查 auth 初始化狀態:",u),!u){i("Firebase 未正確初始化，請檢查配置");return}const s=u.onAuthStateChanged(l=>{l&&(console.log("用戶已登入:",l.email),v("/user-info"))}),r=localStorage.getItem("savedEmail"),o=localStorage.getItem("savedPassword");return r&&o&&(console.log("從 localStorage 恢復帳號:",r),f(r),p(o),I(!0)),()=>s()},[v]);const V=async s=>{s.preventDefault(),i(null),await G()},G=async()=>{var s,r;if(y(!0),console.log("開始處理表單提交，isRegistering:",a,"email:",n),!u||!j){const o="Firebase 未正確初始化，請檢查配置";console.error(o,{auth:u,db:j}),i(o),y(!1);return}if(((r=(s=u.app)==null?void 0:s.options)==null?void 0:r.apiKey)==="demo-api-key"){const o="Firebase 使用 demo 配置，無法進行真實認證。請檢查環境變數配置。";console.error(o),i(o),y(!1);return}try{let o;if(a){console.log("嘗試註冊用戶:",n),o=await X(u,n,m);const h=o.user;console.log("註冊成功，用戶:",h.email,"UID:",h.uid);const W=L(j,"users",h.uid),M={email:h.email,userId:h.uid,nickname:h.email.split("@")[0],avatarUrl:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:N?parseFloat(N):0,weight:k?parseFloat(k):0,age:C?parseInt(C,10):0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};console.log("儲存初始用戶數據:",M),await E(W,M),console.log("用戶數據已儲存，文檔 ID:",h.uid)}else console.log("嘗試登入用戶:",n),o=await Y(u,n,m),console.log("登入成功，用戶:",o.user.email,"UID:",o.user.uid);const l=o.user;console.log("調用 onLogin 回調函數"),S(l.email,m),w?(console.log("儲存帳號到 localStorage:",n),localStorage.setItem("savedEmail",n),localStorage.setItem("savedPassword",m)):(console.log("清除 localStorage 中的帳號"),localStorage.removeItem("savedEmail"),localStorage.removeItem("savedPassword")),setTimeout(()=>{console.log("導航到 /user-info"),v("/user-info")},500)}catch(o){console.error("登入/註冊失敗:",o.code,o.message);let l=o.message;o.code==="auth/user-not-found"?l="找不到此電子郵件帳號，請檢查是否輸入正確或先註冊":o.code==="auth/wrong-password"?l="密碼錯誤，請重新輸入":o.code==="auth/invalid-email"?l="電子郵件格式不正確":o.code==="auth/weak-password"?l="密碼強度不足，請使用至少6個字符":o.code==="auth/email-already-in-use"&&(l="此電子郵件已被使用，請直接登入或使用其他郵箱註冊"),i(l)}finally{y(!1)}},O=()=>{console.log("社交登入成功，導航到 /user-info"),v("/user-info")},z=s=>{i(s)},H=()=>{sessionStorage.setItem("guestMode","true"),v("/user-info")},B=()=>{localStorage.setItem("privacyPolicyViewed","true")};return e.jsxs("div",{className:"login-container",children:[e.jsx("h1",{className:"text-2xl font-bold text-center mb-6",children:t(a?"login.register":"login.login")}),x&&e.jsx("p",{className:"error-message",children:x}),e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.email")}),e.jsx("input",{type:"email",value:n,onChange:s=>f(s.target.value),placeholder:t("login.emailPlaceholder"),className:"input-field",required:!0,onInvalid:U,onInput:s=>s.currentTarget.setCustomValidity(""),disabled:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.password")}),e.jsx("input",{type:"password",value:m,onChange:s=>p(s.target.value),placeholder:t("login.passwordPlaceholder"),className:"input-field",required:!0,minLength:6,onInvalid:q,onInput:s=>s.currentTarget.setCustomValidity(""),disabled:d})]}),e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"flex-end",marginBottom:"8px"},children:e.jsxs("label",{htmlFor:"rememberMe",style:{display:"flex",alignItems:"center",cursor:"pointer",whiteSpace:"nowrap",fontSize:"14px",color:"#555"},children:[e.jsx("input",{id:"rememberMe",type:"checkbox",checked:w,onChange:s=>I(s.target.checked),disabled:d,style:{margin:0}}),e.jsx("span",{style:{marginLeft:"6px"},children:t("login.rememberMe")})]})}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:d,children:t(d?"common.loading":a?"login.register":"login.login")})]}),e.jsx("button",{onClick:()=>c(!a),className:"toggle-btn",children:t(a?"login.switchToLogin":"login.switchToRegister")}),e.jsx("button",{onClick:H,className:"guest-btn",disabled:d,children:t("login.guestMode")}),e.jsx("div",{className:"privacy-notice",children:P.language&&P.language.toLowerCase().startsWith("zh")?e.jsxs("p",{children:["若繼續操作，即表示你同意最強肉體",e.jsx("a",{className:"privacy-link",href:"/terms",children:"使用條款"}),"。請參閱我們的",e.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"隱私權政策"}),"。"]}):e.jsxs("p",{children:["By continuing, you agree to the Ultimate Physique",e.jsx("a",{className:"privacy-link",href:"/terms",children:"Terms of Service"}),". Please review our",e.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"Privacy Policy"}),"."]})}),e.jsx(D,{onLogin:O,onError:z}),e.jsxs("div",{className:"instructions-container",children:[e.jsx("h2",{className:"instructions-title",children:t("login.instructions.title")}),e.jsxs("ul",{className:"instructions-list",children:[e.jsxs("li",{children:[e.jsx("strong",{children:t("login.instructions.items.fair.title")}),"：",t("login.instructions.items.fair.desc")]}),e.jsxs("li",{children:[e.jsx("strong",{children:t("login.instructions.items.analysis.title")}),"：",t("login.instructions.items.analysis.desc")]}),e.jsxs("li",{children:[e.jsx("strong",{children:t("login.instructions.items.tracking.title")}),"：",t("login.instructions.items.tracking.desc")]})]})]}),e.jsx(Z,{isOpen:A,onClose:()=>F(!1),onAccept:B})]})}ee.propTypes={onLogin:b.func.isRequired};export{ee as default};
