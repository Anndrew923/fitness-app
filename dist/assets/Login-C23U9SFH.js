const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-Chy2Ql0B.js","assets/index-ionwzUtr.js","assets/react-vendor-Jhh8OXpo.js","assets/firebase-rILKUpaA.js","assets/charts-D1I5GTBR.js","assets/index-zm5P2N5Y.css"])))=>i.map(i=>d[i]);
import{h as K,_ as J,d as I,u as C,j as s,a as w}from"./index-ionwzUtr.js";import{r as d,d as Q,u as X}from"./react-vendor-Jhh8OXpo.js";import{l as F,m as Y,s as P,A as Z,n as ee}from"./firebase-rILKUpaA.js";import{P as N}from"./charts-D1I5GTBR.js";import{P as se}from"./PrivacyPolicyModal-CuGhagkn.js";const j=K("GoogleAuth",{web:()=>J(()=>import("./web-Chy2Ql0B.js"),__vite__mapDeps([0,1,2,3,4,5])).then(v=>new v.GoogleAuthWeb)});class M{static async initialize(){try{const e=window.navigator.userAgent.includes("wv")||window.navigator.userAgent.includes("WebView");return console.log("ğŸ” WebView ç’°å¢ƒæª¢æ¸¬:",e),await j.initialize({clientId:"5144099869-6kes2g.apps.googleusercontent.com",scopes:["profile","email"],grantOfflineAccess:!0}),console.log("âœ… Google Auth åˆå§‹åŒ–æˆåŠŸ"),!0}catch(e){throw console.error("âŒ Google Auth åˆå§‹åŒ–å¤±æ•—:",e),e}}static async signIn(){try{console.log("ğŸ”„ é–‹å§‹åŸç”Ÿ Google ç™»å…¥...");const e=new Promise((h,g)=>{setTimeout(()=>g(new Error("ç™»å…¥è¶…æ™‚")),3e4)}),r=j.signIn(),a=await Promise.race([r,e]);if(console.log("âœ… åŸç”Ÿ Google ç™»å…¥æˆåŠŸ:",a),!a||!a.id||!a.email)throw new Error("ç™»å…¥çµæœä¸å®Œæ•´");return await this.convertToFirebaseUser(a)}catch(e){if(console.error("âŒ åŸç”Ÿ Google ç™»å…¥å¤±æ•—:",e),e.message.includes("Something went wrong")||e.message.includes("androidBridge")||e.message.includes("iu:"))return console.log("ğŸ”„ æª¢æ¸¬åˆ° Bridge é€šä¿¡éŒ¯èª¤ï¼Œå˜—è©¦é‡è©¦..."),await this.retrySignIn();throw e}}static async retrySignIn(e=0){if(e>=3)throw new Error("é‡è©¦æ¬¡æ•¸å·²é”ä¸Šé™");try{await new Promise(h=>setTimeout(h,1e3*(e+1))),console.log(`ğŸ”„ ç¬¬ ${e+1} æ¬¡é‡è©¦...`);const a=await j.signIn();if(!a||!a.id||!a.email)throw new Error("ç™»å…¥çµæœä¸å®Œæ•´");return await this.convertToFirebaseUser(a)}catch(a){if(console.error(`âŒ ç¬¬ ${e+1} æ¬¡é‡è©¦å¤±æ•—:`,a),e<2)return await this.retrySignIn(e+1);throw a}}static async convertToFirebaseUser(e){try{console.log("ğŸ”„ è½‰æ› Google çµæœç‚º Firebase ç”¨æˆ¶...");const r={uid:e.id,email:e.email,displayName:e.name,photoURL:e.imageUrl,emailVerified:!0,providerData:[{providerId:"google.com",uid:e.id,email:e.email,displayName:e.name,photoURL:e.imageUrl}]};return console.log("âœ… Firebase ç”¨æˆ¶è³‡æ–™å‰µå»ºæˆåŠŸ:",r),await this.saveUserToFirestore(r),r}catch(r){throw console.error("âŒ è½‰æ› Firebase ç”¨æˆ¶å¤±æ•—:",r),r}}static async saveUserToFirestore(e){try{console.log("ğŸ”„ ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ° Firestore...");const r=F(I,"users",e.uid);if((await Y(r)).exists())await P(r,{lastActive:new Date().toISOString(),updatedAt:new Date().toISOString()},{merge:!0}),console.log("âœ… ç¾æœ‰ç”¨æˆ¶è³‡æ–™å·²æ›´æ–°");else{const m={email:e.email,userId:e.uid,nickname:e.displayName||e.email.split("@")[0],avatarUrl:e.photoUrl||"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:0,weight:0,age:0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};await P(r,m),console.log("âœ… æ–°ç”¨æˆ¶è³‡æ–™å·²å‰µå»º")}}catch(r){throw console.error("âŒ ä¿å­˜ç”¨æˆ¶è³‡æ–™å¤±æ•—:",r),r}}static async signOut(){try{console.log("ğŸ”„ é–‹å§‹ Google ç™»å‡º..."),await j.signOut(),console.log("âœ… Google ç™»å‡ºæˆåŠŸ")}catch(e){throw console.error("âŒ Google ç™»å‡ºå¤±æ•—:",e),e}}static async checkAuthState(){try{return await j.refresh()}catch{return console.log("ç”¨æˆ¶æœªç™»å…¥æˆ– token å·²éæœŸ"),null}}}function L({onLogin:v,onError:e}){const[r,a]=d.useState(!1),[m,h]=d.useState(!1),[g,p]=d.useState(0),{t:b}=C();d.useEffect(()=>{(async()=>{try{const l=console.error;console.error=(...x)=>{x[0]&&x[0].includes("androidBridge")&&console.log("ğŸ” æª¢æ¸¬åˆ° Bridge é€šä¿¡éŒ¯èª¤ï¼Œå˜—è©¦é‡æ–°åˆå§‹åŒ–..."),l.apply(console,x)},await M.initialize(),h(!0),console.log("âœ… Google Auth åˆå§‹åŒ–å®Œæˆ")}catch(l){console.error("âŒ Google Auth åˆå§‹åŒ–å¤±æ•—:",l),h(!1)}})()},[]);const f=async()=>{if(!m){e("Google ç™»å…¥æœå‹™å°šæœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œé‡è©¦");return}a(!0),p(0);try{console.log("ğŸ”„ é–‹å§‹ Google ç™»å…¥æµç¨‹...");const n=await M.signIn();console.log("âœ… Google ç™»å…¥æˆåŠŸ:",n.email),v(n.email,null)}catch(n){console.error("âŒ Google ç™»å…¥å¤±æ•—:",n);let l="Google ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦";n.message.includes("network")?l="ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦":n.message.includes("cancelled")?l="ç™»å…¥å·²å–æ¶ˆ":n.message.includes("service")?l="Google æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œé‡è©¦":n.message.includes("sign_in_failed")?l="Google ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š":n.message.includes("Something went wrong")?l="ç™»å…¥æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œé‡è©¦":n.message.includes("androidBridge")&&(l="ç™»å…¥é€šä¿¡éŒ¯èª¤ï¼Œè«‹é‡è©¦"),e(l)}finally{a(!1)}};return s.jsxs("div",{className:"social-login-container",children:[s.jsx("div",{className:"divider",children:s.jsx("span",{children:b("common.or")})}),s.jsx("div",{className:"social-buttons",children:s.jsxs("button",{type:"button",className:"social-btn google-btn",onClick:f,disabled:r||!m,children:[s.jsxs("svg",{className:"google-icon",viewBox:"0 0 24 24",children:[s.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),s.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),s.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),s.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),b(r?"login.processing":"login.google")]})}),!m&&s.jsx("div",{className:"initialization-status",children:s.jsx("small",{children:"æ­£åœ¨åˆå§‹åŒ– Google ç™»å…¥æœå‹™..."})}),g>0&&s.jsx("div",{className:"retry-status",children:s.jsxs("small",{children:["æ­£åœ¨é‡è©¦ç™»å…¥... (",g,"/3)"]})})]})}L.propTypes={onLogin:N.func.isRequired,onError:N.func.isRequired};function oe({onLogin:v}){const[e,r]=d.useState(""),[a,m]=d.useState(""),[h,g]=d.useState(null),[p,b]=d.useState(!1),[f,n]=d.useState(!1),[l,x]=d.useState(!1),[T,R]=d.useState(!1),S=Q(),V=X(),{t,i18n:A}=C(),z=o=>{const c=o.target.validity;c.valueMissing?o.target.setCustomValidity(t("errors.emailRequired")):c.typeMismatch?o.target.setCustomValidity(t("errors.emailInvalid")):o.target.setCustomValidity(t("errors.invalidFormat"))},D=o=>{const c=o.target.validity;c.valueMissing?o.target.setCustomValidity(t("errors.passwordRequired")):c.tooShort?o.target.setCustomValidity(t("errors.passwordTooShort")):o.target.setCustomValidity(t("errors.invalidFormat"))},{height:G,weight:k,age:U}=V.state||{};d.useEffect(()=>{if(console.log("æª¢æŸ¥ auth åˆå§‹åŒ–ç‹€æ…‹:",w),!w){g("Firebase æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥é…ç½®");return}const o=w.onAuthStateChanged(u=>{u&&(console.log("ç”¨æˆ¶å·²ç™»å…¥:",u.email),S("/user-info"))}),c=localStorage.getItem("savedEmail"),i=localStorage.getItem("savedPassword");return c&&i&&(console.log("å¾ localStorage æ¢å¾©å¸³è™Ÿ:",c),r(c),m(i),x(!0)),()=>o()},[S]);const O=async o=>{o.preventDefault(),g(null),await _()},_=async()=>{var o,c;if(n(!0),console.log("é–‹å§‹è™•ç†è¡¨å–®æäº¤ï¼ŒisRegistering:",p,"email:",e),!w||!I){const i="Firebase æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥é…ç½®";console.error(i,{auth:w,db:I}),g(i),n(!1);return}if(((c=(o=w.app)==null?void 0:o.options)==null?void 0:c.apiKey)==="demo-api-key"){const i="Firebase ä½¿ç”¨ demo é…ç½®ï¼Œç„¡æ³•é€²è¡ŒçœŸå¯¦èªè­‰ã€‚è«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®ã€‚";console.error(i),g(i),n(!1);return}try{let i;if(p){console.log("å˜—è©¦è¨»å†Šç”¨æˆ¶:",e),i=await Z(w,e,a);const y=i.user;console.log("è¨»å†ŠæˆåŠŸï¼Œç”¨æˆ¶:",y.email,"UID:",y.uid);const $=F(I,"users",y.uid),E={email:y.email,userId:y.uid,nickname:y.email.split("@")[0],avatarUrl:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:G?parseFloat(G):0,weight:k?parseFloat(k):0,age:U?parseInt(U,10):0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};console.log("å„²å­˜åˆå§‹ç”¨æˆ¶æ•¸æ“š:",E),await P($,E),console.log("ç”¨æˆ¶æ•¸æ“šå·²å„²å­˜ï¼Œæ–‡æª” ID:",y.uid)}else console.log("å˜—è©¦ç™»å…¥ç”¨æˆ¶:",e),i=await ee(w,e,a),console.log("ç™»å…¥æˆåŠŸï¼Œç”¨æˆ¶:",i.user.email,"UID:",i.user.uid);const u=i.user;console.log("èª¿ç”¨ onLogin å›èª¿å‡½æ•¸"),v(u.email,a),l?(console.log("å„²å­˜å¸³è™Ÿåˆ° localStorage:",e),localStorage.setItem("savedEmail",e),localStorage.setItem("savedPassword",a)):(console.log("æ¸…é™¤ localStorage ä¸­çš„å¸³è™Ÿ"),localStorage.removeItem("savedEmail"),localStorage.removeItem("savedPassword")),setTimeout(()=>{console.log("å°èˆªåˆ° /user-info"),S("/user-info")},500)}catch(i){console.error("ç™»å…¥/è¨»å†Šå¤±æ•—:",i.code,i.message);let u=i.message;i.code==="auth/user-not-found"?u="æ‰¾ä¸åˆ°æ­¤é›»å­éƒµä»¶å¸³è™Ÿï¼Œè«‹æª¢æŸ¥æ˜¯å¦è¼¸å…¥æ­£ç¢ºæˆ–å…ˆè¨»å†Š":i.code==="auth/wrong-password"?u="å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥":i.code==="auth/invalid-email"?u="é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º":i.code==="auth/weak-password"?u="å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘6å€‹å­—ç¬¦":i.code==="auth/email-already-in-use"&&(u="æ­¤é›»å­éƒµä»¶å·²è¢«ä½¿ç”¨ï¼Œè«‹ç›´æ¥ç™»å…¥æˆ–ä½¿ç”¨å…¶ä»–éƒµç®±è¨»å†Š"),g(u)}finally{n(!1)}},q=()=>{console.log("ç¤¾äº¤ç™»å…¥æˆåŠŸï¼Œå°èˆªåˆ° /user-info"),S("/user-info")},B=o=>{g(o)},W=()=>{sessionStorage.setItem("guestMode","true"),S("/user-info")},H=()=>{localStorage.setItem("privacyPolicyViewed","true")};return s.jsxs("div",{className:"login-container",children:[s.jsx("h1",{className:"text-2xl font-bold text-center mb-6",children:t(p?"login.register":"login.login")}),h&&s.jsx("p",{className:"error-message",children:h}),s.jsxs("form",{onSubmit:O,className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.email")}),s.jsx("input",{type:"email",value:e,onChange:o=>r(o.target.value),placeholder:t("login.emailPlaceholder"),className:"input-field",required:!0,onInvalid:z,onInput:o=>o.currentTarget.setCustomValidity(""),disabled:f})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.password")}),s.jsx("input",{type:"password",value:a,onChange:o=>m(o.target.value),placeholder:t("login.passwordPlaceholder"),className:"input-field",required:!0,minLength:6,onInvalid:D,onInput:o=>o.currentTarget.setCustomValidity(""),disabled:f})]}),s.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"flex-end",marginBottom:"8px"},children:s.jsxs("label",{htmlFor:"rememberMe",style:{display:"flex",alignItems:"center",cursor:"pointer",whiteSpace:"nowrap",fontSize:"14px",color:"#555"},children:[s.jsx("input",{id:"rememberMe",type:"checkbox",checked:l,onChange:o=>x(o.target.checked),disabled:f,style:{margin:0}}),s.jsx("span",{style:{marginLeft:"6px"},children:t("login.rememberMe")})]})}),s.jsx("button",{type:"submit",className:"submit-btn",disabled:f,children:t(f?"common.loading":p?"login.register":"login.login")})]}),s.jsx("button",{onClick:()=>b(!p),className:"toggle-btn",children:t(p?"login.switchToLogin":"login.switchToRegister")}),s.jsx("button",{onClick:W,className:"guest-btn",disabled:f,children:t("login.guestMode")}),s.jsx("div",{className:"privacy-notice",children:A.language&&A.language.toLowerCase().startsWith("zh")?s.jsxs("p",{children:["è‹¥ç¹¼çºŒæ“ä½œï¼Œå³è¡¨ç¤ºä½ åŒæ„æœ€å¼·è‚‰é«”",s.jsx("a",{className:"privacy-link",href:"/terms",children:"ä½¿ç”¨æ¢æ¬¾"}),"ã€‚è«‹åƒé–±æˆ‘å€‘çš„",s.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"éš±ç§æ¬Šæ”¿ç­–"}),"ã€‚"]}):s.jsxs("p",{children:["By continuing, you agree to the Ultimate Physique",s.jsx("a",{className:"privacy-link",href:"/terms",children:"Terms of Service"}),". Please review our",s.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"Privacy Policy"}),"."]})}),s.jsx(L,{onLogin:q,onError:B}),s.jsxs("div",{className:"instructions-container",children:[s.jsx("h2",{className:"instructions-title",children:t("login.instructions.title")}),s.jsxs("ul",{className:"instructions-list",children:[s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.fair.title")}),"ï¼š",t("login.instructions.items.fair.desc")]}),s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.analysis.title")}),"ï¼š",t("login.instructions.items.analysis.desc")]}),s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.tracking.title")}),"ï¼š",t("login.instructions.items.tracking.desc")]})]})]}),s.jsx(se,{isOpen:T,onClose:()=>R(!1),onAccept:H})]})}oe.propTypes={onLogin:N.func.isRequired};export{oe as default};
