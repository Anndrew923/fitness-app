import{u as Ee,a as ke,b as y,d as w,m as T,j as s}from"./index-Do2PLJaq.js";import{d as Oe,r as m,R as We}from"./react-vendor-BToktFYo.js";import{t as W,q as L,v as Be,x as ze,y as B,m as ne,l as D,s as pe,D as be,w as $,H as Ue,z as re,I as Qe,J as Ge}from"./firebase-D0136ThQ.js";import{P as k}from"./charts-BNGpwEcn.js";const Ve=()=>{var we;const v=Oe(),{userData:o,setUserData:_}=Ee(),{t,i18n:ae}=ke(),[P,z]=m.useState("feed"),[R,C]=m.useState([]),[Q,x]=m.useState(!0),[M,g]=m.useState(""),[G,F]=m.useState(""),[H,V]=m.useState(""),[X,ie]=m.useState(!1),[q,Y]=m.useState([]),[K,oe]=m.useState([]),[A,U]=m.useState(""),[Z,ee]=m.useState([]),[se,ce]=m.useState(new Set),[he,je]=m.useState(new Set),te=m.useRef(new Map),E=m.useRef(!1),le=m.useRef(!1),me=m.useRef(!1),de=m.useRef(new Map),ue=m.useRef(0),ye=300*1e3,fe=m.useRef(new Map),ve=m.useRef(new Map),I=m.useMemo(()=>{var e;return(e=y.currentUser)==null?void 0:e.uid},[(we=y.currentUser)==null?void 0:we.uid]);m.useMemo(()=>{const e=(o==null?void 0:o.friends)||[];return[I,...e].filter(Boolean)},[I,o==null?void 0:o.friends]),m.useMemo(()=>A.trim()?R.filter(e=>e.content.toLowerCase().includes(A.toLowerCase())||e.userNickname.toLowerCase().includes(A.toLowerCase())):R,[R,A]);const ge=m.useCallback(async()=>{if(!y.currentUser||!o){console.log("ğŸš« ç”¨æˆ¶æœªç™»å…¥æˆ–è³‡æ–™æœªè¼‰å…¥ï¼Œè·³éè¼‰å…¥å‹•æ…‹");return}const e=Date.now(),n=de.current.get("posts");if(n&&e-n.timestamp<ye){console.log("ğŸ“¦ ä½¿ç”¨å¿«å–å‹•æ…‹æ•¸æ“š"),C(n.data);return}if(le.current&&e-ue.current<ye){console.log("â° å‹•æ…‹æ•¸æ“šä»åœ¨æœ‰æ•ˆæœŸé™å…§ï¼Œè·³éé‡æ–°è¼‰å…¥");return}console.log("ğŸ”„ é–‹å§‹è¼‰å…¥å‹•æ…‹..."),x(!0),g("");try{const a=(o==null?void 0:o.friends)||[],d=[I,...a].filter(Boolean);console.log(`ğŸ” ç•¶å‰ç”¨æˆ¶ID: ${I}`),console.log(`ğŸ” å¥½å‹åˆ—è¡¨: ${a.join(", ")}`),console.log(`ğŸ” å…è¨±æŸ¥çœ‹çš„ç”¨æˆ¶: ${d.join(", ")}`),console.log(`ğŸ” ç¸½å…± ${d.length} å€‹ç”¨æˆ¶çš„å‹•æ…‹éœ€è¦è¼‰å…¥`);const i=W(L(w,"communityPosts"),Be("timestamp","desc"),ze(50)),r=await B(i),c=[],p=[];r.forEach(f=>{const j=f.data(),b={id:f.id,userId:j.userId,userNickname:j.userNickname,userAvatarUrl:j.userAvatarUrl,content:j.content,timestamp:j.timestamp,likes:j.likes||[],commentCount:(j.comments||[]).length,comments:[],type:j.type||"status",targetUserId:j.targetUserId};j.targetUserId?p.push(b):d.includes(j.userId)&&c.push(b)});const l=Array.from(new Set(p.map(f=>f.targetUserId).filter(Boolean))).filter(f=>!fe.current.has(f));l.length>0&&await Promise.all(l.map(async f=>{var j;try{const b=await ne(D(w,"users",f)),S=b.exists()?b.data():null,xe=Array.isArray(S==null?void 0:S.friends)?S.friends:[];fe.current.set(f,xe),ve.current.set(f,{nickname:(S==null?void 0:S.nickname)||((j=S==null?void 0:S.email)==null?void 0:j.split("@")[0])||t("community.fallback.user"),avatarUrl:(S==null?void 0:S.avatarUrl)||""})}catch(b){console.warn("è®€å–ç›®æ¨™ç”¨æˆ¶å¥½å‹å¤±æ•—:",f,b),fe.current.set(f,[]),ve.current.set(f,{nickname:t("community.fallback.user"),avatarUrl:""})}}));const u=p.filter(f=>I===f.userId||I===f.targetUserId?!0:(fe.current.get(f.targetUserId)||[]).includes(I)).map(f=>{var j;return{...f,targetUserNickname:((j=ve.current.get(f.targetUserId))==null?void 0:j.nickname)||""}}),N=[...c,...u];N.sort((f,j)=>{const b=f.timestamp?new Date(f.timestamp):new Date(f.date);return(j.timestamp?new Date(j.timestamp):new Date(j.date))-b});const h=N.slice(0,30);console.log(`ğŸ“Š è¼‰å…¥å®Œæˆï¼šå…± ${h.length} æ¢å‹•æ…‹`),C(h),le.current=!0,ue.current=e,de.current.set("posts",{data:h,timestamp:e})}catch(a){console.error("è¼‰å…¥å‹•æ…‹å¤±æ•—:",a),g(t("community.messages.loadFeedError"))}finally{x(!1)}},[o==null?void 0:o.friends,ye]),Se=async()=>{var e;if(!H.trim()){g(t("community.messages.emptyPost"));return}if(!y.currentUser){g(t("community.messages.needLogin"));return}try{ie(!0),console.log("ğŸ“ æº–å‚™ç™¼å¸ƒå‹•æ…‹...");const n={userId:y.currentUser.uid,userNickname:(o==null?void 0:o.nickname)||((e=o==null?void 0:o.email)==null?void 0:e.split("@")[0])||t("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(o==null?void 0:o.avatarUrl)||"",content:H.trim(),type:"status",likes:[],comments:[],timestamp:new Date().toISOString(),privacy:"friends"},a=await Ue(L(w,"communityPosts"),n);T.logWrite("addDoc","communityPosts",a.id),console.log("âœ… å‹•æ…‹ç™¼å¸ƒæˆåŠŸï¼ŒID:",a.id);const d={id:a.id,...n};console.log("ğŸ”„ æ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œæ·»åŠ æ–°å‹•æ…‹:",d.id),C(i=>{const r=[d,...i];return console.log(`ğŸ“Š æ›´æ–°å¾Œå‹•æ…‹ç¸½æ•¸: ${r.length}`),r}),V(""),F(t("community.messages.publishSuccess")),setTimeout(()=>F(""),3e3)}catch(n){console.error("âŒ ç™¼å¸ƒå‹•æ…‹å¤±æ•—:",n),g(`${t("community.messages.publishFail")}: ${n.message}`)}finally{ie(!1)}},Pe=m.useCallback(async(e,n)=>{if(!y.currentUser){g(t("community.messages.needLogin"));return}if(se.has(e)){console.log("ğŸ”„ é»è®šæ“ä½œé€²è¡Œä¸­ï¼Œè«‹ç¨å€™...");return}const a=n.includes(I),d=a?n.filter(i=>i!==I):[...n,I];C(i=>i.map(r=>r.id===e?{...r,likes:d}:r)),ce(i=>new Set(i).add(e));try{const i=D(w,"communityPosts",e);await pe(i,{likes:d},{merge:!0}),T.logWrite("setDoc","communityPosts",e,{likes:`æ›´æ–°ç‚º ${d.length} å€‹é»è®š`}),console.log(`ğŸ‘ ${a?"å–æ¶ˆé»è®š":"é»è®š"}æˆåŠŸ`)}catch(i){console.error("âŒ é»è®šæ“ä½œå¤±æ•—:",i),g(t("community.messages.likeFail")),C(r=>r.map(c=>c.id===e?{...c,likes:n}:c))}finally{ce(i=>{const r=new Set(i);return r.delete(e),r})}},[se,y.currentUser,C]),Re=m.useCallback(async e=>{if(y.currentUser)try{const n=D(w,"communityPosts",e),a=await ne(n);if(a.exists()){const i=a.data().comments||[];C(r=>r.map(c=>c.id===e?{...c,comments:i}:c)),console.log(`ğŸ’¬ è¼‰å…¥è©•è«–å®Œæˆï¼š${i.length} æ¢è©•è«–`)}}catch(n){console.error("âŒ è¼‰å…¥è©•è«–å¤±æ•—:",n)}},[]),Fe=m.useCallback(async(e,n)=>{var i;if(!n.trim())return;if(!y.currentUser){g(t("community.messages.needLogin"));return}if(he.has(e)){console.log("ğŸ”„ ç•™è¨€æäº¤ä¸­ï¼Œè«‹ç¨å€™...");return}const a={id:Date.now().toString(),userId:y.currentUser.uid,userNickname:(o==null?void 0:o.nickname)||((i=o==null?void 0:o.email)==null?void 0:i.split("@")[0])||t("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(o==null?void 0:o.avatarUrl)||"",content:n.trim(),timestamp:new Date().toISOString()};C(r=>r.map(p=>{if(p.id===e){const l=[...p.comments,a];return{...p,comments:l}}return p})),je(r=>new Set(r).add(e)),te.current.has(e)&&clearTimeout(te.current.get(e));const d=setTimeout(async()=>{try{const r=R.find(l=>l.id===e);if(!r){g(t("community.messages.postNotFound"));return}const c=[...r.comments,a],p=D(w,"communityPosts",e);await pe(p,{comments:c},{merge:!0}),T.logWrite("setDoc","communityPosts",e,{comments:`æ–°å¢ç•™è¨€ï¼Œç¸½è¨ˆ ${c.length} æ¢`}),console.log("ğŸ’¬ ç•™è¨€æ·»åŠ æˆåŠŸ")}catch(r){console.error("âŒ æ·»åŠ ç•™è¨€å¤±æ•—:",r),g(t("community.messages.commentFail")),C(c=>c.map(l=>{if(l.id===e){const u=l.comments.filter(N=>N.id!==a.id);return{...l,comments:u}}return l}))}finally{je(r=>{const c=new Set(r);return c.delete(e),c}),te.current.delete(e)}},500);te.current.set(e,d)},[y.currentUser,o==null?void 0:o.nickname,o==null?void 0:o.email,o==null?void 0:o.avatarUrl,he,R,C]),De=m.useCallback(async(e,n)=>{if(!y.currentUser){g(t("community.messages.needLogin"));return}try{const a=R.find(N=>N.id===e);if(!a){g(t("community.messages.postNotFound"));return}const d=a.comments.find(N=>N.id===n);if(!d){g(t("community.messages.commentNotFound"));return}const i=y.currentUser.uid,r=a.userId===i,c=d.userId===i;if(!r&&!c){g(t("community.messages.noPermission"));return}const p=t(r?"community.confirm.deleteComment":"community.confirm.deleteMyComment");if(!window.confirm(p))return;const l=a.comments.filter(N=>N.id!==n),u=D(w,"communityPosts",e);await pe(u,{comments:l},{merge:!0}),T.logWrite("setDoc","communityPosts",e,{comments:`åˆªé™¤ç•™è¨€ï¼Œç¸½è¨ˆ ${l.length} æ¢`}),console.log("ğŸ”„ æ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œåˆªé™¤ç•™è¨€:",n),C(N=>{const h=N.map(f=>f.id===e?{...f,comments:l}:f);return console.log(`ğŸ“Š å‹•æ…‹ ${e} ç•™è¨€æ•¸: ${l.length}`),h}),F(t("community.messages.deleteCommentSuccess")),setTimeout(()=>F(""),3e3)}catch(a){console.error("âŒ åˆªé™¤ç•™è¨€å¤±æ•—:",a),g(t("community.messages.deleteCommentFail"))}},[R]),$e=m.useCallback(async e=>{if(!y.currentUser){g(t("community.messages.needLogin"));return}try{const n=R.find(i=>i.id===e);if(!n){g(t("community.messages.postNotFound"));return}const a=y.currentUser.uid;if(n.userId!==a){g(t("community.messages.noPermission"));return}if(!window.confirm(t("community.confirm.deletePost")))return;const d=D(w,"communityPosts",e);await be(d),T.logWrite("deleteDoc","communityPosts",e,{action:"åˆªé™¤å‹•æ…‹"}),console.log("ğŸ”„ æ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œåˆªé™¤å‹•æ…‹:",e),C(i=>{const r=i.filter(c=>c.id!==e);return console.log(`ğŸ“Š å‰©é¤˜å‹•æ…‹æ•¸: ${r.length}`),r}),F(t("community.messages.deletePostSuccess")),setTimeout(()=>F(""),3e3)}catch(n){console.error("âŒ åˆªé™¤å‹•æ…‹å¤±æ•—:",n),g(t("community.messages.deletePostFail"))}},[R]),qe=m.useCallback(e=>{const n=new Date,a=new Date(e),d=n-a,i=Math.floor(d/(1e3*60)),r=Math.floor(d/(1e3*60*60)),c=Math.floor(d/(1e3*60*60*24));if(i<1)return t("community.time.justNow");if(i<60)return t("community.time.minutesAgo",{count:i});if(r<24)return t("community.time.hoursAgo",{count:r});if(c<7)return t("community.time.daysAgo",{count:c});try{return new Intl.DateTimeFormat(ae.language).format(a)}catch{return a.toLocaleDateString()}},[ae.language,t]),J=m.useCallback(async()=>{var e;try{if(E.current)return;if(x(!0),!y.currentUser)throw new Error("æœªç™»å…¥");const n=W(L(w,"friendInvitations"),$("fromUserId","==",y.currentUser.uid),$("status","==","accepted")),a=W(L(w,"friendInvitations"),$("toUserId","==",y.currentUser.uid),$("status","==","accepted")),[d,i]=await Promise.all([B(n),B(a)]),r=new Set;d.forEach(u=>{const N=u.data();r.add(N.toUserId)}),i.forEach(u=>{const N=u.data();r.add(N.fromUserId)});const c=[];for(const u of r)try{const N=await ne(D(w,"users",u));if(N.exists()){const h=N.data();if(!h){console.warn(`å¥½å‹ ${u} çš„ç”¨æˆ¶æ•¸æ“šç‚ºç©º`);continue}console.log(`âœ… è¼‰å…¥å¥½å‹è³‡æ–™: ${u} - ${h.nickname||h.email}`);let f=0,j=0;if(h.scores){const b=[];h.scores.strength&&h.scores.strength>0&&b.push(h.scores.strength),h.scores.explosivePower&&h.scores.explosivePower>0&&b.push(h.scores.explosivePower),h.scores.cardio&&h.scores.cardio>0&&b.push(h.scores.cardio),h.scores.muscleMass&&h.scores.muscleMass>0&&b.push(h.scores.muscleMass),h.scores.bodyFat&&h.scores.bodyFat>0&&b.push(h.scores.bodyFat),console.log(`å¥½å‹ ${u} çš„è©•åˆ†æ•¸æ“š:`,h.scores),console.log(`å¥½å‹ ${u} çš„æœ‰æ•ˆåˆ†æ•¸:`,b),b.length>0&&(f=b.reduce((S,xe)=>S+xe,0)/b.length,j=b.length,console.log(`å¥½å‹ ${u} å¹³å‡åˆ†æ•¸: ${f}, é …ç›®æ•¸: ${j}`))}else console.log(`å¥½å‹ ${u} æ²’æœ‰è©•åˆ†æ•¸æ“š`);c.push({id:u,nickname:h.nickname||((e=h.email)==null?void 0:e.split("@")[0])||"æœªå‘½åç”¨æˆ¶",email:h.email||"",avatarUrl:h.avatarUrl||"",averageScore:f>0?Number(f).toFixed(2):null,scoreCount:j,lastActive:h.lastActive})}}catch(N){console.error(`è¼‰å…¥å¥½å‹ ${u} æ•¸æ“šå¤±æ•—:`,N)}const p=c.filter(u=>u&&u.id&&typeof u.nickname=="string");Y(p);const l=Array.from(r);_(u=>({...u,friends:l})),E.current=!0}catch(n){console.error("è¼‰å…¥å¥½å‹æ•¸æ“šå¤±æ•—:",n),g(t("community.messages.loadFriendsFail")),E.current=!0}finally{x(!1)}},[]),O=m.useCallback(async()=>{var e;try{console.log("ğŸ” é–‹å§‹è¼‰å…¥å¥½å‹é‚€è«‹..."),console.log("ç•¶å‰ç”¨æˆ¶ID:",y.currentUser.uid);const n=W(L(w,"friendInvitations"),$("toUserId","==",y.currentUser.uid)),a=await B(n);console.log("ğŸ“‹ æ‰¾åˆ°æ‰€æœ‰é‚€è«‹æ•¸é‡:",a.docs.length),a.docs.forEach((c,p)=>{const l=c.data();console.log(`é‚€è«‹ ${p+1}:`,{id:c.id,fromUserId:l.fromUserId,toUserId:l.toUserId,status:l.status,createdAt:l.createdAt})});const d=W(L(w,"friendInvitations"),$("toUserId","==",y.currentUser.uid),$("status","==","pending")),i=await B(d);console.log("ğŸ“‹ æ‰¾åˆ°pendingé‚€è«‹æ•¸é‡:",i.docs.length);const r=[];for(const c of i.docs){const p=c.data();try{const l=await ne(D(w,"users",p.fromUserId));if(l.exists()){const u=l.data();r.push({id:c.id,fromUserId:p.fromUserId,nickname:u.nickname||((e=u.email)==null?void 0:e.split("@")[0])||"æœªå‘½åç”¨æˆ¶",email:u.email,avatarUrl:u.avatarUrl||"",createdAt:p.createdAt})}}catch(l){console.error("ç²å–é‚€è«‹ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:",l)}}console.log("âœ… è¼‰å…¥å®Œæˆï¼Œé‚€è«‹åˆ—è¡¨:",r),oe(r),me.current=!0}catch(n){console.error("è¼‰å…¥å¥½å‹é‚€è«‹å¤±æ•—:",n),me.current=!0}},[oe]),Ne=async()=>{if(!A.trim()){ee([]);return}try{x(!0);const e=W(L(w,"users")),n=await B(e),a=[];n.forEach(d=>{var l;const i=d.data(),r=A.toLowerCase(),c=(i.nickname||"").toLowerCase(),p=(i.email||"").toLowerCase();(c.includes(r)||p.includes(r))&&d.id!==y.currentUser.uid&&a.push({id:d.id,nickname:i.nickname||((l=i.email)==null?void 0:l.split("@")[0])||"æœªå‘½åç”¨æˆ¶",email:i.email,avatarUrl:i.avatarUrl||"",isFriend:q.some(u=>u.id===d.id),hasPendingRequest:!1})}),ee(a)}catch(e){console.error("æœå°‹ç”¨æˆ¶å¤±æ•—:",e),g(t("community.messages.searchFail"))}finally{x(!1)}},Ae=async e=>{try{console.log("ğŸ“¤ é–‹å§‹ç™¼é€å¥½å‹é‚€è«‹..."),console.log("ç™¼é€è€…ID:",y.currentUser.uid),console.log("æ¥æ”¶è€…ID:",e),x(!0);const n=W(L(w,"friendInvitations"),$("fromUserId","==",y.currentUser.uid),$("toUserId","==",e),$("status","==","pending")),a=await B(n);if(!a.empty){console.log("âš ï¸ ç™¼ç¾å·²å­˜åœ¨çš„é‚€è«‹:",a.docs.length,"å€‹");const r=a.docs[0],c=r.data();console.log("ç¾æœ‰é‚€è«‹è³‡æ–™:",c);const p=new Date(c.createdAt);if((new Date-p)/(1e3*60*60)>24)console.log("ğŸ“… é‚€è«‹å·²è¶…é24å°æ™‚ï¼Œå…è¨±é‡æ–°ç™¼é€"),await be(D(w,"friendInvitations",r.id)),console.log("ğŸ—‘ï¸ å·²åˆªé™¤èˆŠé‚€è«‹");else{g(t("community.messages.inviteSent")),setTimeout(()=>{g("")},3e3);return}}const d={fromUserId:y.currentUser.uid,toUserId:e,status:"pending",createdAt:new Date().toISOString()};console.log("ğŸ“ é‚€è«‹è³‡æ–™:",d);const i=await Ue(L(w,"friendInvitations"),d);T.logWrite("addDoc","friendInvitations",i.id),console.log("âœ… é‚€è«‹å·²ç™¼é€ï¼Œæ–‡æª”ID:",i.id),F(t("community.messages.inviteSent"));try{const r=await ne(i);r.exists()?console.log("âœ… é‚€è«‹é©—è­‰æˆåŠŸ:",r.data()):console.error("âŒ é‚€è«‹é©—è­‰å¤±æ•—ï¼šæ–‡æª”ä¸å­˜åœ¨")}catch(r){console.error("âŒ é‚€è«‹é©—è­‰å¤±æ•—:",r)}ee(r=>r.map(c=>c.id===e?{...c,hasPendingRequest:!0}:c)),setTimeout(()=>{O()},1e3)}catch(n){console.error("ç™¼é€å¥½å‹é‚€è«‹å¤±æ•—:",n),g(t("community.messages.inviteSendFail"))}finally{x(!1)}},Ie=async(e,n)=>{try{x(!0),await re(D(w,"friendInvitations",e),{status:"accepted",updatedAt:new Date().toISOString()}),T.logWrite("updateDoc","friendInvitations",e);const a=D(w,"users",y.currentUser.uid);await re(a,{friends:Ge(n)}),T.logWrite("updateDoc","users",y.currentUser.uid,{friends:"arrayUnion"}),_(d=>({...d,friends:[...d.friends||[],n]})),await J(),await O(),F(t("community.messages.inviteAccepted"))}catch(a){console.error("æ¥å—å¥½å‹é‚€è«‹å¤±æ•—:",a),g(`${t("community.messages.inviteAcceptFail")}: ${a.message}`)}finally{x(!1)}},Le=async e=>{try{x(!0),await re(D(w,"friendInvitations",e),{status:"declined",updatedAt:new Date().toISOString()}),T.logWrite("updateDoc","friendInvitations",e),await O(),F(t("community.messages.inviteRejected"))}catch(n){console.error("æ‹’çµ•å¥½å‹é‚€è«‹å¤±æ•—:",n),g(`${t("community.messages.inviteRejectFail")}: ${n.message}`)}finally{x(!1)}},Te=e=>{if(!e){console.error("å¥½å‹IDç‚ºç©º");return}const n=q.find(a=>a.id===e);n?(console.log("ğŸ”„ è·³è½‰åˆ°å¥½å‹å€‹äººç‰ˆ:",e,n.nickname),v(`/friend-feed/${e}`)):(console.error("æ‰¾ä¸åˆ°å¥½å‹:",e),console.log("ç•¶å‰å¥½å‹åˆ—è¡¨:",q))},Me=async e=>{const n=q.find(r=>r.id===e),a=(n==null?void 0:n.nickname)||"å¥½å‹";if(!(!window.confirm(`ç¢ºå®šè¦ç§»é™¤å¥½å‹ã€Œ${a}ã€å—ï¼Ÿ

ç§»é™¤å¾Œï¼š
â€¢ é›™æ–¹å°‡ä¸å†æ˜¯å¥½å‹é—œä¿‚
â€¢ ç„¡æ³•æŸ¥çœ‹å°æ–¹çš„å‹•æ…‹
â€¢ æ­¤æ“ä½œå¯ä»¥é‡æ–°åŠ å¥½å‹ä¾†æ¢å¾©`)||!window.confirm(`æœ€å¾Œç¢ºèªï¼šç¢ºå®šè¦ç§»é™¤å¥½å‹ã€Œ${a}ã€å—ï¼Ÿæ­¤æ“ä½œå°‡ç«‹å³ç”Ÿæ•ˆã€‚`)))try{x(!0);const r=D(w,"users",y.currentUser.uid);await re(r,{friends:Qe(e)});const p=(await B(W(L(w,"friendInvitations"),$("fromUserId","in",[y.currentUser.uid,e]),$("toUserId","in",[y.currentUser.uid,e])))).docs.map(l=>re(l.ref,{status:"cancelled",cancelledAt:new Date().toISOString()}));await Promise.all(p),_(l=>{var u;return{...l,friends:((u=l.friends)==null?void 0:u.filter(N=>N!==e))||[]}}),Y(l=>l.filter(u=>u.id!==e)),F(`å·²ç§»é™¤å¥½å‹ã€Œ${a}ã€`)}catch(r){console.error("ç§»é™¤å¥½å‹å¤±æ•—:",r),g(`ç§»é™¤å¥½å‹å¤±æ•—: ${r.message}`)}finally{x(!1)}};return m.useEffect(()=>{try{ge(),J(),O()}catch(e){console.error("åˆå§‹è¼‰å…¥å¤±æ•—:",e),g("è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}return()=>{const e=te.current;e&&(e.forEach(n=>clearTimeout(n)),e.clear())}},[ge,J,O]),m.useEffect(()=>{try{P==="friends"&&!E.current?(console.log("ğŸ”„ æ¨™ç±¤åˆ‡æ›æ™‚é‡æ–°è¼‰å…¥å¥½å‹æ•¸æ“š"),J()):P==="requests"&&!me.current&&(console.log("ğŸ”„ æ¨™ç±¤åˆ‡æ›æ™‚é‡æ–°è¼‰å…¥é‚€è«‹æ•¸æ“š"),O())}catch(e){console.error("æ¨™ç±¤åˆ‡æ›è¼‰å…¥å¤±æ•—:",e),g("è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}},[P,J,O]),s.jsxs("div",{className:"community-page",children:[s.jsxs("div",{className:"community-header",children:[s.jsxs("h1",{children:["ğŸ  ",t("community.brandTitle")]}),M&&s.jsx("div",{className:"alert alert-error",children:M}),G&&s.jsx("div",{className:"alert alert-success",children:G})]}),!q&&s.jsx("div",{className:"alert alert-error",children:"è¼‰å…¥å¥½å‹åˆ—è¡¨æ™‚å‡ºç¾éŒ¯èª¤ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦"}),s.jsxs("div",{className:"tab-navigation",children:[!E.current&&s.jsx("div",{className:"loading-indicator",children:"æ­£åœ¨è¼‰å…¥å¥½å‹æ•¸æ“š..."}),s.jsx("div",{className:`tab-btn ${P==="feed"?"active":""}`,onClick:()=>z("feed"),children:s.jsx("span",{className:"tab-label",children:t("community.tabs.feed")})}),s.jsx("div",{className:`tab-btn ${P==="friends"?"active":""}`,onClick:()=>z("friends"),children:s.jsxs("span",{className:"tab-label",children:[t("community.tabs.friends")," (",E.current?q.length:"...",")"]})}),s.jsxs("div",{className:`tab-btn ${P==="requests"?"active":""}`,onClick:()=>z("requests"),children:[s.jsx("span",{className:"tab-label",children:t("community.tabs.invites")}),K.length>0&&s.jsx("span",{className:"notification-badge",children:K.length})]}),s.jsx("div",{className:`tab-btn ${P==="search"?"active":""}`,onClick:()=>z("search"),children:s.jsx("span",{className:"tab-label",children:t("community.tabs.search")})})]}),s.jsxs("div",{className:"tab-content",children:[Q&&s.jsx("div",{className:"loading",children:"è¼‰å…¥ä¸­..."}),M&&!Q&&s.jsxs("div",{className:"alert alert-error",children:[M,s.jsx("button",{onClick:()=>{le.current=!1,E.current=!1,me.current=!1,de.current.clear(),ue.current=0,g(""),ge(),J(),O()},style:{marginLeft:"10px",padding:"5px 10px",background:"#ff6b6b",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"é‡è©¦"})]}),!M&&!Q&&P==="feed"&&s.jsx("div",{className:"refresh-section",children:s.jsxs("button",{onClick:()=>{le.current=!1,E.current=!1,de.current.clear(),ue.current=0,J(),ge()},style:{padding:"8px 16px",background:"var(--tiffany-secondary)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",marginBottom:"10px"},children:["ğŸ”„ ",t("community.refresh")]})}),P==="feed"&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"post-composer",children:s.jsxs("div",{className:"composer-header",children:[s.jsx("div",{className:"user-avatar",children:s.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(o==null?void 0:o.avatarUrl)||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}})}),s.jsxs("div",{className:"composer-input",children:[s.jsx("textarea",{placeholder:t("community.sharePlaceholder"),value:H,onChange:e=>V(e.target.value),maxLength:500,disabled:X}),s.jsxs("div",{className:"composer-footer",children:[s.jsxs("span",{className:"char-count",children:[H.length,"/500"]}),s.jsx("button",{onClick:Se,disabled:!H.trim()||X,className:"publish-btn",children:t(X?"community.publishing":"community.publish")})]})]})]})}),s.jsx("div",{className:"posts-container",children:R.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.emptyFeed.title")}),s.jsx("p",{children:t("community.emptyFeed.subtitle")})]}):R.map(e=>{var n;return s.jsx(Ce,{post:e,currentUserId:(n=y.currentUser)==null?void 0:n.uid,onToggleLike:Pe,onAddComment:Fe,onDeleteComment:De,onDeletePost:$e,onLoadComments:Re,formatTime:qe,likeProcessing:se,commentProcessing:he},e.id)})})]}),P==="friends"&&s.jsx("div",{className:"friends-tab",children:!q||q.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.noFriends")}),s.jsx("p",{children:t("community.goSearchFriends")})]}):s.jsx("div",{className:"friends-list",children:q.filter(e=>e&&e.id).map(e=>s.jsxs("div",{className:"friend-item",children:[s.jsxs("div",{className:"friend-info",children:[s.jsx("img",{src:e.avatarUrl||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:n=>{n.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"friend-details",children:[s.jsx("div",{className:"friend-name",children:e.nickname||t("community.fallback.unnamedUser")}),s.jsx("div",{className:"friend-score",children:e.averageScore?s.jsx(s.Fragment,{children:s.jsxs("span",{className:"score-value",children:["ğŸ† ",e.averageScore,t("community.ui.pointsUnit")]})}):s.jsx("span",{className:"no-score",children:t("community.ui.noScore")})}),s.jsx("div",{className:"friend-email",children:e.email||""})]})]}),s.jsxs("div",{className:"friend-actions",children:[s.jsx("button",{className:"btn-board",onClick:()=>e.id&&Te(e.id),title:t("community.ui.boardTitle"),children:"ğŸ’¬"}),s.jsx("button",{className:"btn-remove",onClick:()=>e.id&&Me(e.id),title:t("community.friend.remove"),children:"âŒ"})]})]},e.id||"unknown"))})}),P==="requests"&&s.jsx("div",{className:"requests-tab",children:K.length===0?s.jsx("div",{className:"empty-state",children:s.jsx("p",{children:t("community.invites.empty")})}):s.jsx("div",{className:"requests-list",children:K.map(e=>s.jsxs("div",{className:"request-item",children:[s.jsxs("div",{className:"request-info",children:[s.jsx("img",{src:e.avatarUrl||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),className:"request-avatar",loading:"lazy",onError:n=>{n.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"request-details",children:[s.jsx("div",{className:"request-name",children:e.nickname}),s.jsx("div",{className:"request-email",children:e.email})]})]}),s.jsxs("div",{className:"request-actions",children:[s.jsx("button",{className:"btn-accept",onClick:()=>Ie(e.id,e.fromUserId),title:t("community.invites.accept"),children:"âœ…"}),s.jsx("button",{className:"btn-decline",onClick:()=>Le(e.id),title:t("community.invites.reject"),children:"âŒ"})]})]},e.id))})}),P==="search"&&s.jsxs("div",{className:"search-tab",children:[s.jsxs("div",{className:"search-container",children:[s.jsx("input",{type:"text",placeholder:t("community.search.placeholder"),value:A,onChange:e=>U(e.target.value),onKeyPress:e=>{e.key==="Enter"&&Ne()},className:"search-input"}),s.jsx("button",{onClick:Ne,className:"search-btn",children:t("common.search")})]}),s.jsx("div",{className:"search-results",children:Z.length===0&&A.trim()?s.jsx("div",{className:"empty-state",children:s.jsx("p",{children:t("community.search.empty")})}):Z.map(e=>s.jsxs("div",{className:"user-item",children:[s.jsxs("div",{className:"user-info",children:[s.jsx("img",{src:e.avatarUrl||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onError:n=>{n.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"user-details",children:[s.jsx("div",{className:"user-name",children:e.nickname}),s.jsx("div",{className:"user-email",children:e.email})]})]}),s.jsx("div",{className:"user-actions",children:e.isFriend?s.jsx("span",{className:"status-badge",children:t("community.friend.badgeFriend")}):e.hasPendingRequest?s.jsx("span",{className:"status-badge",children:t("community.friend.badgeInvited")}):s.jsx("button",{className:"btn-add",onClick:()=>Ae(e.id),disabled:Q,title:t("community.friend.add"),children:t("community.friend.add")})})]},e.id))})]})]})]})},Ce=We.memo(({post:v,currentUserId:o,onToggleLike:_,onAddComment:t,onDeleteComment:ae,onDeletePost:P,onLoadComments:z,formatTime:R,likeProcessing:C,commentProcessing:Q})=>{const{t:x}=ke(),[M,g]=m.useState(!1),[G,F]=m.useState(""),[H,V]=m.useState(!1),[X,ie]=m.useState(!1),q=v.likes.includes(o),Y=v.likes.length,K=v.commentCount||v.comments.length,oe=()=>{const U=!M;g(U),U&&!X&&z&&(z(v.id),ie(!0))},A=()=>{G.trim()&&(t(v.id,G),F(""))};return s.jsxs("div",{className:"post-card",children:[s.jsxs("div",{className:"post-header",children:[s.jsxs("div",{className:"post-user",children:[s.jsx("img",{src:v.userAvatarUrl||"/default-avatar.svg",alt:x("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onLoad:()=>V(!0),onError:U=>{U.target.src="/default-avatar.svg",V(!0)},style:{opacity:H?1:.5,transition:"opacity 0.3s ease"}}),s.jsxs("div",{className:"user-info",children:[s.jsxs("div",{className:"user-name",children:[v.userNickname,v.targetUserId&&s.jsxs("span",{className:"to-label",children:[" ","â†’"," ",v.targetUserNickname||x("community.friend.badgeFriend")]})]}),s.jsx("div",{className:"post-time",children:R(v.timestamp)})]})]}),v.userId===o&&s.jsx("button",{onClick:()=>P(v.id),className:"delete-post-btn",title:x("community.titles.deletePost"),children:"ğŸ—‘ï¸"})]}),s.jsx("div",{className:"post-content",children:v.content}),s.jsxs("div",{className:"post-actions",children:[s.jsxs("button",{onClick:()=>_(v.id,v.likes),className:`action-btn ${q?"liked":""}`,disabled:C.has(v.id),children:[s.jsx("span",{className:"action-icon",children:C.has(v.id)?"â³":"ğŸ‘"}),s.jsx("span",{className:"action-text",children:C.has(v.id)?x("community.processing"):`${Y>0?Y:""} ${x("community.like")}`})]}),s.jsxs("button",{onClick:oe,className:"action-btn",children:[s.jsx("span",{className:"action-icon",children:"ğŸ’¬"}),s.jsxs("span",{className:"action-text",children:[K>0?K:""," ",x("community.comment")]})]})]}),M&&s.jsxs("div",{className:"comments-section",children:[v.comments.length>0&&s.jsx("div",{className:"comments-list",children:v.comments.map(U=>{const Z=v.userId===o,ee=U.userId===o,se=Z||ee;return s.jsxs("div",{className:"comment-item",children:[s.jsxs("div",{className:"comment-header",children:[s.jsxs("div",{className:"comment-user-info",children:[s.jsx("img",{src:U.userAvatarUrl||"/guest-avatar.svg",alt:x("community.ui.avatarAlt"),className:"comment-avatar",onError:ce=>{ce.target.src="/guest-avatar.svg"}}),s.jsxs("div",{className:"comment-text-info",children:[s.jsx("div",{className:"comment-name",children:U.userNickname}),s.jsx("div",{className:"comment-time",children:R(U.timestamp)})]})]}),se&&s.jsx("button",{onClick:()=>ae(v.id,U.id),className:"comment-delete-btn",title:x(Z?"community.titles.deleteComment":"community.titles.deleteMyComment"),children:"ğŸ—‘ï¸"})]}),s.jsx("div",{className:"comment-content",children:U.content})]},U.id)})}),s.jsxs("div",{className:"comment-input",children:[s.jsx("input",{type:"text",placeholder:x("community.writeComment"),value:G,onChange:U=>F(U.target.value),onKeyPress:U=>{U.key==="Enter"&&A()}}),s.jsx("button",{onClick:A,disabled:!G.trim()||Q.has(v.id),className:"comment-btn",children:Q.has(v.id)?x("community.sending"):x("community.send")})]})]})]})});Ce.propTypes={post:k.shape({id:k.string.isRequired,userId:k.string.isRequired,userNickname:k.string.isRequired,userAvatarUrl:k.string,content:k.string.isRequired,timestamp:k.any.isRequired,likes:k.array.isRequired,comments:k.array.isRequired}).isRequired,currentUserId:k.string.isRequired,onToggleLike:k.func.isRequired,onAddComment:k.func.isRequired,onDeleteComment:k.func.isRequired,onDeletePost:k.func.isRequired,onLoadComments:k.func.isRequired,formatTime:k.func.isRequired,likeProcessing:k.instanceOf(Set).isRequired,commentProcessing:k.instanceOf(Set).isRequired};export{Ve as default};
