import{u as V,j as e,a as d,d as b}from"./index-D6kyeCUu.js";import{r as g,d as K,u as $}from"./react-vendor-Jhh8OXpo.js";import{A as J,l as A,m as Q,s as P,G as L,B as X,D as Y,E as Z,n as ee}from"./firebase-BtrGMGg1.js";import{P as N}from"./charts-D1I5GTBR.js";import{P as se}from"./PrivacyPolicyModal-BdfKq7AB.js";function W({onLogin:v,onError:l}){const[w,u]=g.useState(!1),{t:y}=V(),S=/wv|WebView/.test(navigator.userAgent);g.useEffect(()=>{(async()=>{try{const a=await J(d);if(a){const n=a.user;console.log("Google 重定向登入成功:",n.email),await m(n),v(n.email,null)}}catch(a){console.error("處理重定向結果失敗:",a),a.message.includes("missing initial state")||a.message.includes("sessionStorage")?l("WebView 環境登入失敗，請嘗試使用標準瀏覽器或聯繫客服"):l("登入處理失敗，請重試")}})()},[v,l]);const m=async s=>{try{const a=A(b,"users",s.uid);if((await Q(a)).exists())await P(a,{lastActive:new Date().toISOString(),updatedAt:new Date().toISOString()},{merge:!0}),console.log("現有用戶資料已更新");else{const I={email:s.email,userId:s.uid,nickname:s.displayName||s.email.split("@")[0],avatarUrl:s.photoURL||"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:0,weight:0,age:0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};await P(a,I),console.log("新用戶資料已創建")}}catch(a){throw console.error("處理用戶資料失敗:",a),a}},h=async()=>{try{const s=new L;s.setCustomParameters({prompt:"select_account"}),console.log("WebView 環境：使用 Firebase signInWithRedirect"),await X(d,s)}catch(s){console.error("WebView Google 登入失敗:",s),s.message.includes("missing initial state")||s.message.includes("sessionStorage")?l("WebView 環境登入失敗，請嘗試使用標準瀏覽器或聯繫客服"):l("登入失敗，請重試"),u(!1)}},j=async()=>{try{const s=new L;s.setCustomParameters({prompt:"select_account"}),console.log("標準瀏覽器：使用 popup 登入");const n=(await Y(d,s)).user;console.log("Google popup 登入成功:",n.email),await m(n),v(n.email,null)}catch(s){console.error("標準瀏覽器 Google 登入失敗:",s);let a="登入失敗";s.code==="auth/popup-closed-by-user"?a="登入視窗被關閉，請重試":s.code==="auth/popup-blocked"?a="彈出視窗被阻擋，請允許彈出視窗後重試":s.code==="auth/account-exists-with-different-credential"?a="此電子郵件已被其他方式註冊，請使用原註冊方式登入":a=`登入失敗：${s.message}`,l(a),u(!1)}},p=async()=>{u(!0);try{S?await h():await j()}catch(s){console.error("Google 登入失敗:",s),l("登入失敗，請重試"),u(!1)}};return e.jsxs("div",{className:"social-login-container",children:[e.jsx("div",{className:"divider",children:e.jsx("span",{children:y("common.or")})}),e.jsx("div",{className:"social-buttons",children:e.jsxs("button",{type:"button",className:"social-btn google-btn",onClick:p,disabled:w,children:[e.jsxs("svg",{className:"google-icon",viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),y(w?"login.processing":"login.google")]})})]})}W.propTypes={onLogin:N.func.isRequired,onError:N.func.isRequired};function te({onLogin:v}){const[l,w]=g.useState(""),[u,y]=g.useState(""),[S,m]=g.useState(null),[h,j]=g.useState(!1),[p,s]=g.useState(!1),[a,n]=g.useState(!1),[I,E]=g.useState(!1),x=K(),F=$(),{t:o,i18n:R}=V(),G=t=>{const r=t.target.validity;r.valueMissing?t.target.setCustomValidity(o("errors.emailRequired")):r.typeMismatch?t.target.setCustomValidity(o("errors.emailInvalid")):t.target.setCustomValidity(o("errors.invalidFormat"))},T=t=>{const r=t.target.validity;r.valueMissing?t.target.setCustomValidity(o("errors.passwordRequired")):r.tooShort?t.target.setCustomValidity(o("errors.passwordTooShort")):t.target.setCustomValidity(o("errors.invalidFormat"))},{height:C,weight:k,age:M}=F.state||{};g.useEffect(()=>{if(console.log("檢查 auth 初始化狀態:",d),!d){m("Firebase 未正確初始化，請檢查配置");return}const t=d.onAuthStateChanged(c=>{c&&(console.log("用戶已登入:",c.email),x("/user-info"))}),r=localStorage.getItem("savedEmail"),i=localStorage.getItem("savedPassword");return r&&i&&(console.log("從 localStorage 恢復帳號:",r),w(r),y(i),n(!0)),()=>t()},[x]);const q=async t=>{t.preventDefault(),m(null),await O()},O=async()=>{var t,r;if(s(!0),console.log("開始處理表單提交，isRegistering:",h,"email:",l),!d||!b){const i="Firebase 未正確初始化，請檢查配置";console.error(i,{auth:d,db:b}),m(i),s(!1);return}if(((r=(t=d.app)==null?void 0:t.options)==null?void 0:r.apiKey)==="demo-api-key"){const i="Firebase 使用 demo 配置，無法進行真實認證。請檢查環境變數配置。";console.error(i),m(i),s(!1);return}try{let i;if(h){console.log("嘗試註冊用戶:",l),i=await Z(d,l,u);const f=i.user;console.log("註冊成功，用戶:",f.email,"UID:",f.uid);const _=A(b,"users",f.uid),D={email:f.email,userId:f.uid,nickname:f.email.split("@")[0],avatarUrl:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:C?parseFloat(C):0,weight:k?parseFloat(k):0,age:M?parseInt(M,10):0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};console.log("儲存初始用戶數據:",D),await P(_,D),console.log("用戶數據已儲存，文檔 ID:",f.uid)}else console.log("嘗試登入用戶:",l),i=await ee(d,l,u),console.log("登入成功，用戶:",i.user.email,"UID:",i.user.uid);const c=i.user;console.log("調用 onLogin 回調函數"),v(c.email,u),a?(console.log("儲存帳號到 localStorage:",l),localStorage.setItem("savedEmail",l),localStorage.setItem("savedPassword",u)):(console.log("清除 localStorage 中的帳號"),localStorage.removeItem("savedEmail"),localStorage.removeItem("savedPassword")),setTimeout(()=>{console.log("導航到 /user-info"),x("/user-info")},500)}catch(i){console.error("登入/註冊失敗:",i.code,i.message);let c=i.message;i.code==="auth/user-not-found"?c="找不到此電子郵件帳號，請檢查是否輸入正確或先註冊":i.code==="auth/wrong-password"?c="密碼錯誤，請重新輸入":i.code==="auth/invalid-email"?c="電子郵件格式不正確":i.code==="auth/weak-password"?c="密碼強度不足，請使用至少6個字符":i.code==="auth/email-already-in-use"&&(c="此電子郵件已被使用，請直接登入或使用其他郵箱註冊"),m(c)}finally{s(!1)}},U=()=>{console.log("社交登入成功，導航到 /user-info"),x("/user-info")},z=t=>{m(t)},H=()=>{sessionStorage.setItem("guestMode","true"),x("/user-info")},B=()=>{localStorage.setItem("privacyPolicyViewed","true")};return e.jsxs("div",{className:"login-container",children:[e.jsx("h1",{className:"text-2xl font-bold text-center mb-6",children:o(h?"login.register":"login.login")}),S&&e.jsx("p",{className:"error-message",children:S}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:o("login.email")}),e.jsx("input",{type:"email",value:l,onChange:t=>w(t.target.value),placeholder:o("login.emailPlaceholder"),className:"input-field",required:!0,onInvalid:G,onInput:t=>t.currentTarget.setCustomValidity(""),disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:o("login.password")}),e.jsx("input",{type:"password",value:u,onChange:t=>y(t.target.value),placeholder:o("login.passwordPlaceholder"),className:"input-field",required:!0,minLength:6,onInvalid:T,onInput:t=>t.currentTarget.setCustomValidity(""),disabled:p})]}),e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"flex-end",marginBottom:"8px"},children:e.jsxs("label",{htmlFor:"rememberMe",style:{display:"flex",alignItems:"center",cursor:"pointer",whiteSpace:"nowrap",fontSize:"14px",color:"#555"},children:[e.jsx("input",{id:"rememberMe",type:"checkbox",checked:a,onChange:t=>n(t.target.checked),disabled:p,style:{margin:0}}),e.jsx("span",{style:{marginLeft:"6px"},children:o("login.rememberMe")})]})}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:p,children:o(p?"common.loading":h?"login.register":"login.login")})]}),e.jsx("button",{onClick:()=>j(!h),className:"toggle-btn",children:o(h?"login.switchToLogin":"login.switchToRegister")}),e.jsx("button",{onClick:H,className:"guest-btn",disabled:p,children:o("login.guestMode")}),e.jsx("div",{className:"privacy-notice",children:R.language&&R.language.toLowerCase().startsWith("zh")?e.jsxs("p",{children:["若繼續操作，即表示你同意最強肉體",e.jsx("a",{className:"privacy-link",href:"/terms",children:"使用條款"}),"。請參閱我們的",e.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"隱私權政策"}),"。"]}):e.jsxs("p",{children:["By continuing, you agree to the Ultimate Physique",e.jsx("a",{className:"privacy-link",href:"/terms",children:"Terms of Service"}),". Please review our",e.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"Privacy Policy"}),"."]})}),e.jsx(W,{onLogin:U,onError:z}),e.jsxs("div",{className:"instructions-container",children:[e.jsx("h2",{className:"instructions-title",children:o("login.instructions.title")}),e.jsxs("ul",{className:"instructions-list",children:[e.jsxs("li",{children:[e.jsx("strong",{children:o("login.instructions.items.fair.title")}),"：",o("login.instructions.items.fair.desc")]}),e.jsxs("li",{children:[e.jsx("strong",{children:o("login.instructions.items.analysis.title")}),"：",o("login.instructions.items.analysis.desc")]}),e.jsxs("li",{children:[e.jsx("strong",{children:o("login.instructions.items.tracking.title")}),"：",o("login.instructions.items.tracking.desc")]})]})]}),e.jsx(se,{isOpen:I,onClose:()=>E(!1),onAccept:B})]})}te.propTypes={onLogin:N.func.isRequired};export{te as default};
