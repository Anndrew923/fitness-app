import{u as Ee,a as Ue,b as y,d as j,m as I,j as s}from"./index-u_ODcrAP.js";import{d as Oe,r as g,R as We}from"./react-vendor-BToktFYo.js";import{t as K,q as L,v as Be,x as Qe,y as J,m as ne,l as P,s as xe,D as we,w as T,H as be,z as re,I as ze,J as Ge}from"./firebase-D0136ThQ.js";import{P as b}from"./charts-BNGpwEcn.js";const Ve=()=>{var Ne;const v=Oe(),{userData:o,setUserData:_}=Ee(),{t,i18n:ae}=Ue(),[k,W]=g.useState("feed"),[C,U]=g.useState([]),[B,x]=g.useState(!0),[M,h]=g.useState(""),[Q,R]=g.useState(""),[z,V]=g.useState(""),[X,ie]=g.useState(!1),[F,Y]=g.useState([]),[G,oe]=g.useState([]),[D,w]=g.useState(""),[Z,ee]=g.useState([]),[se,ce]=g.useState(new Set),[he,pe]=g.useState(new Set),te=g.useRef(new Map),E=g.useRef(!1),le=g.useRef(!1),me=g.useRef(!1),de=g.useRef(new Map),ue=g.useRef(0),ye=300*1e3,fe=g.useRef(new Map),ve=g.useRef(new Map),A=g.useMemo(()=>{var e;return(e=y.currentUser)==null?void 0:e.uid},[(Ne=y.currentUser)==null?void 0:Ne.uid]);g.useMemo(()=>{const e=(o==null?void 0:o.friends)||[];return[A,...e].filter(Boolean)},[A,o==null?void 0:o.friends]),g.useMemo(()=>D.trim()?C.filter(e=>e.content.toLowerCase().includes(D.toLowerCase())||e.userNickname.toLowerCase().includes(D.toLowerCase())):C,[C,D]);const ge=g.useCallback(async()=>{if(!y.currentUser||!o){console.log("🚫 用戶未登入或資料未載入，跳過載入動態");return}const e=Date.now(),n=de.current.get("posts");if(n&&e-n.timestamp<ye){console.log("📦 使用快取動態數據"),U(n.data);return}if(le.current&&e-ue.current<ye){console.log("⏰ 動態數據仍在有效期限內，跳過重新載入");return}console.log("🔄 開始載入動態..."),x(!0),h("");try{const a=(o==null?void 0:o.friends)||[],u=[A,...a].filter(Boolean);console.log(`🔍 當前用戶ID: ${A}`),console.log(`🔍 好友列表: ${a.join(", ")}`),console.log(`🔍 允許查看的用戶: ${u.join(", ")}`),console.log(`🔍 總共 ${u.length} 個用戶的動態需要載入`);const i=K(L(j,"communityPosts"),Be("timestamp","desc"),Qe(50)),r=await J(i),l=[],d=[];r.forEach(f=>{const p=f.data(),$={id:f.id,userId:p.userId,userNickname:p.userNickname,userAvatarUrl:p.userAvatarUrl,content:p.content,timestamp:p.timestamp,likes:p.likes||[],commentCount:(p.comments||[]).length,comments:[],type:p.type||"status",targetUserId:p.targetUserId};p.targetUserId?d.push($):u.includes(p.userId)&&l.push($)});const c=Array.from(new Set(d.map(f=>f.targetUserId).filter(Boolean))).filter(f=>!fe.current.has(f));c.length>0&&await Promise.all(c.map(async f=>{var p;try{const $=await ne(P(j,"users",f)),S=$.exists()?$.data():null,Me=Array.isArray(S==null?void 0:S.friends)?S.friends:[];fe.current.set(f,Me),ve.current.set(f,{nickname:(S==null?void 0:S.nickname)||((p=S==null?void 0:S.email)==null?void 0:p.split("@")[0])||t("community.fallback.user"),avatarUrl:(S==null?void 0:S.avatarUrl)||""})}catch($){console.warn("讀取目標用戶好友失敗:",f,$),fe.current.set(f,[]),ve.current.set(f,{nickname:t("community.fallback.user"),avatarUrl:""})}}));const m=d.filter(f=>A===f.userId||A===f.targetUserId?!0:(fe.current.get(f.targetUserId)||[]).includes(A)).map(f=>{var p;return{...f,targetUserNickname:((p=ve.current.get(f.targetUserId))==null?void 0:p.nickname)||""}}),N=[...l,...m];N.sort((f,p)=>{const $=f.timestamp?new Date(f.timestamp):new Date(f.date);return(p.timestamp?new Date(p.timestamp):new Date(p.date))-$});const q=N.slice(0,30);console.log(`📊 載入完成：共 ${q.length} 條動態`),U(q),le.current=!0,ue.current=e,de.current.set("posts",{data:q,timestamp:e})}catch(a){console.error("載入動態失敗:",a),h(t("community.messages.loadFeedError"))}finally{x(!1)}},[o==null?void 0:o.friends,ye]),Ce=async()=>{var e;if(!z.trim()){h(t("community.messages.emptyPost"));return}if(!y.currentUser){h(t("community.messages.needLogin"));return}try{ie(!0),console.log("📝 準備發布動態...");const n={userId:y.currentUser.uid,userNickname:(o==null?void 0:o.nickname)||((e=o==null?void 0:o.email)==null?void 0:e.split("@")[0])||t("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(o==null?void 0:o.avatarUrl)||"",content:z.trim(),type:"status",likes:[],comments:[],timestamp:new Date().toISOString(),privacy:"friends"},a=await be(L(j,"communityPosts"),n);I.logWrite("addDoc","communityPosts",a.id),console.log("✅ 動態發布成功，ID:",a.id);const u={id:a.id,...n};console.log("🔄 更新本地狀態，添加新動態:",u.id),U(i=>{const r=[u,...i];return console.log(`📊 更新後動態總數: ${r.length}`),r}),V(""),R(t("community.messages.publishSuccess")),setTimeout(()=>R(""),3e3)}catch(n){console.error("❌ 發布動態失敗:",n),h(`${t("community.messages.publishFail")}: ${n.message}`)}finally{ie(!1)}},Se=g.useCallback(async(e,n)=>{if(!y.currentUser){h(t("community.messages.needLogin"));return}if(se.has(e)){console.log("🔄 點讚操作進行中，請稍候...");return}const a=n.includes(A),u=a?n.filter(i=>i!==A):[...n,A];U(i=>i.map(r=>r.id===e?{...r,likes:u}:r)),ce(i=>new Set(i).add(e));try{const i=P(j,"communityPosts",e);await xe(i,{likes:u},{merge:!0}),I.logWrite("setDoc","communityPosts",e,{likes:`更新為 ${u.length} 個點讚`}),console.log(`👍 ${a?"取消點讚":"點讚"}成功`)}catch(i){console.error("❌ 點讚操作失敗:",i),h(t("community.messages.likeFail")),U(r=>r.map(l=>l.id===e?{...l,likes:n}:l))}finally{ce(i=>{const r=new Set(i);return r.delete(e),r})}},[se,y.currentUser,U]),Re=g.useCallback(async e=>{if(y.currentUser)try{const n=P(j,"communityPosts",e),a=await ne(n);if(a.exists()){const i=a.data().comments||[];U(r=>r.map(l=>l.id===e?{...l,comments:i}:l)),console.log(`💬 載入評論完成：${i.length} 條評論`)}}catch(n){console.error("❌ 載入評論失敗:",n)}},[]),Pe=g.useCallback(async(e,n)=>{var i;if(!n.trim())return;if(!y.currentUser){h(t("community.messages.needLogin"));return}if(he.has(e)){console.log("🔄 留言提交中，請稍候...");return}const a={id:Date.now().toString(),userId:y.currentUser.uid,userNickname:(o==null?void 0:o.nickname)||((i=o==null?void 0:o.email)==null?void 0:i.split("@")[0])||t("community.fallback.anonymousUser"),userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(o==null?void 0:o.avatarUrl)||"",content:n.trim(),timestamp:new Date().toISOString()};U(r=>r.map(d=>{if(d.id===e){const c=[...d.comments,a];return{...d,comments:c}}return d})),pe(r=>new Set(r).add(e)),te.current.has(e)&&clearTimeout(te.current.get(e));const u=setTimeout(async()=>{try{const r=C.find(c=>c.id===e);if(!r){h(t("community.messages.postNotFound"));return}const l=[...r.comments,a],d=P(j,"communityPosts",e);await xe(d,{comments:l},{merge:!0}),I.logWrite("setDoc","communityPosts",e,{comments:`新增留言，總計 ${l.length} 條`}),console.log("💬 留言添加成功")}catch(r){console.error("❌ 添加留言失敗:",r),h(t("community.messages.commentFail")),U(l=>l.map(c=>{if(c.id===e){const m=c.comments.filter(N=>N.id!==a.id);return{...c,comments:m}}return c}))}finally{pe(r=>{const l=new Set(r);return l.delete(e),l}),te.current.delete(e)}},500);te.current.set(e,u)},[y.currentUser,o==null?void 0:o.nickname,o==null?void 0:o.email,o==null?void 0:o.avatarUrl,he,C,U]),Fe=g.useCallback(async(e,n)=>{if(!y.currentUser){h(t("community.messages.needLogin"));return}try{const a=C.find(N=>N.id===e);if(!a){h(t("community.messages.postNotFound"));return}const u=a.comments.find(N=>N.id===n);if(!u){h(t("community.messages.commentNotFound"));return}const i=y.currentUser.uid,r=a.userId===i,l=u.userId===i;if(!r&&!l){h(t("community.messages.noPermission"));return}const d=t(r?"community.confirm.deleteComment":"community.confirm.deleteMyComment");if(!window.confirm(d))return;const c=a.comments.filter(N=>N.id!==n),m=P(j,"communityPosts",e);await xe(m,{comments:c},{merge:!0}),I.logWrite("setDoc","communityPosts",e,{comments:`刪除留言，總計 ${c.length} 條`}),console.log("🔄 更新本地狀態，刪除留言:",n),U(N=>{const q=N.map(f=>f.id===e?{...f,comments:c}:f);return console.log(`📊 動態 ${e} 留言數: ${c.length}`),q}),R(t("community.messages.deleteCommentSuccess")),setTimeout(()=>R(""),3e3)}catch(a){console.error("❌ 刪除留言失敗:",a),h(t("community.messages.deleteCommentFail"))}},[C]),De=g.useCallback(async e=>{if(!y.currentUser){h(t("community.messages.needLogin"));return}try{const n=C.find(i=>i.id===e);if(!n){h(t("community.messages.postNotFound"));return}const a=y.currentUser.uid;if(n.userId!==a){h(t("community.messages.noPermission"));return}if(!window.confirm(t("community.confirm.deletePost")))return;const u=P(j,"communityPosts",e);await we(u),I.logWrite("deleteDoc","communityPosts",e,{action:"刪除動態"}),console.log("🔄 更新本地狀態，刪除動態:",e),U(i=>{const r=i.filter(l=>l.id!==e);return console.log(`📊 剩餘動態數: ${r.length}`),r}),R(t("community.messages.deletePostSuccess")),setTimeout(()=>R(""),3e3)}catch(n){console.error("❌ 刪除動態失敗:",n),h(t("community.messages.deletePostFail"))}},[C]),$e=g.useCallback(e=>{const n=new Date,a=new Date(e),u=n-a,i=Math.floor(u/(1e3*60)),r=Math.floor(u/(1e3*60*60)),l=Math.floor(u/(1e3*60*60*24));if(i<1)return t("community.time.justNow");if(i<60)return t("community.time.minutesAgo",{count:i});if(r<24)return t("community.time.hoursAgo",{count:r});if(l<7)return t("community.time.daysAgo",{count:l});try{return new Intl.DateTimeFormat(ae.language).format(a)}catch{return a.toLocaleDateString()}},[ae.language,t]),H=g.useCallback(async()=>{var e;try{if(E.current)return;x(!0);const n=K(L(j,"friendInvitations"),T("status","==","accepted")),a=await J(n),u=new Set;a.forEach(d=>{const c=d.data();c.fromUserId===y.currentUser.uid?u.add(c.toUserId):c.toUserId===y.currentUser.uid&&u.add(c.fromUserId)});const i=[];for(const d of u)try{const c=await ne(P(j,"users",d));if(c.exists()){const m=c.data();if(!m){console.warn(`好友 ${d} 的用戶數據為空`);continue}console.log(`✅ 載入好友資料: ${d} - ${m.nickname||m.email}`);let N=0,q=0;if(m.scores){const f=[];m.scores.strength&&m.scores.strength>0&&f.push(m.scores.strength),m.scores.explosivePower&&m.scores.explosivePower>0&&f.push(m.scores.explosivePower),m.scores.cardio&&m.scores.cardio>0&&f.push(m.scores.cardio),m.scores.muscleMass&&m.scores.muscleMass>0&&f.push(m.scores.muscleMass),m.scores.bodyFat&&m.scores.bodyFat>0&&f.push(m.scores.bodyFat),console.log(`好友 ${d} 的評分數據:`,m.scores),console.log(`好友 ${d} 的有效分數:`,f),f.length>0&&(N=f.reduce((p,$)=>p+$,0)/f.length,q=f.length,console.log(`好友 ${d} 平均分數: ${N}, 項目數: ${q}`))}else console.log(`好友 ${d} 沒有評分數據`);i.push({id:d,nickname:m.nickname||((e=m.email)==null?void 0:e.split("@")[0])||"未命名用戶",email:m.email||"",avatarUrl:m.avatarUrl||"",averageScore:N>0?Number(N).toFixed(2):null,scoreCount:q,lastActive:m.lastActive})}}catch(c){console.error(`載入好友 ${d} 數據失敗:`,c)}const r=i.filter(d=>d&&d.id&&typeof d.nickname=="string");Y(r);const l=Array.from(u);_(d=>({...d,friends:l})),E.current=!0}catch(n){console.error("載入好友數據失敗:",n),h(t("community.messages.loadFriendsFail")),E.current=!0}finally{x(!1)}},[]),O=g.useCallback(async()=>{var e;try{console.log("🔍 開始載入好友邀請..."),console.log("當前用戶ID:",y.currentUser.uid);const n=K(L(j,"friendInvitations"),T("toUserId","==",y.currentUser.uid)),a=await J(n);console.log("📋 找到所有邀請數量:",a.docs.length),a.docs.forEach((l,d)=>{const c=l.data();console.log(`邀請 ${d+1}:`,{id:l.id,fromUserId:c.fromUserId,toUserId:c.toUserId,status:c.status,createdAt:c.createdAt})});const u=K(L(j,"friendInvitations"),T("toUserId","==",y.currentUser.uid),T("status","==","pending")),i=await J(u);console.log("📋 找到pending邀請數量:",i.docs.length);const r=[];for(const l of i.docs){const d=l.data();try{const c=await ne(P(j,"users",d.fromUserId));if(c.exists()){const m=c.data();r.push({id:l.id,fromUserId:d.fromUserId,nickname:m.nickname||((e=m.email)==null?void 0:e.split("@")[0])||"未命名用戶",email:m.email,avatarUrl:m.avatarUrl||"",createdAt:d.createdAt})}}catch(c){console.error("獲取邀請用戶信息失敗:",c)}}console.log("✅ 載入完成，邀請列表:",r),oe(r),me.current=!0}catch(n){console.error("載入好友邀請失敗:",n),me.current=!0}},[oe]),je=async()=>{if(!D.trim()){ee([]);return}try{x(!0);const e=K(L(j,"users")),n=await J(e),a=[];n.forEach(u=>{var c;const i=u.data(),r=D.toLowerCase(),l=(i.nickname||"").toLowerCase(),d=(i.email||"").toLowerCase();(l.includes(r)||d.includes(r))&&u.id!==y.currentUser.uid&&a.push({id:u.id,nickname:i.nickname||((c=i.email)==null?void 0:c.split("@")[0])||"未命名用戶",email:i.email,avatarUrl:i.avatarUrl||"",isFriend:F.some(m=>m.id===u.id),hasPendingRequest:!1})}),ee(a)}catch(e){console.error("搜尋用戶失敗:",e),h(t("community.messages.searchFail"))}finally{x(!1)}},Ae=async e=>{try{console.log("📤 開始發送好友邀請..."),console.log("發送者ID:",y.currentUser.uid),console.log("接收者ID:",e),x(!0);const n=K(L(j,"friendInvitations"),T("fromUserId","==",y.currentUser.uid),T("toUserId","==",e),T("status","==","pending")),a=await J(n);if(!a.empty){console.log("⚠️ 發現已存在的邀請:",a.docs.length,"個");const r=a.docs[0],l=r.data();console.log("現有邀請資料:",l);const d=new Date(l.createdAt);if((new Date-d)/(1e3*60*60)>24)console.log("📅 邀請已超過24小時，允許重新發送"),await we(P(j,"friendInvitations",r.id)),console.log("🗑️ 已刪除舊邀請");else{h(t("community.messages.inviteSent")),setTimeout(()=>{h("")},3e3);return}}const u={fromUserId:y.currentUser.uid,toUserId:e,status:"pending",createdAt:new Date().toISOString()};console.log("📝 邀請資料:",u);const i=await be(L(j,"friendInvitations"),u);I.logWrite("addDoc","friendInvitations",i.id),console.log("✅ 邀請已發送，文檔ID:",i.id),R(t("community.messages.inviteSent"));try{const r=await ne(i);r.exists()?console.log("✅ 邀請驗證成功:",r.data()):console.error("❌ 邀請驗證失敗：文檔不存在")}catch(r){console.error("❌ 邀請驗證失敗:",r)}ee(r=>r.map(l=>l.id===e?{...l,hasPendingRequest:!0}:l)),setTimeout(()=>{O()},1e3)}catch(n){console.error("發送好友邀請失敗:",n),h(t("community.messages.inviteSendFail"))}finally{x(!1)}},qe=async(e,n)=>{try{x(!0),await re(P(j,"friendInvitations",e),{status:"accepted",acceptedAt:new Date().toISOString()}),I.logWrite("updateDoc","friendInvitations",e);const a=P(j,"users",y.currentUser.uid);await re(a,{friends:Ge(n)}),I.logWrite("updateDoc","users",y.currentUser.uid,{friends:"arrayUnion"}),_(u=>({...u,friends:[...u.friends||[],n]})),await H(),await O(),R(t("community.messages.inviteAccepted"))}catch(a){console.error("接受好友邀請失敗:",a),h(`${t("community.messages.inviteAcceptFail")}: ${a.message}`)}finally{x(!1)}},Ie=async e=>{try{x(!0),await re(P(j,"friendInvitations",e),{status:"declined",declinedAt:new Date().toISOString()}),I.logWrite("updateDoc","friendInvitations",e),await O(),R(t("community.messages.inviteRejected"))}catch(n){console.error("拒絕好友邀請失敗:",n),h(`${t("community.messages.inviteRejectFail")}: ${n.message}`)}finally{x(!1)}},Le=e=>{if(!e){console.error("好友ID為空");return}const n=F.find(a=>a.id===e);n?(console.log("🔄 跳轉到好友個人版:",e,n.nickname),v(`/friend-feed/${e}`)):(console.error("找不到好友:",e),console.log("當前好友列表:",F))},Te=async e=>{const n=F.find(r=>r.id===e),a=(n==null?void 0:n.nickname)||"好友";if(!(!window.confirm(`確定要移除好友「${a}」嗎？

移除後：
• 雙方將不再是好友關係
• 無法查看對方的動態
• 此操作可以重新加好友來恢復`)||!window.confirm(`最後確認：確定要移除好友「${a}」嗎？此操作將立即生效。`)))try{x(!0);const r=P(j,"users",y.currentUser.uid);await re(r,{friends:ze(e)});const d=(await J(K(L(j,"friendInvitations"),T("fromUserId","in",[y.currentUser.uid,e]),T("toUserId","in",[y.currentUser.uid,e])))).docs.map(c=>re(c.ref,{status:"cancelled",cancelledAt:new Date().toISOString()}));await Promise.all(d),_(c=>{var m;return{...c,friends:((m=c.friends)==null?void 0:m.filter(N=>N!==e))||[]}}),Y(c=>c.filter(m=>m.id!==e)),R(`已移除好友「${a}」`)}catch(r){console.error("移除好友失敗:",r),h(`移除好友失敗: ${r.message}`)}finally{x(!1)}};return g.useEffect(()=>{try{ge(),H(),O()}catch(e){console.error("初始載入失敗:",e),h("載入數據失敗，請稍後再試")}return()=>{const e=te.current;e&&(e.forEach(n=>clearTimeout(n)),e.clear())}},[ge,H,O]),g.useEffect(()=>{try{k==="friends"&&!E.current?(console.log("🔄 標籤切換時重新載入好友數據"),H()):k==="requests"&&!me.current&&(console.log("🔄 標籤切換時重新載入邀請數據"),O())}catch(e){console.error("標籤切換載入失敗:",e),h("載入數據失敗，請稍後再試")}},[k,H,O]),s.jsxs("div",{className:"community-page",children:[s.jsxs("div",{className:"community-header",children:[s.jsx("h1",{children:"🏠 肉體樂園"}),M&&s.jsx("div",{className:"alert alert-error",children:M}),Q&&s.jsx("div",{className:"alert alert-success",children:Q})]}),!F&&s.jsx("div",{className:"alert alert-error",children:"載入好友列表時出現錯誤，請刷新頁面重試"}),s.jsxs("div",{className:"tab-navigation",children:[!E.current&&s.jsx("div",{className:"loading-indicator",children:"正在載入好友數據..."}),s.jsx("div",{className:`tab-btn ${k==="feed"?"active":""}`,onClick:()=>W("feed"),children:s.jsx("span",{className:"tab-label",children:t("community.tabs.feed")})}),s.jsx("div",{className:`tab-btn ${k==="friends"?"active":""}`,onClick:()=>W("friends"),children:s.jsxs("span",{className:"tab-label",children:[t("community.tabs.friends")," (",E.current?F.length:"...",")"]})}),s.jsxs("div",{className:`tab-btn ${k==="requests"?"active":""}`,onClick:()=>W("requests"),children:[s.jsx("span",{className:"tab-label",children:t("community.tabs.invites")}),G.length>0&&s.jsx("span",{className:"notification-badge",children:G.length})]}),s.jsx("div",{className:`tab-btn ${k==="search"?"active":""}`,onClick:()=>W("search"),children:s.jsx("span",{className:"tab-label",children:t("community.tabs.search")})})]}),s.jsxs("div",{className:"tab-content",children:[B&&s.jsx("div",{className:"loading",children:"載入中..."}),M&&!B&&s.jsxs("div",{className:"alert alert-error",children:[M,s.jsx("button",{onClick:()=>{le.current=!1,E.current=!1,me.current=!1,de.current.clear(),ue.current=0,h(""),ge(),H(),O()},style:{marginLeft:"10px",padding:"5px 10px",background:"#ff6b6b",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"重試"})]}),!M&&!B&&k==="feed"&&s.jsx("div",{className:"refresh-section",children:s.jsxs("button",{onClick:()=>{le.current=!1,E.current=!1,de.current.clear(),ue.current=0,H(),ge()},style:{padding:"8px 16px",background:"var(--tiffany-secondary)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",marginBottom:"10px"},children:["🔄 ",t("community.refresh")]})}),k==="feed"&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"post-composer",children:s.jsxs("div",{className:"composer-header",children:[s.jsx("div",{className:"user-avatar",children:s.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(o==null?void 0:o.avatarUrl)||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}})}),s.jsxs("div",{className:"composer-input",children:[s.jsx("textarea",{placeholder:t("community.sharePlaceholder"),value:z,onChange:e=>V(e.target.value),maxLength:500,disabled:X}),s.jsxs("div",{className:"composer-footer",children:[s.jsxs("span",{className:"char-count",children:[z.length,"/500"]}),s.jsx("button",{onClick:Ce,disabled:!z.trim()||X,className:"publish-btn",children:t(X?"community.publishing":"community.publish")})]})]})]})}),s.jsx("div",{className:"posts-container",children:C.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.emptyFeed.title")}),s.jsx("p",{children:t("community.emptyFeed.subtitle")})]}):C.map(e=>{var n;return s.jsx(ke,{post:e,currentUserId:(n=y.currentUser)==null?void 0:n.uid,onToggleLike:Se,onAddComment:Pe,onDeleteComment:Fe,onDeletePost:De,onLoadComments:Re,formatTime:$e,likeProcessing:se,commentProcessing:he},e.id)})})]}),k==="friends"&&s.jsx("div",{className:"friends-tab",children:!F||F.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.noFriends")}),s.jsx("p",{children:t("community.goSearchFriends")})]}):s.jsx("div",{className:"friends-list",children:F.filter(e=>e&&e.id).map(e=>s.jsxs("div",{className:"friend-item",children:[s.jsxs("div",{className:"friend-info",children:[s.jsx("img",{src:e.avatarUrl||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:n=>{n.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"friend-details",children:[s.jsx("div",{className:"friend-name",children:e.nickname||t("community.fallback.unnamedUser")}),s.jsx("div",{className:"friend-score",children:e.averageScore?s.jsx(s.Fragment,{children:s.jsxs("span",{className:"score-value",children:["🏆 ",e.averageScore,t("community.ui.pointsUnit")]})}):s.jsx("span",{className:"no-score",children:t("community.ui.noScore")})}),s.jsx("div",{className:"friend-email",children:e.email||""})]})]}),s.jsxs("div",{className:"friend-actions",children:[s.jsx("button",{className:"btn-board",onClick:()=>e.id&&Le(e.id),title:t("community.ui.boardTitle"),children:"💬"}),s.jsx("button",{className:"btn-remove",onClick:()=>e.id&&Te(e.id),title:t("community.friend.remove"),children:"❌"})]})]},e.id||"unknown"))})}),k==="requests"&&s.jsx("div",{className:"requests-tab",children:G.length===0?s.jsx("div",{className:"empty-state",children:s.jsx("p",{children:t("community.invites.empty")})}):s.jsx("div",{className:"requests-list",children:G.map(e=>s.jsxs("div",{className:"request-item",children:[s.jsxs("div",{className:"request-info",children:[s.jsx("img",{src:e.avatarUrl||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),className:"request-avatar",loading:"lazy",onError:n=>{n.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"request-details",children:[s.jsx("div",{className:"request-name",children:e.nickname}),s.jsx("div",{className:"request-email",children:e.email})]})]}),s.jsxs("div",{className:"request-actions",children:[s.jsx("button",{className:"btn-accept",onClick:()=>qe(e.id,e.fromUserId),title:t("community.invites.accept"),children:"✅"}),s.jsx("button",{className:"btn-decline",onClick:()=>Ie(e.id),title:t("community.invites.reject"),children:"❌"})]})]},e.id))})}),k==="search"&&s.jsxs("div",{className:"search-tab",children:[s.jsxs("div",{className:"search-container",children:[s.jsx("input",{type:"text",placeholder:t("community.search.placeholder"),value:D,onChange:e=>w(e.target.value),onKeyPress:e=>{e.key==="Enter"&&je()},className:"search-input"}),s.jsx("button",{onClick:je,className:"search-btn",children:t("common.search")})]}),s.jsx("div",{className:"search-results",children:Z.length===0&&D.trim()?s.jsx("div",{className:"empty-state",children:s.jsx("p",{children:t("community.search.empty")})}):Z.map(e=>s.jsxs("div",{className:"user-item",children:[s.jsxs("div",{className:"user-info",children:[s.jsx("img",{src:e.avatarUrl||"/default-avatar.svg",alt:t("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onError:n=>{n.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"user-details",children:[s.jsx("div",{className:"user-name",children:e.nickname}),s.jsx("div",{className:"user-email",children:e.email})]})]}),s.jsx("div",{className:"user-actions",children:e.isFriend?s.jsx("span",{className:"status-badge",children:t("community.friend.badgeFriend")}):e.hasPendingRequest?s.jsx("span",{className:"status-badge",children:t("community.friend.badgeInvited")}):s.jsx("button",{className:"btn-add",onClick:()=>Ae(e.id),disabled:B,title:t("community.friend.add"),children:t("community.friend.add")})})]},e.id))})]})]})]})},ke=We.memo(({post:v,currentUserId:o,onToggleLike:_,onAddComment:t,onDeleteComment:ae,onDeletePost:k,onLoadComments:W,formatTime:C,likeProcessing:U,commentProcessing:B})=>{const{t:x}=Ue(),[M,h]=g.useState(!1),[Q,R]=g.useState(""),[z,V]=g.useState(!1),[X,ie]=g.useState(!1),F=v.likes.includes(o),Y=v.likes.length,G=v.commentCount||v.comments.length,oe=()=>{const w=!M;h(w),w&&!X&&W&&(W(v.id),ie(!0))},D=()=>{Q.trim()&&(t(v.id,Q),R(""))};return s.jsxs("div",{className:"post-card",children:[s.jsxs("div",{className:"post-header",children:[s.jsxs("div",{className:"post-user",children:[s.jsx("img",{src:v.userAvatarUrl||"/default-avatar.svg",alt:x("community.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onLoad:()=>V(!0),onError:w=>{w.target.src="/default-avatar.svg",V(!0)},style:{opacity:z?1:.5,transition:"opacity 0.3s ease"}}),s.jsxs("div",{className:"user-info",children:[s.jsxs("div",{className:"user-name",children:[v.userNickname,v.targetUserId&&s.jsxs("span",{className:"to-label",children:[" ","→"," ",v.targetUserNickname||x("community.friend.badgeFriend")]})]}),s.jsx("div",{className:"post-time",children:C(v.timestamp)})]})]}),v.userId===o&&s.jsx("button",{onClick:()=>k(v.id),className:"delete-post-btn",title:x("community.titles.deletePost"),children:"🗑️"})]}),s.jsx("div",{className:"post-content",children:v.content}),s.jsxs("div",{className:"post-actions",children:[s.jsxs("button",{onClick:()=>_(v.id,v.likes),className:`action-btn ${F?"liked":""}`,disabled:U.has(v.id),children:[s.jsx("span",{className:"action-icon",children:U.has(v.id)?"⏳":"👍"}),s.jsx("span",{className:"action-text",children:U.has(v.id)?x("community.processing"):`${Y>0?Y:""} ${x("community.like")}`})]}),s.jsxs("button",{onClick:oe,className:"action-btn",children:[s.jsx("span",{className:"action-icon",children:"💬"}),s.jsxs("span",{className:"action-text",children:[G>0?G:""," ",x("community.comment")]})]})]}),M&&s.jsxs("div",{className:"comments-section",children:[v.comments.length>0&&s.jsx("div",{className:"comments-list",children:v.comments.map(w=>{const Z=v.userId===o,ee=w.userId===o,se=Z||ee;return s.jsxs("div",{className:"comment-item",children:[s.jsxs("div",{className:"comment-header",children:[s.jsxs("div",{className:"comment-user-info",children:[s.jsx("img",{src:w.userAvatarUrl||"/guest-avatar.svg",alt:x("community.ui.avatarAlt"),className:"comment-avatar",onError:ce=>{ce.target.src="/guest-avatar.svg"}}),s.jsxs("div",{className:"comment-text-info",children:[s.jsx("div",{className:"comment-name",children:w.userNickname}),s.jsx("div",{className:"comment-time",children:C(w.timestamp)})]})]}),se&&s.jsx("button",{onClick:()=>ae(v.id,w.id),className:"comment-delete-btn",title:x(Z?"community.titles.deleteComment":"community.titles.deleteMyComment"),children:"🗑️"})]}),s.jsx("div",{className:"comment-content",children:w.content})]},w.id)})}),s.jsxs("div",{className:"comment-input",children:[s.jsx("input",{type:"text",placeholder:x("community.writeComment"),value:Q,onChange:w=>R(w.target.value),onKeyPress:w=>{w.key==="Enter"&&D()}}),s.jsx("button",{onClick:D,disabled:!Q.trim()||B.has(v.id),className:"comment-btn",children:B.has(v.id)?x("community.sending"):x("community.send")})]})]})]})});ke.propTypes={post:b.shape({id:b.string.isRequired,userId:b.string.isRequired,userNickname:b.string.isRequired,userAvatarUrl:b.string,content:b.string.isRequired,timestamp:b.any.isRequired,likes:b.array.isRequired,comments:b.array.isRequired}).isRequired,currentUserId:b.string.isRequired,onToggleLike:b.func.isRequired,onAddComment:b.func.isRequired,onDeleteComment:b.func.isRequired,onDeletePost:b.func.isRequired,onLoadComments:b.func.isRequired,formatTime:b.func.isRequired,likeProcessing:b.instanceOf(Set).isRequired,commentProcessing:b.instanceOf(Set).isRequired};export{Ve as default};
