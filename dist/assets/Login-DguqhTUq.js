const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-MvWwl5vB.js","assets/index-sblVo7W9.js","assets/react-vendor-Jhh8OXpo.js","assets/firebase-rILKUpaA.js","assets/charts-D1I5GTBR.js","assets/index-zm5P2N5Y.css"])))=>i.map(i=>d[i]);
import{h as K,_ as J,d as j,u as L,j as s,a as w}from"./index-sblVo7W9.js";import{r as d,d as Q,u as X}from"./react-vendor-Jhh8OXpo.js";import{l as M,m as Y,s as A,A as Z,n as ee}from"./firebase-rILKUpaA.js";import{P as k}from"./charts-D1I5GTBR.js";import{P as se}from"./PrivacyPolicyModal-pvzqfOV7.js";const I=K("GoogleAuth",{web:()=>J(()=>import("./web-MvWwl5vB.js"),__vite__mapDeps([0,1,2,3,4,5])).then(v=>new v.GoogleAuthWeb)});class U{static async initialize(){try{console.log("ğŸ” åˆå§‹åŒ– Capacitor Google Auth...");const e=window.navigator.userAgent.includes("wv")||window.navigator.userAgent.includes("WebView"),r=window.Capacitor!==void 0;return console.log("ğŸ” ç’°å¢ƒæª¢æ¸¬:",{isWebView:e,isCapacitor:r}),console.log("ğŸ” ç•¶å‰é…ç½®æª¢æŸ¥:"),console.log("- strings.xml server_client_id: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- capacitor.config.json serverClientId: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- AndroidManifest.xml GOOGLE_SIGN_IN_CLIENT_ID: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- æº–å‚™åˆå§‹åŒ–å¤–æ›..."),await I.initialize({clientId:"5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com",scopes:["profile","email"],grantOfflineAccess:!0}),console.log("âœ… Google Auth åˆå§‹åŒ–æˆåŠŸ"),!0}catch(e){return console.error("âŒ Google Auth åˆå§‹åŒ–å¤±æ•—:",e),console.error("ğŸ” åˆå§‹åŒ–éŒ¯èª¤è©³æƒ…:",{message:e.message,code:e.code,stack:e.stack}),!1}}static async signIn(){try{console.log("ğŸ”„ é–‹å§‹ Google ç™»å…¥..."),console.log("ğŸ” ç™»å…¥å‰æª¢æŸ¥:"),console.log("- å¤–æ›ç‹€æ…‹: å·²åˆå§‹åŒ–"),console.log("- Client ID: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- ç’°å¢ƒ: Android WebView");const e=new Promise((h,g)=>{setTimeout(()=>g(new Error("ç™»å…¥è¶…æ™‚")),3e4)}),r=I.signIn(),i=await Promise.race([r,e]);if(console.log("âœ… Google ç™»å…¥æˆåŠŸ:",i),!i||!i.id||!i.email)throw new Error("ç™»å…¥çµæœä¸å®Œæ•´");return await this.convertToFirebaseUser(i)}catch(e){if(console.error("âŒ Google ç™»å…¥å¤±æ•—:",e),console.error("ğŸ” éŒ¯èª¤è©³æƒ…:",{message:e.message,code:e.code,stack:e.stack}),e.message.includes("Something went wrong")&&(console.error("ğŸ” å¯èƒ½åŸå› åˆ†æ:"),console.error("1. Client ID é…ç½®ä¸æ­£ç¢º"),console.error("2. Google Console è¨­å®šå•é¡Œ"),console.error("3. å¤–æ›ç‰ˆæœ¬ç›¸å®¹æ€§å•é¡Œ"),console.error("4. Android WebView æ¬Šé™å•é¡Œ"),console.error("ğŸ” å»ºè­°æª¢æŸ¥:"),console.error("- Firebase Console > Authentication > Sign-in method > Google"),console.error("- Google Cloud Console > OAuth 2.0 å®¢æˆ¶ç«¯ ID"),console.error("- Android æ‡‰ç”¨ç¨‹å¼ç°½å (SHA-1)")),e.message.includes("Something went wrong")||e.message.includes("androidBridge")||e.message.includes("iu:"))return console.log("ğŸ”„ æª¢æ¸¬åˆ°é€šä¿¡éŒ¯èª¤ï¼Œå˜—è©¦é‡è©¦..."),await this.retrySignIn();throw e}}static async retrySignIn(e=0){if(e>=3)throw new Error("é‡è©¦æ¬¡æ•¸å·²é”ä¸Šé™");try{await new Promise(h=>setTimeout(h,1e3*(e+1))),console.log(`ğŸ”„ ç¬¬ ${e+1} æ¬¡é‡è©¦...`),console.log("ğŸ” é‡è©¦å‰æª¢æŸ¥: Client ID = 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com");const i=await I.signIn();if(!i||!i.id||!i.email)throw new Error("ç™»å…¥çµæœä¸å®Œæ•´");return await this.convertToFirebaseUser(i)}catch(i){if(console.error(`âŒ ç¬¬ ${e+1} æ¬¡é‡è©¦å¤±æ•—:`,i),console.error("ğŸ” é‡è©¦éŒ¯èª¤è©³æƒ…:",{message:i.message,code:i.code,retryCount:e+1}),e<2)return await this.retrySignIn(e+1);throw i}}static async convertToFirebaseUser(e){try{console.log("ğŸ”„ è½‰æ› Google çµæœç‚º Firebase ç”¨æˆ¶..."),console.log("ğŸ” Google çµæœ:",e);const r={uid:e.id,email:e.email,displayName:e.name,photoURL:e.imageUrl,emailVerified:!0,providerData:[{providerId:"google.com",uid:e.id,email:e.email,displayName:e.name,photoURL:e.imageUrl}]};return console.log("âœ… Firebase ç”¨æˆ¶è³‡æ–™:",r),await this.saveUserToFirestore(r),r}catch(r){throw console.error("âŒ è½‰æ› Firebase ç”¨æˆ¶å¤±æ•—:",r),r}}static async saveUserToFirestore(e){try{console.log("ğŸ”„ ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ° Firestore...");const r=M(j,"users",e.uid);if((await Y(r)).exists())await A(r,{lastActive:new Date().toISOString(),updatedAt:new Date().toISOString()},{merge:!0}),console.log("âœ… ç¾æœ‰ç”¨æˆ¶è³‡æ–™å·²æ›´æ–°");else{const m={email:e.email,userId:e.uid,nickname:e.displayName||e.email.split("@")[0],avatarUrl:e.photoURL||"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:0,weight:0,age:0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};await A(r,m),console.log("âœ… æ–°ç”¨æˆ¶è³‡æ–™å·²å‰µå»º")}}catch(r){throw console.error("âŒ ä¿å­˜ç”¨æˆ¶è³‡æ–™å¤±æ•—:",r),r}}static async signOut(){try{console.log("ğŸ”„ é–‹å§‹ Google ç™»å‡º..."),await I.signOut(),console.log("âœ… Google ç™»å‡ºæˆåŠŸ")}catch(e){throw console.error("âŒ Google ç™»å‡ºå¤±æ•—:",e),e}}static async checkAuthState(){try{return await I.refresh()}catch{return console.log("ç”¨æˆ¶æœªç™»å…¥æˆ– token å·²éæœŸ"),null}}}function F({onLogin:v,onError:e}){const[r,i]=d.useState(!1),[m,h]=d.useState(!1),[g,p]=d.useState(0),{t:S}=L();d.useEffect(()=>{(async()=>{try{const l=console.error;console.error=(...x)=>{x[0]&&x[0].includes("androidBridge")&&console.log("ğŸ” æª¢æ¸¬åˆ° Bridge é€šä¿¡éŒ¯èª¤ï¼Œå˜—è©¦é‡æ–°åˆå§‹åŒ–..."),l.apply(console,x)},await U.initialize(),h(!0),console.log("âœ… Google Auth åˆå§‹åŒ–å®Œæˆ")}catch(l){console.error("âŒ Google Auth åˆå§‹åŒ–å¤±æ•—:",l),h(!1)}})()},[]);const f=async()=>{if(!m){e("Google ç™»å…¥æœå‹™å°šæœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œé‡è©¦");return}i(!0),p(0);try{console.log("ğŸ”„ é–‹å§‹ Google ç™»å…¥æµç¨‹...");const a=await U.signIn();console.log("âœ… Google ç™»å…¥æˆåŠŸ:",a.email),v(a.email,null)}catch(a){console.error("âŒ Google ç™»å…¥å¤±æ•—:",a);let l="Google ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦";a.message.includes("Something went wrong")?l="ç™»å…¥æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œé‡è©¦":a.message.includes("androidBridge")?l="ç™»å…¥é€šä¿¡éŒ¯èª¤ï¼Œè«‹é‡è©¦":a.message.includes("cancelled")?l="ç™»å…¥å·²å–æ¶ˆ":a.message.includes("network")&&(l="ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦"),e(l)}finally{i(!1)}};return s.jsxs("div",{className:"social-login-container",children:[s.jsx("div",{className:"divider",children:s.jsx("span",{children:S("common.or")})}),s.jsx("div",{className:"social-buttons",children:s.jsxs("button",{type:"button",className:"social-btn google-btn",onClick:f,disabled:r||!m,children:[s.jsxs("svg",{className:"google-icon",viewBox:"0 0 24 24",children:[s.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),s.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),s.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),s.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),S(r?"login.processing":"login.google")]})}),!m&&s.jsx("div",{className:"initialization-status",children:s.jsx("small",{children:"æ­£åœ¨åˆå§‹åŒ– Google ç™»å…¥æœå‹™..."})}),g>0&&s.jsx("div",{className:"retry-status",children:s.jsxs("small",{children:["æ­£åœ¨é‡è©¦ç™»å…¥... (",g,"/3)"]})})]})}F.propTypes={onLogin:k.func.isRequired,onError:k.func.isRequired};function oe({onLogin:v}){const[e,r]=d.useState(""),[i,m]=d.useState(""),[h,g]=d.useState(null),[p,S]=d.useState(!1),[f,a]=d.useState(!1),[l,x]=d.useState(!1),[T,D]=d.useState(!1),b=Q(),R=X(),{t,i18n:G}=L(),O=o=>{const c=o.target.validity;c.valueMissing?o.target.setCustomValidity(t("errors.emailRequired")):c.typeMismatch?o.target.setCustomValidity(t("errors.emailInvalid")):o.target.setCustomValidity(t("errors.invalidFormat"))},V=o=>{const c=o.target.validity;c.valueMissing?o.target.setCustomValidity(t("errors.passwordRequired")):c.tooShort?o.target.setCustomValidity(t("errors.passwordTooShort")):o.target.setCustomValidity(t("errors.invalidFormat"))},{height:P,weight:N,age:C}=R.state||{};d.useEffect(()=>{if(console.log("æª¢æŸ¥ auth åˆå§‹åŒ–ç‹€æ…‹:",w),!w){g("Firebase æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥é…ç½®");return}const o=w.onAuthStateChanged(u=>{u&&(console.log("ç”¨æˆ¶å·²ç™»å…¥:",u.email),b("/user-info"))}),c=localStorage.getItem("savedEmail"),n=localStorage.getItem("savedPassword");return c&&n&&(console.log("å¾ localStorage æ¢å¾©å¸³è™Ÿ:",c),r(c),m(n),x(!0)),()=>o()},[b]);const _=async o=>{o.preventDefault(),g(null),await z()},z=async()=>{var o,c;if(a(!0),console.log("é–‹å§‹è™•ç†è¡¨å–®æäº¤ï¼ŒisRegistering:",p,"email:",e),!w||!j){const n="Firebase æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥é…ç½®";console.error(n,{auth:w,db:j}),g(n),a(!1);return}if(((c=(o=w.app)==null?void 0:o.options)==null?void 0:c.apiKey)==="demo-api-key"){const n="Firebase ä½¿ç”¨ demo é…ç½®ï¼Œç„¡æ³•é€²è¡ŒçœŸå¯¦èªè­‰ã€‚è«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®ã€‚";console.error(n),g(n),a(!1);return}try{let n;if(p){console.log("å˜—è©¦è¨»å†Šç”¨æˆ¶:",e),n=await Z(w,e,i);const y=n.user;console.log("è¨»å†ŠæˆåŠŸï¼Œç”¨æˆ¶:",y.email,"UID:",y.uid);const $=M(j,"users",y.uid),E={email:y.email,userId:y.uid,nickname:y.email.split("@")[0],avatarUrl:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:P?parseFloat(P):0,weight:N?parseFloat(N):0,age:C?parseInt(C,10):0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};console.log("å„²å­˜åˆå§‹ç”¨æˆ¶æ•¸æ“š:",E),await A($,E),console.log("ç”¨æˆ¶æ•¸æ“šå·²å„²å­˜ï¼Œæ–‡æª” ID:",y.uid)}else console.log("å˜—è©¦ç™»å…¥ç”¨æˆ¶:",e),n=await ee(w,e,i),console.log("ç™»å…¥æˆåŠŸï¼Œç”¨æˆ¶:",n.user.email,"UID:",n.user.uid);const u=n.user;console.log("èª¿ç”¨ onLogin å›èª¿å‡½æ•¸"),v(u.email,i),l?(console.log("å„²å­˜å¸³è™Ÿåˆ° localStorage:",e),localStorage.setItem("savedEmail",e),localStorage.setItem("savedPassword",i)):(console.log("æ¸…é™¤ localStorage ä¸­çš„å¸³è™Ÿ"),localStorage.removeItem("savedEmail"),localStorage.removeItem("savedPassword")),setTimeout(()=>{console.log("å°èˆªåˆ° /user-info"),b("/user-info")},500)}catch(n){console.error("ç™»å…¥/è¨»å†Šå¤±æ•—:",n.code,n.message);let u=n.message;n.code==="auth/user-not-found"?u="æ‰¾ä¸åˆ°æ­¤é›»å­éƒµä»¶å¸³è™Ÿï¼Œè«‹æª¢æŸ¥æ˜¯å¦è¼¸å…¥æ­£ç¢ºæˆ–å…ˆè¨»å†Š":n.code==="auth/wrong-password"?u="å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥":n.code==="auth/invalid-email"?u="é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º":n.code==="auth/weak-password"?u="å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘6å€‹å­—ç¬¦":n.code==="auth/email-already-in-use"&&(u="æ­¤é›»å­éƒµä»¶å·²è¢«ä½¿ç”¨ï¼Œè«‹ç›´æ¥ç™»å…¥æˆ–ä½¿ç”¨å…¶ä»–éƒµç®±è¨»å†Š"),g(u)}finally{a(!1)}},q=()=>{console.log("ç¤¾äº¤ç™»å…¥æˆåŠŸï¼Œå°èˆªåˆ° /user-info"),b("/user-info")},W=o=>{g(o)},B=()=>{sessionStorage.setItem("guestMode","true"),b("/user-info")},H=()=>{localStorage.setItem("privacyPolicyViewed","true")};return s.jsxs("div",{className:"login-container",children:[s.jsx("h1",{className:"text-2xl font-bold text-center mb-6",children:t(p?"login.register":"login.login")}),h&&s.jsx("p",{className:"error-message",children:h}),s.jsxs("form",{onSubmit:_,className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.email")}),s.jsx("input",{type:"email",value:e,onChange:o=>r(o.target.value),placeholder:t("login.emailPlaceholder"),className:"input-field",required:!0,onInvalid:O,onInput:o=>o.currentTarget.setCustomValidity(""),disabled:f})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.password")}),s.jsx("input",{type:"password",value:i,onChange:o=>m(o.target.value),placeholder:t("login.passwordPlaceholder"),className:"input-field",required:!0,minLength:6,onInvalid:V,onInput:o=>o.currentTarget.setCustomValidity(""),disabled:f})]}),s.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"flex-end",marginBottom:"8px"},children:s.jsxs("label",{htmlFor:"rememberMe",style:{display:"flex",alignItems:"center",cursor:"pointer",whiteSpace:"nowrap",fontSize:"14px",color:"#555"},children:[s.jsx("input",{id:"rememberMe",type:"checkbox",checked:l,onChange:o=>x(o.target.checked),disabled:f,style:{margin:0}}),s.jsx("span",{style:{marginLeft:"6px"},children:t("login.rememberMe")})]})}),s.jsx("button",{type:"submit",className:"submit-btn",disabled:f,children:t(f?"common.loading":p?"login.register":"login.login")})]}),s.jsx("button",{onClick:()=>S(!p),className:"toggle-btn",children:t(p?"login.switchToLogin":"login.switchToRegister")}),s.jsx("button",{onClick:B,className:"guest-btn",disabled:f,children:t("login.guestMode")}),s.jsx("div",{className:"privacy-notice",children:G.language&&G.language.toLowerCase().startsWith("zh")?s.jsxs("p",{children:["è‹¥ç¹¼çºŒæ“ä½œï¼Œå³è¡¨ç¤ºä½ åŒæ„æœ€å¼·è‚‰é«”",s.jsx("a",{className:"privacy-link",href:"/terms",children:"ä½¿ç”¨æ¢æ¬¾"}),"ã€‚è«‹åƒé–±æˆ‘å€‘çš„",s.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"éš±ç§æ¬Šæ”¿ç­–"}),"ã€‚"]}):s.jsxs("p",{children:["By continuing, you agree to the Ultimate Physique",s.jsx("a",{className:"privacy-link",href:"/terms",children:"Terms of Service"}),". Please review our",s.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"Privacy Policy"}),"."]})}),s.jsx(F,{onLogin:q,onError:W}),s.jsxs("div",{className:"instructions-container",children:[s.jsx("h2",{className:"instructions-title",children:t("login.instructions.title")}),s.jsxs("ul",{className:"instructions-list",children:[s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.fair.title")}),"ï¼š",t("login.instructions.items.fair.desc")]}),s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.analysis.title")}),"ï¼š",t("login.instructions.items.analysis.desc")]}),s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.tracking.title")}),"ï¼š",t("login.instructions.items.tracking.desc")]})]})]}),s.jsx(se,{isOpen:T,onClose:()=>D(!1),onAccept:H})]})}oe.propTypes={onLogin:k.func.isRequired};export{oe as default};
