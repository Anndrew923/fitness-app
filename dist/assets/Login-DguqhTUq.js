const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-MvWwl5vB.js","assets/index-sblVo7W9.js","assets/react-vendor-Jhh8OXpo.js","assets/firebase-rILKUpaA.js","assets/charts-D1I5GTBR.js","assets/index-zm5P2N5Y.css"])))=>i.map(i=>d[i]);
import{h as K,_ as J,d as j,u as L,j as s,a as w}from"./index-sblVo7W9.js";import{r as d,d as Q,u as X}from"./react-vendor-Jhh8OXpo.js";import{l as M,m as Y,s as A,A as Z,n as ee}from"./firebase-rILKUpaA.js";import{P as k}from"./charts-D1I5GTBR.js";import{P as se}from"./PrivacyPolicyModal-pvzqfOV7.js";const I=K("GoogleAuth",{web:()=>J(()=>import("./web-MvWwl5vB.js"),__vite__mapDeps([0,1,2,3,4,5])).then(v=>new v.GoogleAuthWeb)});class U{static async initialize(){try{console.log("🔍 初始化 Capacitor Google Auth...");const e=window.navigator.userAgent.includes("wv")||window.navigator.userAgent.includes("WebView"),r=window.Capacitor!==void 0;return console.log("🔍 環境檢測:",{isWebView:e,isCapacitor:r}),console.log("🔍 當前配置檢查:"),console.log("- strings.xml server_client_id: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- capacitor.config.json serverClientId: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- AndroidManifest.xml GOOGLE_SIGN_IN_CLIENT_ID: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- 準備初始化外掛..."),await I.initialize({clientId:"5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com",scopes:["profile","email"],grantOfflineAccess:!0}),console.log("✅ Google Auth 初始化成功"),!0}catch(e){return console.error("❌ Google Auth 初始化失敗:",e),console.error("🔍 初始化錯誤詳情:",{message:e.message,code:e.code,stack:e.stack}),!1}}static async signIn(){try{console.log("🔄 開始 Google 登入..."),console.log("🔍 登入前檢查:"),console.log("- 外掛狀態: 已初始化"),console.log("- Client ID: 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com"),console.log("- 環境: Android WebView");const e=new Promise((h,g)=>{setTimeout(()=>g(new Error("登入超時")),3e4)}),r=I.signIn(),i=await Promise.race([r,e]);if(console.log("✅ Google 登入成功:",i),!i||!i.id||!i.email)throw new Error("登入結果不完整");return await this.convertToFirebaseUser(i)}catch(e){if(console.error("❌ Google 登入失敗:",e),console.error("🔍 錯誤詳情:",{message:e.message,code:e.code,stack:e.stack}),e.message.includes("Something went wrong")&&(console.error("🔍 可能原因分析:"),console.error("1. Client ID 配置不正確"),console.error("2. Google Console 設定問題"),console.error("3. 外掛版本相容性問題"),console.error("4. Android WebView 權限問題"),console.error("🔍 建議檢查:"),console.error("- Firebase Console > Authentication > Sign-in method > Google"),console.error("- Google Cloud Console > OAuth 2.0 客戶端 ID"),console.error("- Android 應用程式簽名 (SHA-1)")),e.message.includes("Something went wrong")||e.message.includes("androidBridge")||e.message.includes("iu:"))return console.log("🔄 檢測到通信錯誤，嘗試重試..."),await this.retrySignIn();throw e}}static async retrySignIn(e=0){if(e>=3)throw new Error("重試次數已達上限");try{await new Promise(h=>setTimeout(h,1e3*(e+1))),console.log(`🔄 第 ${e+1} 次重試...`),console.log("🔍 重試前檢查: Client ID = 5144099869-6kes2gchrinle0io7dl8c12f83rgfso6.apps.googleusercontent.com");const i=await I.signIn();if(!i||!i.id||!i.email)throw new Error("登入結果不完整");return await this.convertToFirebaseUser(i)}catch(i){if(console.error(`❌ 第 ${e+1} 次重試失敗:`,i),console.error("🔍 重試錯誤詳情:",{message:i.message,code:i.code,retryCount:e+1}),e<2)return await this.retrySignIn(e+1);throw i}}static async convertToFirebaseUser(e){try{console.log("🔄 轉換 Google 結果為 Firebase 用戶..."),console.log("🔍 Google 結果:",e);const r={uid:e.id,email:e.email,displayName:e.name,photoURL:e.imageUrl,emailVerified:!0,providerData:[{providerId:"google.com",uid:e.id,email:e.email,displayName:e.name,photoURL:e.imageUrl}]};return console.log("✅ Firebase 用戶資料:",r),await this.saveUserToFirestore(r),r}catch(r){throw console.error("❌ 轉換 Firebase 用戶失敗:",r),r}}static async saveUserToFirestore(e){try{console.log("🔄 保存用戶資料到 Firestore...");const r=M(j,"users",e.uid);if((await Y(r)).exists())await A(r,{lastActive:new Date().toISOString(),updatedAt:new Date().toISOString()},{merge:!0}),console.log("✅ 現有用戶資料已更新");else{const m={email:e.email,userId:e.uid,nickname:e.displayName||e.email.split("@")[0],avatarUrl:e.photoURL||"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:0,weight:0,age:0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};await A(r,m),console.log("✅ 新用戶資料已創建")}}catch(r){throw console.error("❌ 保存用戶資料失敗:",r),r}}static async signOut(){try{console.log("🔄 開始 Google 登出..."),await I.signOut(),console.log("✅ Google 登出成功")}catch(e){throw console.error("❌ Google 登出失敗:",e),e}}static async checkAuthState(){try{return await I.refresh()}catch{return console.log("用戶未登入或 token 已過期"),null}}}function F({onLogin:v,onError:e}){const[r,i]=d.useState(!1),[m,h]=d.useState(!1),[g,p]=d.useState(0),{t:S}=L();d.useEffect(()=>{(async()=>{try{const l=console.error;console.error=(...x)=>{x[0]&&x[0].includes("androidBridge")&&console.log("🔍 檢測到 Bridge 通信錯誤，嘗試重新初始化..."),l.apply(console,x)},await U.initialize(),h(!0),console.log("✅ Google Auth 初始化完成")}catch(l){console.error("❌ Google Auth 初始化失敗:",l),h(!1)}})()},[]);const f=async()=>{if(!m){e("Google 登入服務尚未初始化，請稍後重試");return}i(!0),p(0);try{console.log("🔄 開始 Google 登入流程...");const a=await U.signIn();console.log("✅ Google 登入成功:",a.email),v(a.email,null)}catch(a){console.error("❌ Google 登入失敗:",a);let l="Google 登入失敗，請重試";a.message.includes("Something went wrong")?l="登入服務暫時不可用，請稍後重試":a.message.includes("androidBridge")?l="登入通信錯誤，請重試":a.message.includes("cancelled")?l="登入已取消":a.message.includes("network")&&(l="網路連線問題，請檢查網路後重試"),e(l)}finally{i(!1)}};return s.jsxs("div",{className:"social-login-container",children:[s.jsx("div",{className:"divider",children:s.jsx("span",{children:S("common.or")})}),s.jsx("div",{className:"social-buttons",children:s.jsxs("button",{type:"button",className:"social-btn google-btn",onClick:f,disabled:r||!m,children:[s.jsxs("svg",{className:"google-icon",viewBox:"0 0 24 24",children:[s.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),s.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),s.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),s.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),S(r?"login.processing":"login.google")]})}),!m&&s.jsx("div",{className:"initialization-status",children:s.jsx("small",{children:"正在初始化 Google 登入服務..."})}),g>0&&s.jsx("div",{className:"retry-status",children:s.jsxs("small",{children:["正在重試登入... (",g,"/3)"]})})]})}F.propTypes={onLogin:k.func.isRequired,onError:k.func.isRequired};function oe({onLogin:v}){const[e,r]=d.useState(""),[i,m]=d.useState(""),[h,g]=d.useState(null),[p,S]=d.useState(!1),[f,a]=d.useState(!1),[l,x]=d.useState(!1),[T,D]=d.useState(!1),b=Q(),R=X(),{t,i18n:G}=L(),O=o=>{const c=o.target.validity;c.valueMissing?o.target.setCustomValidity(t("errors.emailRequired")):c.typeMismatch?o.target.setCustomValidity(t("errors.emailInvalid")):o.target.setCustomValidity(t("errors.invalidFormat"))},V=o=>{const c=o.target.validity;c.valueMissing?o.target.setCustomValidity(t("errors.passwordRequired")):c.tooShort?o.target.setCustomValidity(t("errors.passwordTooShort")):o.target.setCustomValidity(t("errors.invalidFormat"))},{height:P,weight:N,age:C}=R.state||{};d.useEffect(()=>{if(console.log("檢查 auth 初始化狀態:",w),!w){g("Firebase 未正確初始化，請檢查配置");return}const o=w.onAuthStateChanged(u=>{u&&(console.log("用戶已登入:",u.email),b("/user-info"))}),c=localStorage.getItem("savedEmail"),n=localStorage.getItem("savedPassword");return c&&n&&(console.log("從 localStorage 恢復帳號:",c),r(c),m(n),x(!0)),()=>o()},[b]);const _=async o=>{o.preventDefault(),g(null),await z()},z=async()=>{var o,c;if(a(!0),console.log("開始處理表單提交，isRegistering:",p,"email:",e),!w||!j){const n="Firebase 未正確初始化，請檢查配置";console.error(n,{auth:w,db:j}),g(n),a(!1);return}if(((c=(o=w.app)==null?void 0:o.options)==null?void 0:c.apiKey)==="demo-api-key"){const n="Firebase 使用 demo 配置，無法進行真實認證。請檢查環境變數配置。";console.error(n),g(n),a(!1);return}try{let n;if(p){console.log("嘗試註冊用戶:",e),n=await Z(w,e,i);const y=n.user;console.log("註冊成功，用戶:",y.email,"UID:",y.uid);const $=M(j,"users",y.uid),E={email:y.email,userId:y.uid,nickname:y.email.split("@")[0],avatarUrl:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),gender:"",height:P?parseFloat(P):0,weight:N?parseFloat(N):0,age:C?parseInt(C,10):0,scores:{strength:0,explosivePower:0,cardio:0,muscleMass:0,bodyFat:0},history:[],testInputs:{},friends:[],friendRequests:[],blockedUsers:[],ladderScore:0,ladderRank:0,ladderHistory:[],isGuest:!1,lastActive:new Date().toISOString()};console.log("儲存初始用戶數據:",E),await A($,E),console.log("用戶數據已儲存，文檔 ID:",y.uid)}else console.log("嘗試登入用戶:",e),n=await ee(w,e,i),console.log("登入成功，用戶:",n.user.email,"UID:",n.user.uid);const u=n.user;console.log("調用 onLogin 回調函數"),v(u.email,i),l?(console.log("儲存帳號到 localStorage:",e),localStorage.setItem("savedEmail",e),localStorage.setItem("savedPassword",i)):(console.log("清除 localStorage 中的帳號"),localStorage.removeItem("savedEmail"),localStorage.removeItem("savedPassword")),setTimeout(()=>{console.log("導航到 /user-info"),b("/user-info")},500)}catch(n){console.error("登入/註冊失敗:",n.code,n.message);let u=n.message;n.code==="auth/user-not-found"?u="找不到此電子郵件帳號，請檢查是否輸入正確或先註冊":n.code==="auth/wrong-password"?u="密碼錯誤，請重新輸入":n.code==="auth/invalid-email"?u="電子郵件格式不正確":n.code==="auth/weak-password"?u="密碼強度不足，請使用至少6個字符":n.code==="auth/email-already-in-use"&&(u="此電子郵件已被使用，請直接登入或使用其他郵箱註冊"),g(u)}finally{a(!1)}},q=()=>{console.log("社交登入成功，導航到 /user-info"),b("/user-info")},W=o=>{g(o)},B=()=>{sessionStorage.setItem("guestMode","true"),b("/user-info")},H=()=>{localStorage.setItem("privacyPolicyViewed","true")};return s.jsxs("div",{className:"login-container",children:[s.jsx("h1",{className:"text-2xl font-bold text-center mb-6",children:t(p?"login.register":"login.login")}),h&&s.jsx("p",{className:"error-message",children:h}),s.jsxs("form",{onSubmit:_,className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.email")}),s.jsx("input",{type:"email",value:e,onChange:o=>r(o.target.value),placeholder:t("login.emailPlaceholder"),className:"input-field",required:!0,onInvalid:O,onInput:o=>o.currentTarget.setCustomValidity(""),disabled:f})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:t("login.password")}),s.jsx("input",{type:"password",value:i,onChange:o=>m(o.target.value),placeholder:t("login.passwordPlaceholder"),className:"input-field",required:!0,minLength:6,onInvalid:V,onInput:o=>o.currentTarget.setCustomValidity(""),disabled:f})]}),s.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"flex-end",marginBottom:"8px"},children:s.jsxs("label",{htmlFor:"rememberMe",style:{display:"flex",alignItems:"center",cursor:"pointer",whiteSpace:"nowrap",fontSize:"14px",color:"#555"},children:[s.jsx("input",{id:"rememberMe",type:"checkbox",checked:l,onChange:o=>x(o.target.checked),disabled:f,style:{margin:0}}),s.jsx("span",{style:{marginLeft:"6px"},children:t("login.rememberMe")})]})}),s.jsx("button",{type:"submit",className:"submit-btn",disabled:f,children:t(f?"common.loading":p?"login.register":"login.login")})]}),s.jsx("button",{onClick:()=>S(!p),className:"toggle-btn",children:t(p?"login.switchToLogin":"login.switchToRegister")}),s.jsx("button",{onClick:B,className:"guest-btn",disabled:f,children:t("login.guestMode")}),s.jsx("div",{className:"privacy-notice",children:G.language&&G.language.toLowerCase().startsWith("zh")?s.jsxs("p",{children:["若繼續操作，即表示你同意最強肉體",s.jsx("a",{className:"privacy-link",href:"/terms",children:"使用條款"}),"。請參閱我們的",s.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"隱私權政策"}),"。"]}):s.jsxs("p",{children:["By continuing, you agree to the Ultimate Physique",s.jsx("a",{className:"privacy-link",href:"/terms",children:"Terms of Service"}),". Please review our",s.jsx("a",{className:"privacy-link",href:"/privacy-policy",children:"Privacy Policy"}),"."]})}),s.jsx(F,{onLogin:q,onError:W}),s.jsxs("div",{className:"instructions-container",children:[s.jsx("h2",{className:"instructions-title",children:t("login.instructions.title")}),s.jsxs("ul",{className:"instructions-list",children:[s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.fair.title")}),"：",t("login.instructions.items.fair.desc")]}),s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.analysis.title")}),"：",t("login.instructions.items.analysis.desc")]}),s.jsxs("li",{children:[s.jsx("strong",{children:t("login.instructions.items.tracking.title")}),"：",t("login.instructions.items.tracking.desc")]})]})]}),s.jsx(se,{isOpen:T,onClose:()=>D(!1),onAccept:H})]})}oe.propTypes={onLogin:k.func.isRequired};export{oe as default};
