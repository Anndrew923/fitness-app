import{u as U,a as L,b as g,_ as R,r as _,s as E,l as I,d as W,j as e,B as A}from"./index-CzQucI3b.js";import{d as O,r}from"./react-vendor-BToktFYo.js";import{D as z,l as F,E as N}from"./firebase-D0136ThQ.js";import{P as T}from"./PrivacyPolicyModal-18oTYGIN.js";import{L as V}from"./LanguageSwitcher-Ddl4jtyl.js";import"./charts-BNGpwEcn.js";function J(){const o=O(),{userData:M,clearUserData:u}=U(),[v,d]=r.useState(!1),[h,x]=r.useState(!1),[y,s]=r.useState(""),{t,i18n:f}=L(),j=f.language&&f.language.toLowerCase().startsWith("zh"),m=(n,c,l)=>{const a=t(n);return a===n?j?c:l:a},p=r.useMemo(()=>!!g.currentUser,[]),b=r.useCallback(()=>{d(!0)},[]),w=r.useCallback(()=>{localStorage.removeItem("privacyAcceptedV1"),d(!0),s(t("settings.msgResetConsent"))},[]),C=r.useCallback(async()=>{try{if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistration();if(n){await n.update(),s(t("settings.msgCheckedUpdate"));return}}s(t("settings.msgNoSW"))}catch{s(t("settings.msgCheckUpdateFail"))}},[]),S=r.useCallback(()=>{try{const n=localStorage.getItem("userData"),c=new Blob([n||"{}"],{type:"application/json"}),l=URL.createObjectURL(c),a=document.createElement("a");a.href=l,a.download="userData.json",a.click(),URL.revokeObjectURL(l)}catch{s(t("settings.msgExportFail"))}},[]),k=r.useCallback(()=>{try{localStorage.removeItem("userData"),localStorage.removeItem("lastSavedUserData"),localStorage.removeItem("ladderSubmissionState"),s(t("settings.msgClearedLocal"))}catch{s(t("settings.msgClearFail"))}},[]),D=r.useCallback(async()=>{var l;if(!p){s(t("settings.msgPleaseLogin")),o("/login");return}if(!window.confirm(t("settings.deleteConfirm")))return;const c=window.prompt(t("settings.passwordPrompt"));if(!c||c.trim()===""){s("");return}try{const a=(l=g.currentUser)==null?void 0:l.email;if(!a)throw new Error(t("settings.msgNeedRelogin"));const{signInWithEmailAndPassword:i}=await R(async()=>{const{signInWithEmailAndPassword:P}=await import("./firebase-D0136ThQ.js").then(B=>B.K);return{signInWithEmailAndPassword:P}},[]);await i(g,a,c)}catch{s(t("settings.msgPasswordVerifyFail")),o("/login");return}x(!0),s(t("settings.msgDeleting"));try{const a=g.currentUser.uid;try{const i=_(E,`avatars/${a}/avatar.jpg`);await I(i)}catch{}try{await z(F(W,"users",a))}catch{}try{await N(g.currentUser)}catch(i){if((i==null?void 0:i.code)==="auth/requires-recent-login"){s(t("settings.msgNeedReloginToDelete")),o("/login");return}throw i}u(),s(t("settings.msgDeleted")),o("/")}catch{s(t("settings.msgDeleteFail"))}finally{x(!1)}},[p,o,u]);return e.jsxs("div",{style:{padding:"16px",paddingBottom:"96px"},children:[e.jsx("h1",{style:{fontSize:"20px",fontWeight:700,marginBottom:"12px"},children:t("settings.title")}),y&&e.jsx("div",{style:{marginBottom:"12px",color:"#2d6a4f"},children:y}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.privacySection")}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:b,children:t("settings.viewPrivacy")}),e.jsx("button",{onClick:w,children:t("settings.resetConsent")}),e.jsx("button",{onClick:S,children:t("settings.exportLocal")}),e.jsx("button",{onClick:k,children:t("settings.clearLocal")})]})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.languageSection")}),e.jsx(V,{})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.pwaSection")}),e.jsx("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:e.jsx("button",{onClick:C,children:t("settings.checkUpdate")})})]}),e.jsxs("section",{style:{marginBottom:"16px"},children:[e.jsx("h2",{style:{fontSize:"16px",marginBottom:"8px"},children:t("settings.dataSection")}),e.jsxs("div",{style:{color:"#555",marginBottom:"8px"},children:[t("settings.loginStatus"),"：",t(p?"common.loggedIn":"common.loggedOut")]}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>o("/privacy-policy"),children:t("settings.toPrivacyPage")}),e.jsx("button",{onClick:()=>o("/terms"),children:m("navigation.terms","使用條款","Terms")}),e.jsx("button",{onClick:()=>o("/about"),children:m("navigation.about","關於","About")}),e.jsx("button",{onClick:()=>o("/disclaimer"),children:m("navigation.disclaimer","免責聲明","Disclaimer")}),e.jsx("button",{onClick:()=>o("/contact"),children:m("navigation.contact","聯絡我們","Contact")}),p&&e.jsx("button",{onClick:D,disabled:h,children:t(h?"common.deleting":"settings.deleteAccountDanger")})]})]}),e.jsx(T,{isOpen:v,onClose:()=>d(!1),onAccept:()=>{localStorage.setItem("privacyAcceptedV1","true"),d(!1),s("")}}),e.jsx(A,{})]})}export{J as default};
