import{u as ve,a as xe,b as x,d as N,j as s,m as D}from"./index-CzQucI3b.js";import{h as ye,d as je,r as g,R as pe}from"./react-vendor-BToktFYo.js";import{l as C,m as ne,t as ae,q as G,w as ie,x as oe,y as ce,H as Ne,D as Fe,z as I}from"./firebase-D0136ThQ.js";import{P as f}from"./charts-BNGpwEcn.js";const ke=()=>{const{userData:m}=ve(),{userId:h}=ye(),$=je(),[b,P]=g.useState([]),{t,i18n:le}=xe(),[de,O]=g.useState(!0),[S,u]=g.useState(""),[W,w]=g.useState(""),[F,q]=g.useState(""),[U,H]=g.useState(!1),[p,me]=g.useState(null),[E,Q]=g.useState(new Set),[T,K]=g.useState(new Set),A=g.useRef(new Map),L=g.useRef(!1),B=g.useCallback(async()=>{var e;try{if(!h){u(t("friendFeed.messages.emptyUserId"));return}console.log("ðŸ”„ é–‹å§‹è¼‰å…¥ç”¨æˆ¶è³‡æ–™:",h),console.log("ðŸ”„ ç•¶å‰ç™»å…¥ç”¨æˆ¶:",(e=x.currentUser)==null?void 0:e.uid);const a=C(N,"users",h);console.log("ðŸ”„ æŸ¥è©¢æ–‡æª”è·¯å¾‘:",a.path);const i=await ne(a);if(i.exists()){const c=i.data();console.log("âœ… ç”¨æˆ¶è³‡æ–™:",c),me({id:i.id,...c}),console.log("âœ… å¥½å‹è³‡æ–™è¼‰å…¥æˆåŠŸ:",c.nickname||c.email)}else console.error("âŒ æ‰¾ä¸åˆ°ç”¨æˆ¶:",h),console.error("âŒ æ–‡æª”è·¯å¾‘:",a.path),u(t("friendFeed.messages.userNotFound"))}catch(a){console.error("è¼‰å…¥å¥½å‹è³‡æ–™å¤±æ•—:",a),console.error("éŒ¯èª¤è©³æƒ…:",{code:a.code,message:a.message,userId:h}),u(t("friendFeed.messages.loadUserFail"))}},[h]),M=g.useCallback(async()=>{try{if(L.current)return;O(!0),console.log("ðŸ”„ é–‹å§‹è¼‰å…¥å¥½å‹å‹•æ…‹...");const e=ae(G(N,"communityPosts"),ie("userId","==",h),oe(50)),a=ae(G(N,"communityPosts"),ie("targetUserId","==",h),oe(50));let i,c;try{i=await ce(e),console.log("âœ… ç”¨æˆ¶å‹•æ…‹æŸ¥è©¢æˆåŠŸ")}catch(n){console.warn("æŸ¥è©¢ç”¨æˆ¶å‹•æ…‹å¤±æ•—ï¼Œä½¿ç”¨ç©ºçµæžœ:",n),i={docs:[]}}try{c=await ce(a),console.log("âœ… ç›®æ¨™ç”¨æˆ¶å‹•æ…‹æŸ¥è©¢æˆåŠŸ")}catch(n){console.warn("æŸ¥è©¢ç›®æ¨™ç”¨æˆ¶å‹•æ…‹å¤±æ•—ï¼Œä½¿ç”¨ç©ºçµæžœ:",n),c={docs:[]}}const l=[];i&&i.docs&&i.docs.forEach(n=>{const r=n.data();r.comments&&r.comments.length>0&&(console.log(`ðŸ” è™•ç†å¥½å‹å‹•æ…‹ ${n.id} çš„ ${r.comments.length} æ¢ç•™è¨€`),r.comments=r.comments.map(v=>v.userAvatarUrl?(console.log(`âœ… å¥½å‹ç•™è¨€ ${v.id} å·²æœ‰é ­åƒ: ${v.userAvatarUrl}`),v):(console.log(`ðŸ“ å¥½å‹ç•™è¨€ ${v.id} ç¼ºå°‘é ­åƒï¼Œä½¿ç”¨é è¨­é ­åƒ`),{...v,userAvatarUrl:"/guest-avatar.svg"}))),(r.privacy||"friends")==="friends"&&l.push({id:n.id,...r})}),c&&c.docs&&c.docs.forEach(n=>{const r=n.data();l.find(o=>o.id===n.id)||(r.comments&&r.comments.length>0&&(console.log(`ðŸ” è™•ç†ç™¼çµ¦å¥½å‹çš„å‹•æ…‹ ${n.id} çš„ ${r.comments.length} æ¢ç•™è¨€`),r.comments=r.comments.map(o=>o.userAvatarUrl?(console.log(`âœ… ç™¼çµ¦å¥½å‹çš„ç•™è¨€ ${o.id} å·²æœ‰é ­åƒ: ${o.userAvatarUrl}`),o):(console.log(`ðŸ“ ç™¼çµ¦å¥½å‹çš„ç•™è¨€ ${o.id} ç¼ºå°‘é ­åƒï¼Œä½¿ç”¨é è¨­é ­åƒ`),{...o,userAvatarUrl:"/guest-avatar.svg"}))),l.push({id:n.id,...r}))}),l.sort((n,r)=>new Date(r.timestamp)-new Date(n.timestamp)),console.log(`ðŸ“Š è¼‰å…¥åˆ° ${l.length} æ¢å‹•æ…‹`);const d=new Set;if(l.forEach(n=>{(n.comments||[]).forEach(r=>{!r.userAvatarUrl&&r.userId&&d.add(r.userId)})}),d.size>0){const n={};await Promise.all(Array.from(d).map(async r=>{try{const o=await ne(C(N,"users",r));if(o.exists()){const v=o.data();n[r]=v.avatarUrl||"/guest-avatar.svg"}else n[r]="/guest-avatar.svg"}catch(o){console.warn(`å–å¾—ç”¨æˆ¶ ${r} é ­åƒå¤±æ•—`,o),n[r]="/guest-avatar.svg"}})),l.forEach(r=>{(r.comments||[]).forEach(o=>{!o.userAvatarUrl&&o.userId===r.userId&&(o.userAvatarUrl=r.userAvatarUrl),!o.userAvatarUrl&&n[o.userId]&&(o.userAvatarUrl=n[o.userId])})})}P([...l]),L.current=!0}catch(e){console.error("âŒ è¼‰å…¥å‹•æ…‹å¤±æ•—:",e),P([])}finally{O(!1)}},[h]),J=async()=>{var e;if(!F.trim()){u(t("community.messages.emptyPost"));return}if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}try{H(!0),console.log("ðŸ“ æº–å‚™ç™¼å¸ƒå‹•æ…‹...");const a={userId:x.currentUser.uid,userNickname:(m==null?void 0:m.nickname)||((e=m==null?void 0:m.email)==null?void 0:e.split("@")[0])||"åŒ¿åç”¨æˆ¶",userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"",content:F.trim(),type:"status",likes:[],comments:[],timestamp:new Date().toISOString(),privacy:"friends",targetUserId:h},i=await Ne(G(N,"communityPosts"),a);D.logWrite("addDoc","communityPosts",i.id),console.log("âœ… å‹•æ…‹ç™¼å¸ƒæˆåŠŸï¼ŒID:",i.id),q(""),w(t("friendFeed.messages.publishSuccess")),await M(),setTimeout(()=>w(""),3e3)}catch(a){console.error("âŒ ç™¼å¸ƒå‹•æ…‹å¤±æ•—:",a),u(`${t("friendFeed.messages.publishFail")}: ${a.message}`)}finally{H(!1)}},V=async(e,a)=>{if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}if(E.has(e)){console.log("ðŸ”„ é»žè®šæ“ä½œé€²è¡Œä¸­ï¼Œè«‹ç¨å€™...");return}try{Q(n=>new Set(n).add(e));const i=x.currentUser.uid,c=a.includes(i),l=c?a.filter(n=>n!==i):[...a,i],d=C(N,"communityPosts",e);await I(d,{likes:l}),D.logWrite("updateDoc","communityPosts",e,{likes:`æ›´æ–°ç‚º ${l.length} å€‹é»žè®š`}),P(n=>n.map(r=>r.id===e?{...r,likes:l}:r)),console.log(`ðŸ‘ ${c?"å–æ¶ˆé»žè®š":"é»žè®š"}æˆåŠŸ`)}catch(i){console.error("âŒ é»žè®šæ“ä½œå¤±æ•—:",i),u(t("friendFeed.messages.actionFail"))}finally{Q(i=>{const c=new Set(i);return c.delete(e),c})}},X=async(e,a)=>{var l;if(!a.trim())return;if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}if(T.has(e)){console.log("ðŸ”„ ç•™è¨€æäº¤ä¸­ï¼Œè«‹ç¨å€™...");return}const i={id:Date.now().toString(),userId:x.currentUser.uid,userNickname:(m==null?void 0:m.nickname)||((l=m==null?void 0:m.email)==null?void 0:l.split("@")[0])||"åŒ¿åç”¨æˆ¶",userAvatarUrl:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"",content:a.trim(),timestamp:new Date().toISOString()};P(d=>d.map(r=>{if(r.id===e){const o=[...r.comments,i];return{...r,comments:o}}return r})),K(d=>new Set(d).add(e)),A.current.has(e)&&clearTimeout(A.current.get(e));const c=setTimeout(async()=>{try{const d=b.find(o=>o.id===e);if(!d){u(t("friendFeed.messages.postNotFound"));return}const n=[...d.comments,i],r=C(N,"communityPosts",e);await I(r,{comments:n}),D.logWrite("updateDoc","communityPosts",e,{comments:`æ–°å¢žç•™è¨€ï¼Œç¸½è¨ˆ ${n.length} æ¢`}),console.log("ðŸ’¬ ç•™è¨€æ·»åŠ æˆåŠŸ")}catch(d){console.error("âŒ æ·»åŠ ç•™è¨€å¤±æ•—:",d),u(t("friendFeed.messages.commentFail")),P(n=>n.map(o=>{if(o.id===e){const v=o.comments.filter(j=>j.id!==i.id);return{...o,comments:v}}return o}))}finally{K(d=>{const n=new Set(d);return n.delete(e),n}),A.current.delete(e)}},500);A.current.set(e,c)},Y=async(e,a)=>{if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}try{const i=b.find(j=>j.id===e);if(!i){u(t("friendFeed.messages.postNotFound"));return}const c=i.comments.find(j=>j.id===a);if(!c){u(t("community.messages.commentNotFound"));return}const l=x.currentUser.uid,d=i.userId===l,n=c.userId===l;if(!d&&!n){u(t("friendFeed.messages.noPermission"));return}const r=t(d?"friendFeed.confirm.deleteComment":"friendFeed.confirm.deleteMyComment");if(!window.confirm(r))return;const o=i.comments.filter(j=>j.id!==a),v=C(N,"communityPosts",e);await I(v,{comments:o}),D.logWrite("updateDoc","communityPosts",e,{comments:`åˆªé™¤ç•™è¨€ï¼Œç¸½è¨ˆ ${o.length} æ¢`}),P(j=>j.map(k=>k.id===e?{...k,comments:o}:k)),w(t("friendFeed.messages.deleteCommentSuccess")),setTimeout(()=>w(""),3e3)}catch(i){console.error("âŒ åˆªé™¤ç•™è¨€å¤±æ•—:",i),u(t("friendFeed.messages.deleteCommentFail"))}},Z=async e=>{if(!x.currentUser){u(t("friendFeed.messages.needLoginShort"));return}try{const a=b.find(l=>l.id===e);if(!a){u(t("friendFeed.messages.postNotFound"));return}const i=x.currentUser.uid;if(a.userId!==i){u(t("friendFeed.messages.noPermission"));return}if(!window.confirm(t("friendFeed.confirm.deletePost")))return;const c=C(N,"communityPosts",e);await Fe(c),D.logWrite("deleteDoc","communityPosts",e,{action:"åˆªé™¤å‹•æ…‹"}),console.log("ðŸ”„ æ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œåˆªé™¤å‹•æ…‹:",e),P(l=>{const d=l.filter(n=>n.id!==e);return console.log(`ðŸ“Š å‰©é¤˜å‹•æ…‹æ•¸: ${d.length}`),d}),w(t("friendFeed.messages.deletePostSuccess")),setTimeout(()=>w(""),3e3)}catch(a){console.error("âŒ åˆªé™¤å‹•æ…‹å¤±æ•—:",a),u(t("friendFeed.messages.deletePostFail"))}},_=g.useCallback(e=>{const a=new Date,i=new Date(e),c=a-i,l=Math.floor(c/(1e3*60)),d=Math.floor(c/(1e3*60*60)),n=Math.floor(c/(1e3*60*60*24));if(l<1)return t("friendFeed.time.justNow");if(l<60)return t("friendFeed.time.minutesAgo",{count:l});if(d<24)return t("friendFeed.time.hoursAgo",{count:d});if(n<7)return t("friendFeed.time.daysAgo",{count:n});try{return new Intl.DateTimeFormat(le.language).format(i)}catch{return i.toLocaleDateString()}},[]),z=pe.memo(({post:e,currentUserId:a,onToggleLike:i,onAddComment:c,onDeleteComment:l,onDeletePost:d,formatTime:n,likeProcessing:r,commentProcessing:o})=>{const[v,j]=g.useState(!1),[R,k]=g.useState(""),ue=e.likes.includes(a),ee=e.likes.length,se=e.comments.length,te=()=>{R.trim()&&(c(e.id,R),k(""))};return s.jsxs("div",{className:"post-card",children:[s.jsxs("div",{className:"post-header",children:[s.jsxs("div",{className:"post-user",children:[s.jsx("img",{src:e.userAvatarUrl||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"user-avatar",loading:"lazy",onError:y=>{y.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"user-info",children:[s.jsxs("div",{className:"user-name",children:[e.userNickname,e.targetUserId&&s.jsxs("span",{className:"to-label",children:[" ","â†’ ",(p==null?void 0:p.nickname)||t("community.friendLabel")]})]}),s.jsx("div",{className:"post-time",children:n(e.timestamp)})]})]}),e.userId===a&&s.jsx("button",{onClick:()=>d(e.id),className:"delete-post-btn",title:t("community.titles.deletePost"),children:"ðŸ—‘ï¸"})]}),s.jsx("div",{className:"post-content",children:e.content}),s.jsxs("div",{className:"post-actions",children:[s.jsxs("button",{onClick:()=>i(e.id,e.likes),className:`action-btn ${ue?"liked":""}`,disabled:r.has(e.id),children:[s.jsx("span",{className:"action-icon",children:r.has(e.id)?"â³":"ðŸ‘"}),s.jsx("span",{className:"action-text",children:r.has(e.id)?t("community.processing"):`${ee>0?ee:""} ${t("community.like")}`})]}),s.jsxs("button",{onClick:()=>j(!v),className:"action-btn",children:[s.jsx("span",{className:"action-icon",children:"ðŸ’¬"}),s.jsxs("span",{className:"action-text",children:[se>0?se:""," ",t("community.comment")]})]})]}),v&&s.jsxs("div",{className:"comments-section",children:[e.comments.length>0&&s.jsx("div",{className:"comments-list",children:e.comments.map(y=>{const re=e.userId===a,ge=y.userId===a,fe=re||ge;return s.jsxs("div",{className:"comment-item",children:[s.jsxs("div",{className:"comment-header",children:[s.jsxs("div",{className:"comment-user-info",children:[s.jsx("img",{src:y.userAvatarUrl||"/guest-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"comment-avatar",loading:"lazy",onError:he=>{he.target.src="/guest-avatar.svg"}}),s.jsxs("div",{className:"comment-text-info",children:[s.jsx("div",{className:"comment-name",children:y.userNickname}),s.jsx("div",{className:"comment-time",children:n(y.timestamp)})]})]}),fe&&s.jsx("button",{onClick:()=>l(e.id,y.id),className:"comment-delete-btn",title:t(re?"community.titles.deleteComment":"community.titles.deleteMyComment"),children:"ðŸ—‘ï¸"})]}),s.jsx("div",{className:"comment-content",children:y.content})]},y.id)})}),s.jsxs("div",{className:"comment-input",children:[s.jsx("input",{type:"text",placeholder:t("friendFeed.ui.inputPlaceholder"),value:R,onChange:y=>k(y.target.value),onKeyPress:y=>{y.key==="Enter"&&te()}}),s.jsx("button",{onClick:te,disabled:!R.trim()||o.has(e.id),className:"comment-btn",children:o.has(e.id)?"ç™¼é€ä¸­...":"ç™¼é€"})]})]})]})});return z.propTypes={post:f.shape({id:f.string.isRequired,userId:f.string.isRequired,userNickname:f.string.isRequired,userAvatarUrl:f.string,content:f.string.isRequired,timestamp:f.any.isRequired,likes:f.array.isRequired,comments:f.array.isRequired}).isRequired,currentUserId:f.string.isRequired,onToggleLike:f.func.isRequired,onAddComment:f.func.isRequired,onDeleteComment:f.func.isRequired,onDeletePost:f.func.isRequired,formatTime:f.func.isRequired,likeProcessing:f.instanceOf(Set).isRequired,commentProcessing:f.instanceOf(Set).isRequired},g.useEffect(()=>{if(!x.currentUser){console.error("âŒ ç”¨æˆ¶æœªç™»å…¥"),u("è«‹å…ˆç™»å…¥");return}return console.log("ðŸ”„ é–‹å§‹è¼‰å…¥å¥½å‹é é¢æ•¸æ“š..."),console.log("ðŸ”„ ç›®æ¨™ç”¨æˆ¶ID:",h),L.current=!1,B(),M(),()=>{const e=A.current;e&&(e.forEach(a=>clearTimeout(a)),e.clear())}},[B,M,h]),de?s.jsx("div",{className:"friend-feed-page",children:s.jsx("div",{className:"loading",children:t("friendFeed.ui.loading")})}):S&&!x.currentUser?s.jsxs("div",{className:"friend-feed-page",children:[s.jsxs("div",{className:"error-message",children:[s.jsx("p",{children:t("friendFeed.messages.needLogin")}),s.jsx("button",{onClick:()=>$("/login"),className:"login-btn",children:t("community.goLogin")})]}),s.jsx("button",{onClick:()=>$("/community"),className:"back-btn",children:t("community.back")})]}):S&&!p?s.jsxs("div",{className:"friend-feed-page",children:[s.jsxs("div",{className:"friend-feed-header",children:[s.jsxs("button",{onClick:()=>$("/community"),className:"back-btn",children:["â† ",t("community.back")]}),s.jsxs("div",{className:"friend-info",children:[s.jsx("img",{src:"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}}),s.jsxs("div",{className:"friend-details",children:[s.jsx("h1",{children:t("friendFeed.ui.pageTitle",{id:h==null?void 0:h.substring(0,8)})}),s.jsx("p",{children:t("friendFeed.messages.loadUserFail")})]})]})]}),s.jsxs("div",{className:"alert alert-error",children:[s.jsx("p",{children:S}),s.jsx("p",{children:t("friendFeed.messages.loadUserFail")})]}),s.jsx("div",{className:"post-composer",children:s.jsxs("div",{className:"composer-header",children:[s.jsx("div",{className:"user-avatar",children:s.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}})}),s.jsxs("div",{className:"composer-input",children:[s.jsx("textarea",{placeholder:t("friendFeed.ui.inputPlaceholder"),value:F,onChange:e=>q(e.target.value),maxLength:500,disabled:U}),s.jsxs("div",{className:"composer-footer",children:[s.jsxs("span",{className:"char-count",children:[F.length,"/500"]}),s.jsx("button",{onClick:J,disabled:!F.trim()||U,className:"publish-btn",children:t(U?"community.publishing":"community.publish")})]})]})]})}),s.jsx("div",{className:"posts-container",children:b.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.emptyFeed.title")}),s.jsx("p",{children:t("community.emptyFeed.subtitle")})]}):b.map(e=>{var a;return s.jsx(z,{post:e,currentUserId:(a=x.currentUser)==null?void 0:a.uid,onToggleLike:V,onAddComment:X,onDeleteComment:Y,onDeletePost:Z,formatTime:_,likeProcessing:E,commentProcessing:T},e.id)})})]}):s.jsxs("div",{className:"friend-feed-page",children:[s.jsxs("div",{className:"friend-feed-header",children:[s.jsxs("button",{onClick:()=>$("/community"),className:"back-btn",children:["â† ",t("community.back")]}),s.jsxs("div",{className:"friend-info",children:[s.jsx("img",{src:(p==null?void 0:p.avatarUrl)||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),className:"friend-avatar",loading:"lazy",onError:e=>{e.target.src="/default-avatar.png"}}),s.jsxs("div",{className:"friend-details",children:[s.jsx("h1",{children:t("friendFeed.ui.pageTitle",{id:(p==null?void 0:p.nickname)||t("community.fallback.user")})}),s.jsx("p",{children:t("friendFeed.ui.inputPlaceholder")})]})]})]}),S&&s.jsx("div",{className:"alert alert-error",children:S}),W&&s.jsx("div",{className:"alert alert-success",children:W}),s.jsx("div",{className:"post-composer",children:s.jsxs("div",{className:"composer-header",children:[s.jsx("div",{className:"user-avatar",children:s.jsx("img",{src:sessionStorage.getItem("guestMode")==="true"?"/guest-avatar.svg":(m==null?void 0:m.avatarUrl)||"/default-avatar.svg",alt:t("friendFeed.ui.avatarAlt"),loading:"lazy",onError:e=>{e.target.src="/default-avatar.svg"}})}),s.jsxs("div",{className:"composer-input",children:[s.jsx("textarea",{placeholder:t("friendFeed.ui.inputPlaceholder"),value:F,onChange:e=>q(e.target.value),maxLength:500,disabled:U}),s.jsxs("div",{className:"composer-footer",children:[s.jsxs("span",{className:"char-count",children:[F.length,"/500"]}),s.jsx("button",{onClick:J,disabled:!F.trim()||U,className:"publish-btn",children:t(U?"community.publishing":"community.publish")})]})]})]})}),s.jsx("div",{className:"posts-container",children:b.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("p",{children:t("community.emptyFeed.title")}),s.jsx("p",{children:t("community.emptyFeed.subtitle")})]}):b.map(e=>{var a;return s.jsx(z,{post:e,currentUserId:(a=x.currentUser)==null?void 0:a.uid,onToggleLike:V,onAddComment:X,onDeleteComment:Y,onDeletePost:Z,formatTime:_,likeProcessing:E,commentProcessing:T},e.id)})})]})};export{ke as default};
