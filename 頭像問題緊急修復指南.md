# 🚨 頭像載入失敗緊急修復指南

## 問題現狀

- 控制台顯示大量 412 (Precondition Failed) 錯誤
- 所有用戶頭像無法正常顯示
- Firebase Storage 存取被拒絕

## 🔥 立即修復步驟

### 第一步：更新 Firebase Storage 安全規則

1. 前往 [Firebase Console](https://console.firebase.google.com/)
2. 選擇你的項目
3. 點擊左側選單 **Storage**
4. 點擊 **Rules** 標籤
5. **複製以下臨時規則並貼上**：

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

6. 點擊 **發布（Publish）**
7. **等待 1-2 分鐘**讓規則生效

### 第二步：清除緩存並測試

1. 在瀏覽器中按 `Ctrl+Shift+Delete`（Windows）或 `Cmd+Shift+Delete`（Mac）
2. 清除過去 1 小時的緩存
3. 重新載入頁面
4. 測試頭像功能

### 第三步：使用調試工具

如果問題持續，在瀏覽器控制台執行：

```javascript
firebaseDebug.fullDiagnosis();
```

## 🔍 診斷檢查清單

### ✅ Firebase Console 檢查

- [ ] Storage 規則已更新
- [ ] 等待規則生效（1-2 分鐘）
- [ ] Storage 服務已啟用
- [ ] Project ID 正確

### ✅ 瀏覽器檢查

- [ ] 清除緩存
- [ ] 重新載入頁面
- [ ] 檢查控制台錯誤
- [ ] 確認網路連接

### ✅ 用戶認證檢查

- [ ] 用戶已正確登入
- [ ] 認證 token 未過期
- [ ] Firebase Auth 服務正常

## 🛠️ 如果問題持續

### 方法 1：檢查 Storage Bucket

1. 在 Firebase Console > Storage 中確認：
   - Storage bucket 名稱正確
   - 服務已啟用
   - 區域設置正確

### 方法 2：檢查網路設置

1. 確認網路能正常訪問 `firebasestorage.googleapis.com`
2. 檢查是否有防火牆或代理阻擋

### 方法 3：重新上傳頭像

1. 嘗試重新上傳一張新的頭像
2. 檢查上傳過程是否有錯誤
3. 觀察控制台的調試信息

## 📋 成功指標

修復成功後你應該看到：

- ✅ 控制台不再有 412 錯誤
- ✅ 用戶頭像正常顯示
- ✅ 頭像上傳功能正常
- ✅ 其他用戶的頭像也能看到

## 🔒 安全性說明

⚠️ **重要**：上面的臨時規則比較寬鬆，適合測試使用。

測試成功後，請使用以下更安全的規則：

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /avatars/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow get: if request.auth != null;
    }
  }
}
```

## 🆘 緊急聯繫

如果以上步驟都無法解決問題：

1. 截圖控制台的完整錯誤信息
2. 截圖 Firebase Console 的 Storage Rules 頁面
3. 提供項目的 Firebase Project ID
4. 說明具體的操作步驟和錯誤現象

## 🔧 調試命令

在瀏覽器控制台可以使用的調試命令：

```javascript
// 檢查認證狀態
firebaseDebug.checkAuth();

// 檢查 Storage 連接
firebaseDebug.checkStorage();

// 測試特定頭像 URL
firebaseDebug.testAvatarUrl('你的頭像URL');

// 完整診斷
firebaseDebug.fullDiagnosis();
```
