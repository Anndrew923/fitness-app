# 天梯顯示問題修復

## 🐛 問題描述

用戶報告了兩個天梯頁面的顯示問題：

1. **第三名位置變成空的問題**：當用戶排名第三名時，用戶信息跑到浮動位置，導致第三名位置顯示為空
2. **浮動排名框與列表項目交錯的 bug**：當用戶排名第十名時，浮動排名框與第十名列表項目產生交錯顯示

## 🔧 修復方案

### 1. **浮動排名框顯示邏輯優化**

**問題原因**：

- 浮動排名框的顯示條件不夠嚴格
- 沒有正確檢查用戶是否已經在天梯列表中顯示
- 前幾名用戶不應該顯示浮動框

**修復內容**：

```javascript
const getFloatingRankDisplay = () => {
  if (!userData || !userData.ladderScore || userData.ladderScore === 0) {
    return null;
  }

  // 檢查用戶是否已經在天梯列表中顯示
  const isUserInList = ladderData.some(user => user.id === userData?.userId);

  // 如果用戶已經在列表中顯示，不顯示浮動框
  if (isUserInList) {
    return null;
  }

  // 如果用戶排名在前10名內，也不顯示浮動框（因為應該在列表中）
  if (userRank > 0 && userRank <= 10) {
    return null;
  }

  // 如果用戶排名為0或未上榜，不顯示浮動框
  if (userRank === 0) {
    return null;
  }

  // 只有在用戶不在列表中且排名超過10名時才顯示浮動框
  return (
    <div className="floating-rank-display" data-rank={userRank}>
      {/* 浮動排名框內容 */}
    </div>
  );
};
```

### 2. **天梯列表排名顯示修復**

**問題原因**：

- 列表中的排名顯示邏輯有誤
- 當前用戶的排名顯示使用了 `userRank` 而不是 `index + 1`

**修復內容**：

```javascript
// 修復前
<span className="ladder__rank-number">
  {user.id === userData?.userId ? userRank : index + 1}
</span>

// 修復後
<span className="ladder__rank-number">
  {index + 1}
</span>
```

### 3. **數據載入邏輯優化**

**問題原因**：

- 查詢限制可能導致用戶不在顯示範圍內
- 需要確保用戶能正確顯示在列表中

**修復內容**：

```javascript
// 計算查詢限制：確保能顯示到用戶排名
let limitCount = 50; // 默認顯示50名
if (userData && userData.ladderRank > 0) {
  // 如果用戶有排名，確保能顯示到用戶排名
  const userRank = userData.ladderRank;
  limitCount = Math.max(50, userRank + 10); // 顯示到用戶排名後10名
  console.log(
    `🎯 確保顯示用戶排名：用戶排名=${userRank}, 查詢限制=${limitCount}`
  );
}
```

## 📊 修復效果

### 1. **第三名問題修復**

- ✅ 第三名用戶正確顯示在天梯列表中
- ✅ 不會跑到浮動位置
- ✅ 第三名位置不再為空

### 2. **浮動排名框交錯問題修復**

- ✅ 前 10 名用戶不會顯示浮動排名框
- ✅ 浮動排名框只在適當時候顯示
- ✅ 避免與列表項目產生交錯

### 3. **顯示邏輯優化**

- ✅ 用戶在列表中時不顯示浮動框
- ✅ 用戶排名為 0 時不顯示浮動框
- ✅ 前 10 名用戶不顯示浮動框
- ✅ 只有排名超過 10 名且不在列表中的用戶才顯示浮動框

## 🎯 顯示規則

### 浮動排名框顯示條件：

1. 用戶必須有有效的天梯分數
2. 用戶不能已經在天梯列表中顯示
3. 用戶排名不能為 0（未上榜）
4. 用戶排名必須超過 10 名

### 天梯列表顯示規則：

1. 按分數降序排列
2. 顯示前 N 名用戶（N 根據用戶排名動態調整）
3. 列表中的排名按實際位置顯示（index + 1）
4. 當前用戶在列表中有特殊高亮顯示

## 🔍 測試建議

### 1. **第三名測試**

1. 確保用戶排名第三名時正確顯示在列表中
2. 確認第三名位置不為空
3. 確認不會顯示浮動排名框

### 2. **第十名測試**

1. 確保用戶排名第十名時正確顯示在列表中
2. 確認不會顯示浮動排名框
3. 確認沒有交錯顯示問題

### 3. **浮動排名框測試**

1. 測試排名超過 10 名且不在列表中的用戶
2. 確認浮動排名框正確顯示
3. 確認浮動排名框位置正確

### 4. **邊界情況測試**

1. 測試排名為 0 的用戶
2. 測試沒有分數的用戶
3. 測試匿名用戶
4. 測試列表為空的情況

## 🚀 預期效果

### 1. **視覺改進**

- 天梯列表顯示更清晰
- 沒有空位置問題
- 浮動排名框使用更合理

### 2. **功能完整性**

- 所有排名都能正確顯示
- 用戶位置準確
- 沒有顯示衝突

### 3. **用戶體驗**

- 界面更直觀
- 信息顯示更準確
- 操作更流暢

## 📝 技術細節

### 1. **顯示邏輯流程**

```
用戶訪問天梯頁面
↓
載入天梯數據
↓
計算用戶排名
↓
檢查用戶是否在列表中
↓
決定是否顯示浮動排名框
↓
渲染天梯列表和浮動框
```

### 2. **關鍵函數**

```javascript
// 浮動排名框顯示邏輯
getFloatingRankDisplay();

// 天梯數據載入
loadLadderData();

// 排名計算
calculateUserRank();
```

### 3. **狀態管理**

```javascript
const [ladderData, setLadderData] = useState([]);
const [userRank, setUserRank] = useState(0);
const [loading, setLoading] = useState(true);
```

## 🔧 維護建議

### 1. **代碼維護**

- 定期檢查浮動排名框顯示邏輯
- 確保排名計算準確性
- 優化數據載入性能

### 2. **用戶反饋**

- 收集用戶對顯示效果的意見
- 根據反饋調整顯示規則
- 持續改進用戶體驗

### 3. **性能優化**

- 監控數據載入時間
- 優化查詢限制計算
- 減少不必要的重新渲染
