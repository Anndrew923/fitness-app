# 晉升動畫調試指南

## 🔍 問題診斷

### 當前問題

用戶反映：將心肺分數調低後排名變成第三，再把分數調高變成第一名時，沒有觸發動畫。

### 已修復的問題

#### 1. **排名計算錯誤**

- **問題**：排名計算邏輯錯誤，使用 `user.ladderScore > userData.ladderScore` 而不是 `user.id === userData.userId`
- **修復**：更正為正確的用戶 ID 匹配

#### 2. **晉升訊息位置錯誤**

- **問題**：CSS 中晉升訊息位置設置為 `top: 20px` 而不是居中
- **修復**：改為 `top: 50%` 並使用 `transform: translate(-50%, -50%)`

#### 3. **動畫觸發條件**

- **問題**：排名變化檢測邏輯可能不正確
- **修復**：添加更多調試日誌和條件檢查

## 🛠️ 調試工具

### 開發環境調試按鈕

#### 🐛 調試按鈕

- 顯示當前狀態信息
- 輸出到控制台：userData, userRank, previousUserData, promotionAnimation

#### 🎬 測試動畫按鈕

- 手動觸發動畫測試
- 模擬從第 3 名提升到第 1 名
- 測試完整的動畫序列

### 控制台日誌

#### 排名變化檢測

```
🔍 排名變化檢測：從第 X 名到第 Y 名
```

#### 動畫觸發檢測

```
🔍 動畫檢測：oldRank=X, newRank=Y
🎉 排名提升：從第 X 名提升到第 Y 名
```

#### 動畫樣式應用

```
🎨 動畫樣式：user=用戶名, isCurrentUser=true/false, currentRank=X, progress=Y
```

## 🔧 調試步驟

### 1. 檢查排名變化

1. 打開瀏覽器控制台
2. 修改評測分數
3. 觀察控制台輸出：
   - 是否有「排名變化檢測」日誌
   - 是否有「動畫檢測」日誌
   - 是否有「排名提升」日誌

### 2. 檢查動畫狀態

1. 點擊「🐛 調試」按鈕
2. 查看控制台輸出的狀態信息
3. 確認 `promotionAnimation.isActive` 是否為 `true`

### 3. 測試動畫效果

1. 點擊「🎬 測試動畫」按鈕
2. 觀察是否有動畫效果
3. 檢查晉升訊息是否出現

### 4. 檢查動畫樣式

1. 在控制台查看「動畫樣式」日誌
2. 確認 `isCurrentUser` 是否正確
3. 確認 `progress` 是否在變化

## 🎯 預期行為

### 正常流程

1. **分數變化** → 觸發 `loadLadderData()`
2. **排名計算** → 更新 `userRank`
3. **排名變化檢測** → 保存舊排名到 `previousUserData`
4. **動畫觸發** → 設置 `promotionAnimation.isActive = true`
5. **動畫播放** → 進度從 0 到 1
6. **粒子效果** → 觸發粒子爆炸
7. **動畫完成** → 重置狀態

### 動畫效果

- **晉升用戶**：浮起 35px、放大 1.12 倍、發光
- **擠開效果**：其他用戶向上移動 60px、變暗
- **粒子爆炸**：16 個粒子向四周爆炸
- **晉升訊息**：中央彈出顯示提升位數

## 🚨 常見問題

### 1. 沒有排名變化日誌

- **原因**：`oldRank` 或 `newRank` 為 0
- **解決**：檢查用戶是否完成全部 5 個評測項目

### 2. 有排名變化但沒有動畫

- **原因**：`promotionAnimation.isActive` 已經是 `true`
- **解決**：等待當前動畫完成

### 3. 動畫樣式沒有應用

- **原因**：`isCurrentUser` 判斷錯誤
- **解決**：檢查 `user.id === userData?.userId`

### 4. 晉升訊息沒有顯示

- **原因**：CSS 樣式問題
- **解決**：檢查 `.promotion-message` 樣式

## 📝 調試檢查清單

- [ ] 用戶完成全部 5 個評測項目
- [ ] 天梯分數 > 0
- [ ] 排名有實際變化（數字變小）
- [ ] 控制台有排名變化日誌
- [ ] 控制台有動畫觸發日誌
- [ ] `promotionAnimation.isActive` 變為 `true`
- [ ] 動畫樣式正確應用
- [ ] 晉升訊息正確顯示
- [ ] 粒子效果正常播放

## 🔄 下一步調試

如果問題仍然存在，請：

1. **提供控制台日誌**：複製所有相關的日誌輸出
2. **描述具體步驟**：詳細說明如何重現問題
3. **檢查網絡請求**：確認數據是否正確保存和讀取
4. **測試其他場景**：嘗試不同的排名變化情況
