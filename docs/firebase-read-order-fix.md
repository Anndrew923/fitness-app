# Firebase è®€å–é †åºä¿®å¾©

## ğŸš¨ å•é¡Œæè¿°

ç”¨æˆ¶åæ˜ å³ä½¿ä¿®å¾©äº† `oldRank` ä¿å­˜é‚è¼¯ï¼Œå•é¡Œä»ç„¶å­˜åœ¨ã€‚æ§åˆ¶å°ä»ç„¶é¡¯ç¤ºï¼š

```
ğŸ” æ’åè®ŠåŒ–æª¢æ¸¬ï¼šå¾ç¬¬ 0 ååˆ°ç¬¬ 1 å
ğŸ¯ æª¢æ¸¬åˆ°æ’åæå‡ï¼šå¾ç¬¬ 0 ååˆ°ç¬¬ 1 å
è¨­ç½®é¡¯ç¤ºæ’åç‚ºèˆŠæ’åï¼š0
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### Firebase æ•¸æ“šè®€å–é †åºå•é¡Œ

å•é¡Œå‡ºåœ¨ Firebase æ•¸æ“šè®€å–å’Œç‹€æ…‹æ›´æ–°çš„æ™‚åºä¸Šï¼š

1. **UserContext è¼‰å…¥ç”¨æˆ¶æ•¸æ“š** â†’ æ›´æ–° `userData`
2. **Ladder çµ„ä»¶åˆå§‹åŒ–** â†’ `userRank = 0`ï¼ˆå› ç‚ºé‚„æ²’æœ‰è¼‰å…¥å¤©æ¢¯æ•¸æ“šï¼‰
3. **useEffect è§¸ç™¼** â†’ æª¢æŸ¥ `userRank > 0`ï¼Œä½†æ­¤æ™‚ `userRank` é‚„æ˜¯ 0
4. **loadLadderData åŸ·è¡Œ** â†’ è¨ˆç®—å‡ºæ­£ç¢ºçš„æ’åï¼Œä½† `previousUserData` å·²ç¶“è¢«è¨­ç½®ç‚º 0

### é—œéµå•é¡Œ

- `useEffect` ä¾è³´ `userRank`ï¼Œä½† `userRank` çš„æ›´æ–°æ˜¯åœ¨ `loadLadderData` ä¸­é€²è¡Œçš„
- é€™é€ æˆäº†æ™‚åºå•é¡Œï¼šæ’åè¨ˆç®—å®Œæˆå‰ï¼Œ`previousUserData` å°±å·²ç¶“è¢«åˆå§‹åŒ–ç‚º 0

## ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆ

### 1. **æ–°å¢é ä¿å­˜æ©Ÿåˆ¶**

åœ¨ `userData` è®ŠåŒ–æ™‚å°±é å…ˆä¿å­˜ç”¨æˆ¶æ•¸æ“šï¼Œé¿å…ç­‰å¾…æ’åè¨ˆç®—ï¼š

```javascript
// æ–°å¢ï¼šåœ¨ userData è®ŠåŒ–æ™‚ä¿å­˜èˆŠæ’åï¼Œé¿å… Firebase è®€å–é †åºå•é¡Œ
useEffect(() => {
  if (userData && userData.ladderScore > 0 && !previousUserData) {
    // å¦‚æœé€™æ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ä¸”æœ‰åˆ†æ•¸ï¼Œå…ˆä¿å­˜ç”¨æˆ¶æ•¸æ“šï¼Œç­‰å¾…æ’åè¨ˆç®—
    console.log(
      `ğŸ“Š é ä¿å­˜ç”¨æˆ¶æ•¸æ“šï¼Œç­‰å¾…æ’åè¨ˆç®—ï¼šladderScore=${userData.ladderScore}`
    );
    setPreviousUserData({
      ...userData,
      currentRank: null, // å…ˆè¨­ç‚º nullï¼Œç­‰å¾… loadLadderData è¨ˆç®—
    });
  }
}, [userData?.ladderScore]); // åªç›£è½ ladderScore è®ŠåŒ–
```

### 2. **ä¿®æ”¹æ’åè¨ˆç®—é‚è¼¯**

åœ¨ `loadLadderData` ä¸­è™•ç†é¦–æ¬¡æ’åè¨ˆç®—ï¼š

```javascript
// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¨ˆç®—æ’åï¼Œä¿å­˜ç•¶å‰æ’å
if (previousUserData && previousUserData.currentRank === null) {
  console.log(`ğŸ¯ é¦–æ¬¡è¨ˆç®—æ’åï¼š${newRank}`);
  setPreviousUserData(prev => ({
    ...prev,
    currentRank: newRank,
  }));
}

// ä¿å­˜èˆŠæ’ååˆ°ç”¨æˆ¶æ•¸æ“šä¸­ï¼Œç”¨æ–¼å‹•ç•«æª¢æ¸¬
if (userData && oldRank !== newRank && oldRank !== null) {
  console.log(`ğŸ” æ’åè®ŠåŒ–æª¢æ¸¬ï¼šå¾ç¬¬ ${oldRank} ååˆ°ç¬¬ ${newRank} å`);
  // ... å‹•ç•«é‚è¼¯
}
```

### 3. **ä¿®æ”¹å‹•ç•«è§¸ç™¼æ¢ä»¶**

åªåœ¨ `currentRank` ä¸ç‚º `null` æ™‚æ‰æª¢æŸ¥æ’åè®ŠåŒ–ï¼š

```javascript
} else if (userData && previousUserData && previousUserData.currentRank !== null) {
  // æª¢æŸ¥æ˜¯å¦æœ‰æ’åè®ŠåŒ–ï¼ˆåªæœ‰åœ¨ currentRank ä¸ç‚º null æ™‚æ‰æª¢æŸ¥ï¼‰
  const oldRank = previousUserData.currentRank || 0;
  const newRank = userRank || 0;
  // ... å‹•ç•«é‚è¼¯
}
```

## ğŸ¯ ä¿®å¾©æµç¨‹

### éšæ®µ 1ï¼šç”¨æˆ¶æ•¸æ“šè¼‰å…¥

1. UserContext å¾ Firebase è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
2. `userData.ladderScore` è®ŠåŒ–è§¸ç™¼é ä¿å­˜
3. è¨­ç½® `previousUserData.currentRank = null`

### éšæ®µ 2ï¼šæ’åè¨ˆç®—

1. `loadLadderData` åŸ·è¡Œï¼Œè¨ˆç®—å‡ºæ­£ç¢ºæ’å
2. æª¢æ¸¬åˆ° `currentRank === null`ï¼Œè¨­ç½®ç‚ºè¨ˆç®—å‡ºçš„æ’å
3. ä¸æœƒè§¸ç™¼å‹•ç•«ï¼ˆå› ç‚ºæ˜¯é¦–æ¬¡è¨ˆç®—ï¼‰

### éšæ®µ 3ï¼šæ•¸æ“šæ›´æ–°

1. ç”¨æˆ¶æ›´æ–°åˆ†æ•¸ï¼Œè§¸ç™¼é‡æ–°è¨ˆç®—
2. `oldRank` æ˜¯æ­£ç¢ºçš„èˆŠæ’å
3. è§¸ç™¼å¾èˆŠæ’ååˆ°æ–°æ’åçš„å‹•ç•«

## ğŸ“Š é æœŸæ•ˆæœ

### ä¿®å¾©å¾Œçš„æ—¥èªŒ

```
ğŸ“Š é ä¿å­˜ç”¨æˆ¶æ•¸æ“šï¼Œç­‰å¾…æ’åè¨ˆç®—ï¼šladderScore=85.2
ğŸ¯ é¦–æ¬¡è¨ˆç®—æ’åï¼š3
ğŸ” æ’åè®ŠåŒ–æª¢æ¸¬ï¼šå¾ç¬¬ 3 ååˆ°ç¬¬ 1 å
ğŸ¯ æª¢æ¸¬åˆ°æ’åæå‡ï¼šå¾ç¬¬ 3 ååˆ°ç¬¬ 1 å
è¨­ç½®é¡¯ç¤ºæ’åç‚ºèˆŠæ’åï¼š3
```

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### é—œéµä¿®å¾©é»

1. **é ä¿å­˜æ©Ÿåˆ¶**ï¼šåœ¨æ’åè¨ˆç®—å‰å°±ä¿å­˜ç”¨æˆ¶æ•¸æ“š
2. **null æ¨™è¨˜**ï¼šä½¿ç”¨ `null` æ¨™è¨˜é¦–æ¬¡è¨ˆç®—ç‹€æ…‹
3. **æ¢ä»¶æª¢æŸ¥**ï¼šåªåœ¨éé¦–æ¬¡è¨ˆç®—æ™‚è§¸ç™¼å‹•ç•«
4. **æ™‚åºæ§åˆ¶**ï¼šé¿å… Firebase è®€å–é †åºå°è‡´çš„å•é¡Œ

### ç‹€æ…‹ç®¡ç†æµç¨‹

```javascript
// 1. ç”¨æˆ¶æ•¸æ“šè¼‰å…¥
userData.ladderScore = 85.2
â†’ è¨­ç½® previousUserData.currentRank = null

// 2. æ’åè¨ˆç®—
loadLadderData() è¨ˆç®—å‡ºæ’å = 3
â†’ è¨­ç½® previousUserData.currentRank = 3

// 3. æ•¸æ“šæ›´æ–°
ç”¨æˆ¶æ›´æ–°åˆ†æ•¸ï¼Œæ–°æ’å = 1
â†’ oldRank = 3, newRank = 1
â†’ è§¸ç™¼å‹•ç•«
```

## ğŸš€ å„ªå‹¢

1. **è§£æ±ºæ™‚åºå•é¡Œ**ï¼šé¿å… Firebase è®€å–é †åºå°è‡´çš„åˆå§‹åŒ–å•é¡Œ
2. **é¿å…èª¤è§¸ç™¼**ï¼šé¦–æ¬¡è¼‰å…¥ä¸æœƒè§¸ç™¼å‹•ç•«
3. **æ­£ç¢ºä¿å­˜**ï¼šç¢ºä¿èˆŠæ’åè¢«æ­£ç¢ºä¿å­˜
4. **ç©©å®šå¯é **ï¼šä¸ä¾è³´æ–¼ç‰¹å®šçš„åŸ·è¡Œé †åº
